<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–¥–∏–∞ -->
		<div class="media-send-overlay hidden" id="media-send-overlay"></div>
		<div class="media-send-modal hidden" id="media-send-modal">
			<div class="media-send-title" id="media-send-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞</div>

			<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤ -->
			<div class="media-preview-grid" id="media-preview-grid">
				<!-- –ü—Ä–µ–≤—å—é –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
			</div>

			<input
				type="text"
				class="media-caption-input"
				id="media-caption-input"
				placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"
			/>

			<div class="media-send-buttons">
				<button class="media-send-button add" id="media-add-button">
					–î–æ–±–∞–≤–∏—Ç—å
				</button>
				<button class="media-send-button cancel" id="media-cancel-button">
					–û—Ç–º–µ–Ω–∞
				</button>
				<button class="media-send-button send" id="media-send-button">
					–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ
				</button>
			</div>
		</div>

		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
		<div class="image-modal-overlay hidden" id="image-modal-overlay">
			<div class="image-modal-content">
				<button class="image-modal-close" id="image-modal-close">√ó</button>
				<img
					src=""
					alt="Full screen image"
					class="image-modal-img"
					id="image-modal-img"
				/>
			</div>
		</div>

		<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ -->
		<input
			type="file"
			id="file-input"
			class="file-input"
			accept="image/*,video/*"
			onchange="handleFileSelect(event)"
		/>

		<div class="top-container">
			<div class="top-row">
				<div class="menu-icon">‚ò∞</div>
				<div class="avatar-small" id="top-avatar"></div>
				<div class="search-container">
					<input type="text" class="search-input" placeholder="–ø–æ–∏—Å–∫" />
					<span class="clear-btn">√ó</span>
				</div>
			</div>

			<div class="user-container" id="user-container"></div>
		</div>

		<div class="right-container">
			<div class="default-content" id="default-content">
				<img
					src="https://cdn-icons-png.flaticon.com/512/5757/5757765.png"
					alt="–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç"
					class="default-image"
				/>
			</div>

			<div class="chat-container hidden" id="chat-container">
				<div class="chat-header">
					<div class="chat-username" id="chat-username"></div>
					<div class="chat-header-info">
						<div class="chat-status" id="chat-status"></div>
					</div>
				</div>
				<div class="chat-scroll-container">
					<div class="chat-messages-wrapper" id="chat-messages-wrapper">
						<div class="chat-messages" id="chat-messages">
							<!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–∞—Ç –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
						</div>
					</div>
					<div class="custom-scrollbar" id="custom-scrollbar">
						<div
							class="custom-scrollbar-thumb"
							id="custom-scrollbar-thumb"
						></div>
					</div>
				</div>
				<div class="message-input-container">
					<div class="reply-container hidden" id="reply-container"></div>
					<div class="input-row">
						<button class="photo-message-btn" id="photo-message-btn">
							<img
								src="https://cdn-icons-png.flaticon.com/512/266/266074.png"
								alt="–§–æ—Ç–æ"
							/>
						</button>
						<div class="message-input-wrapper">
							<input
								type="text"
								class="message-input"
								placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
								id="message-input"
							/>
							<div class="recording-container hidden" id="recording-container">
								–ó–∞–ø–∏—Å—å: <span id="recording-time">0</span> —Å–µ–∫.
							</div>
						</div>
						<button class="voice-message-btn" id="voice-message-btn">
							<img
								src="https://images.icon-icons.com/2066/PNG/512/mic_icon_125214.png"
								alt="–ó–∞–ø–∏—Å—å"
							/>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –º–µ–Ω—é –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–æ—Ç–æ -->
		<div class="photo-options-menu hidden" id="photo-options-menu">
			<button class="photo-option" data-type="photo-video">
				<img
					src="https://cdn-icons-png.flaticon.com/512/266/266074.png"
					alt="–§–æ—Ç–æ/–í–∏–¥–µ–æ"
				/>
				<span>–§–æ—Ç–æ –∏ –≤–∏–¥–µ–æ</span>
			</button>
			<button class="photo-option" data-type="documents">
				<img
					src="https://cdn-icons-png.flaticon.com/512/2991/2991112.png"
					alt="–î–æ–∫—É–º–µ–Ω—Ç—ã"
				/>
				<span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
			</button>
			<button class="photo-option" data-type="poll">
				<img
					src="https://cdn-icons-png.flaticon.com/512/3034/3034626.png"
					alt="–û–ø—Ä–æ—Å"
				/>
				<span>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</span>
			</button>
			<button class="photo-option" data-type="location">
				<img
					src="https://cdn-icons-png.flaticon.com/512/535/535137.png"
					alt="–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è"
				/>
				<span>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</span>
			</button>
		</div>

		<!-- Add this to your HTML -->
		<div class="video-message-container hidden" id="video-loading-overlay">
			<div class="video-loading-content">
				<div class="video-loading-spinner"></div>
				<div class="video-loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>
				<div class="video-loading-progress">0 MB / 0 MB</div>
				<button class="video-loading-cancel">–û—Ç–º–µ–Ω–∞</button>
			</div>
		</div>

		<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
		<div class="context-menu" id="context-menu">
			<div class="context-menu-item add-friend hidden" id="context-menu-add">
				–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
			</div>
			<div
				class="context-menu-item remove-friend hidden"
				id="context-menu-remove"
			>
				–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π
			</div>
		</div>

		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã—Ö–æ–¥–∞ -->
		<div class="modal-overlay hidden" id="logout-overlay"></div>
		<div class="logout-modal hidden" id="logout-modal">
			<button class="modal-close-btn" id="logout-close-btn">√ó</button>
			<div class="logout-text">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
			<div class="logout-buttons">
				<button class="logout-button logout-cancel" id="logout-cancel-btn">
					–û—Ç–º–µ–Ω–∞
				</button>
				<button class="logout-button logout-confirm" id="logout-confirm-btn">
					–í—ã–π—Ç–∏
				</button>
			</div>
		</div>

		<div class="message-context-menu hidden" id="message-context-menu">
			<div class="message-context-item" id="message-reply">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
			<div class="message-context-item" id="message-edit">–ò–∑–º–µ–Ω–∏—Ç—å</div>
			<div class="message-context-item" id="message-pin">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
			<div class="message-context-item" id="message-delete">–£–¥–∞–ª–∏—Ç—å</div>
			<div
				class="message-context-item"
				id="message-delete-for-me"
				style="display: none"
			>
				–£–¥–∞–ª–∏—Ç—å —É –º–µ–Ω—è
			</div>
			<div class="message-context-item" id="message-forward">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
			<div class="message-context-item" id="message-copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
		</div>

		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
		<div class="modal-overlay hidden" id="delete-message-overlay"></div>
		<div class="delete-message-modal hidden" id="delete-message-modal">
			<button class="modal-close-btn" id="delete-message-close-btn">√ó</button>
			<div class="delete-message-text">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
			<div class="delete-message-buttons">
				<button
					class="delete-message-button delete-for-all"
					id="delete-for-all-btn"
				>
					–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö
				</button>
				<button
					class="delete-message-button delete-for-me"
					id="delete-for-me-btn"
				>
					–¢–æ–ª—å–∫–æ —É –º–µ–Ω—è
				</button>
			</div>
			<button class="delete-message-cancel" id="delete-message-cancel-btn">
				–û—Ç–º–µ–Ω–∞
			</button>
		</div>

		<script src="eel.js"></script>
		<script>
			let currentUser = null
			let contextMenu = null
			let contextMenuTarget = null
			let currentChatUserId = null
			let lastMessageId = null
			let activeChats = {}
			let readStatusInterval = null
			let statusUpdateInterval = null
			let onlineStatusInterval = null
			let currentPlayingAudio = null
			let voiceMessagePlaying = false
			let currentPlayingVoiceElement = null

			let currentContextMessage = null
			let chatInputs = {}
			let scrollPositions = {}
			let isDraggingScroll = false
			let scrollDragStartY = 0
			let scrollThumbStartY = 0

			let dateHeaders = new Map()
			let currentStickyDate = null
			let dateHeadersObserver = null

			function initImageModal() {
				const imageModalOverlay = document.getElementById('image-modal-overlay')
				const imageModalImg = document.getElementById('image-modal-img')
				const imageModalClose = document.getElementById('image-modal-close')

				if (!imageModalOverlay || !imageModalImg || !imageModalClose) {
					console.error('Image modal elements not found')
					return
				}

				// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
				window.openImageModal = function (imageSrc) {
					imageModalImg.src = imageSrc
					imageModalOverlay.classList.remove('hidden')
					document.body.style.overflow = 'hidden' // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
				}

				// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
				window.closeImageModal = function () {
					imageModalOverlay.classList.add('hidden')
					imageModalImg.src = ''
					document.body.style.overflow = '' // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
				imageModalClose.addEventListener('click', closeImageModal)
				imageModalOverlay.addEventListener('click', function (e) {
					if (e.target === imageModalOverlay) {
						closeImageModal()
					}
				})

				// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
				document.addEventListener('keydown', function (e) {
					if (
						e.key === 'Escape' &&
						!imageModalOverlay.classList.contains('hidden')
					) {
						closeImageModal()
					}
				})

				console.log('Image modal initialized')
			}

			function stopVoiceMessage() {
				if (currentPlayingAudio) {
					currentPlayingAudio.pause()
					currentPlayingAudio = null
				}
				voiceMessagePlaying = false

				if (currentPlayingVoiceElement) {
					currentPlayingVoiceElement.classList.remove('playing')
					const playIcon =
						currentPlayingVoiceElement.querySelector('.voice-play-icon')
					if (playIcon) {
						playIcon.textContent = '‚ñ∂'
					}
					currentPlayingVoiceElement = null
				}
			}

			function setupVoiceMessageHandlers() {
				// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
				// –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ–π, —Ç–∞–∫ –∫–∞–∫ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
			}

			function updateListenIndicators() {
				// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
				// –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ–π
				return Promise.resolve()
			}

			function formatMessageTime(timestamp) {
				const date = new Date(timestamp)
				return date.toLocaleTimeString('ru-RU', {
					hour: '2-digit',
					minute: '2-digit',
				})
			}
			// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞
			async function ensureECDHInitialized() {
				try {
					const userId = localStorage.getItem('user_id')
					if (!userId) return false

					if (!userKeyPair) {
						console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ECDH —Å–∏—Å—Ç–µ–º—ã...')
						return await initializeECDHSystem()
					}
					return true
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
					return false
				}
			}

			class ECDHZKEncryption {
				static async generateKeyPair() {
					return await window.crypto.subtle.generateKey(
						{
							name: 'ECDH',
							namedCurve: 'P-256',
						},
						true,
						['deriveKey', 'deriveBits']
					)
				}

				static async exportPublicKey(publicKey) {
					const exported = await window.crypto.subtle.exportKey(
						'spki',
						publicKey
					)
					return btoa(String.fromCharCode(...new Uint8Array(exported)))
				}

				static async importPublicKey(publicKeyBase64) {
					const binary = Uint8Array.from(atob(publicKeyBase64), c =>
						c.charCodeAt(0)
					)
					return await window.crypto.subtle.importKey(
						'spki',
						binary,
						{
							name: 'ECDH',
							namedCurve: 'P-256',
						},
						true,
						[]
					)
				}

				static async deriveSharedSecret(privateKey, peerPublicKey) {
					return await window.crypto.subtle.deriveKey(
						{
							name: 'ECDH',
							public: peerPublicKey,
						},
						privateKey,
						{
							name: 'AES-GCM',
							length: 256,
						},
						true,
						['encrypt', 'decrypt']
					)
				}

				// –ù–ê–°–¢–û–Ø–©–ï–ï AES-256 –®–ò–§–†–û–í–ê–ù–ò–ï
				static async encryptTextAES(text, derivedKey) {
					try {
						const encoder = new TextEncoder()
						const data = encoder.encode(text)

						// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π IV (16 –±–∞–π—Ç –¥–ª—è AES-GCM)
						const iv = crypto.getRandomValues(new Uint8Array(16))

						// –®–∏—Ñ—Ä—É–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-GCM
						const encrypted = await crypto.subtle.encrypt(
							{
								name: 'AES-GCM',
								iv: iv,
								tagLength: 128, // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–µ–≥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
							},
							derivedKey,
							data
						)

						// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º IV + –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
						const combined = new Uint8Array(iv.length + encrypted.byteLength)
						combined.set(iv)
						combined.set(new Uint8Array(encrypted), iv.length)

						return this.arrayBufferToBase64(combined)
					} catch (error) {
						console.error('AES encryption error:', error)
						throw new Error('–û—à–∏–±–∫–∞ AES —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: ' + error.message)
					}
				}

				// –ù–ê–°–¢–û–Ø–©–ï–ï AES-256 –î–ï–®–ò–§–†–û–í–ê–ù–ò–ï
				static async decryptTextAES(encryptedData, derivedKey) {
					try {
						const combined = this.base64ToArrayBuffer(encryptedData)

						// –ò–∑–≤–ª–µ–∫–∞–µ–º IV (–ø–µ—Ä–≤—ã–µ 16 –±–∞–π—Ç) –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
						const iv = combined.slice(0, 16)
						const data = combined.slice(16)

						const decrypted = await crypto.subtle.decrypt(
							{
								name: 'AES-GCM',
								iv: iv,
								tagLength: 128,
							},
							derivedKey,
							data
						)

						const decoder = new TextDecoder()
						return decoder.decode(decrypted)
					} catch (error) {
						console.error('AES decryption error:', error)
						throw new Error('–û—à–∏–±–∫–∞ AES –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: ' + error.message)
					}
				}

				// –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —Å AES-CBC (–±–æ–ª–µ–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)
				static async encryptTextAES_CBC(text, derivedKey) {
					try {
						const encoder = new TextEncoder()
						const data = encoder.encode(text)

						// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π IV (16 –±–∞–π—Ç –¥–ª—è AES-CBC)
						const iv = crypto.getRandomValues(new Uint8Array(16))

						// –®–∏—Ñ—Ä—É–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-CBC
						const encrypted = await crypto.subtle.encrypt(
							{
								name: 'AES-CBC',
								iv: iv,
							},
							derivedKey,
							data
						)

						// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º IV + –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
						const combined = new Uint8Array(iv.length + encrypted.byteLength)
						combined.set(iv)
						combined.set(new Uint8Array(encrypted), iv.length)

						return this.arrayBufferToBase64(combined)
					} catch (error) {
						console.error('AES-CBC encryption error:', error)
						throw new Error('–û—à–∏–±–∫–∞ AES-CBC —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: ' + error.message)
					}
				}

				static async decryptTextAES_CBC(encryptedData, derivedKey) {
					try {
						const combined = this.base64ToArrayBuffer(encryptedData)

						// –ò–∑–≤–ª–µ–∫–∞–µ–º IV (–ø–µ—Ä–≤—ã–µ 16 –±–∞–π—Ç) –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
						const iv = combined.slice(0, 16)
						const data = combined.slice(16)

						const decrypted = await crypto.subtle.decrypt(
							{
								name: 'AES-CBC',
								iv: iv,
							},
							derivedKey,
							data
						)

						const decoder = new TextDecoder()
						return decoder.decode(decrypted)
					} catch (error) {
						console.error('AES-CBC decryption error:', error)
						throw new Error('–û—à–∏–±–∫–∞ AES-CBC –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: ' + error.message)
					}
				}

				// –ú–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º
				static async encryptText(text, derivedKey) {
					return await this.encryptTextAES(text, derivedKey)
				}

				static async decryptText(encryptedData, derivedKey) {
					return await this.decryptTextAES(encryptedData, derivedKey)
				}

				// –®–ò–§–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í –° AES
				static async encryptFile(file, derivedKey) {
					return new Promise((resolve, reject) => {
						const reader = new FileReader()

						reader.onload = async event => {
							try {
								const arrayBuffer = event.target.result

								if (arrayBuffer.byteLength > 10 * 1024 * 1024) {
									reject(new Error('File too large (max 10MB)'))
									return
								}

								// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π IV
								const iv = crypto.getRandomValues(new Uint8Array(16))

								// –®–∏—Ñ—Ä—É–µ–º —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AES-GCM
								const encrypted = await crypto.subtle.encrypt(
									{
										name: 'AES-GCM',
										iv: iv,
										tagLength: 128,
									},
									derivedKey,
									arrayBuffer
								)

								// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º IV + –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
								const combined = new Uint8Array(
									iv.length + encrypted.byteLength
								)
								combined.set(iv)
								combined.set(new Uint8Array(encrypted), iv.length)

								const base64 = this.arrayBufferToBase64(combined)
								resolve(base64)
							} catch (error) {
								console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error)
								reject(error)
							}
						}

						reader.onerror = () => {
							reject(new Error('Failed to read file'))
						}

						reader.readAsArrayBuffer(file)
					})
				}

				static async decryptFile(encryptedData, derivedKey) {
					try {
						const combined = this.base64ToArrayBuffer(encryptedData)

						// –ò–∑–≤–ª–µ–∫–∞–µ–º IV (–ø–µ—Ä–≤—ã–µ 16 –±–∞–π—Ç) –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
						const iv = combined.slice(0, 16)
						const data = combined.slice(16)

						const decrypted = await crypto.subtle.decrypt(
							{
								name: 'AES-GCM',
								iv: iv,
								tagLength: 128,
							},
							derivedKey,
							data
						)

						return decrypted
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:', error)
						throw error
					}
				}

				// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´
				static arrayBufferToBase64(buffer) {
					let binary = ''
					const bytes = new Uint8Array(buffer)
					const len = bytes.byteLength
					for (let i = 0; i < len; i++) {
						binary += String.fromCharCode(bytes[i])
					}
					return btoa(binary)
				}

				static base64ToArrayBuffer(base64) {
					const binaryString = atob(base64)
					const len = binaryString.length
					const bytes = new Uint8Array(len)
					for (let i = 0; i < len; i++) {
						bytes[i] = binaryString.charCodeAt(i)
					}
					return bytes
				}

				// –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–õ–Æ–ß–ï–ô –ò–ó –ü–ê–†–û–õ–Ø (–¥–ª—è ZK —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è)
				static async deriveKeyFromPassword(password, salt) {
					try {
						const encoder = new TextEncoder()
						const passwordBuffer = encoder.encode(password)

						// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å –∫–∞–∫ –∫–ª—é—á–µ–≤–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª
						const keyMaterial = await crypto.subtle.importKey(
							'raw',
							passwordBuffer,
							'PBKDF2',
							false,
							['deriveKey']
						)

						// –ò—Å–ø–æ–ª—å–∑—É–µ–º PBKDF2 –¥–ª—è –≤—ã–≤–æ–¥–∞ –∫–ª—é—á–∞
						return await crypto.subtle.deriveKey(
							{
								name: 'PBKDF2',
								salt: salt,
								iterations: 100000,
								hash: 'SHA-256',
							},
							keyMaterial,
							{ name: 'AES-GCM', length: 256 },
							false,
							['encrypt', 'decrypt']
						)
					} catch (error) {
						console.error('Error deriving key from password:', error)
						throw error
					}
				}
			}

			class ZKPasswordEncryption {
				static async deriveKey(password, salt) {
					const encoder = new TextEncoder()
					const keyMaterial = await crypto.subtle.importKey(
						'raw',
						encoder.encode(password),
						'PBKDF2',
						false,
						['deriveKey']
					)

					return await crypto.subtle.deriveKey(
						{
							name: 'PBKDF2',
							salt: salt,
							iterations: 100000,
							hash: 'SHA-256',
						},
						keyMaterial,
						{ name: 'AES-GCM', length: 256 },
						false,
						['encrypt', 'decrypt']
					)
				}

				static async encryptText(text, key) {
					const encoder = new TextEncoder()
					const data = encoder.encode(text)

					const iv = crypto.getRandomValues(new Uint8Array(12))

					const encrypted = await crypto.subtle.encrypt(
						{
							name: 'AES-GCM',
							iv: iv,
						},
						key,
						data
					)

					const combined = new Uint8Array(iv.length + encrypted.byteLength)
					combined.set(iv)
					combined.set(new Uint8Array(encrypted), iv.length)

					return {
						data: btoa(String.fromCharCode(...combined)),
						iv: btoa(String.fromCharCode(...iv)),
					}
				}

				static async decryptText(encryptedData, key) {
					try {
						const encryptedArray = Uint8Array.from(atob(encryptedData), c =>
							c.charCodeAt(0)
						)

						// –ò–∑–≤–ª–µ–∫–∞–µ–º IV (–ø–µ—Ä–≤—ã–µ 12 –±–∞–π—Ç) –∏ –¥–∞–Ω–Ω—ã–µ
						const iv = encryptedArray.slice(0, 12)
						const data = encryptedArray.slice(12)

						const decrypted = await crypto.subtle.decrypt(
							{
								name: 'AES-GCM',
								iv: iv,
							},
							key,
							data
						)

						const decoder = new TextDecoder()
						return decoder.decode(decrypted)
					} catch (error) {
						console.error('Decryption error:', error)
						throw new Error(
							'–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.'
						)
					}
				}

				static base64ToUint8Array(base64) {
					const binary = atob(base64)
					const bytes = new Uint8Array(binary.length)
					for (let i = 0; i < binary.length; i++) {
						bytes[i] = binary.charCodeAt(i)
					}
					return bytes
				}

				static uint8ArrayToBase64(uint8Array) {
					return btoa(String.fromCharCode(...uint8Array))
				}
			}

			// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π
			let userKeyPair = null
			let sharedSecrets = new Map()

			async function initializeECDHSystem() {
				try {
					const userId = localStorage.getItem('user_id')
					if (!userId) {
						console.error('User ID not found')
						return false
					}

					console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ECDH —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId)

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ECDH —Å–∏—Å—Ç–µ–º—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
					const initResult = await eel.initialize_ecdh_system(userId)()
					if (!initResult.success) {
						console.error(
							'–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ECDH –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:',
							initResult.message
						)
						return false
					}

					// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ECDH –∫–ª—é—á–µ–≤—É—é –ø–∞—Ä—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
					const storedKeyPair = localStorage.getItem(`ecdh_keypair_${userId}`)

					if (storedKeyPair) {
						console.log('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ECDH –∫–ª—é—á–µ–π –∏–∑ localStorage')
						const keyData = JSON.parse(storedKeyPair)

						// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
						userKeyPair = {
							privateKey: await crypto.subtle.importKey(
								'jwk',
								keyData.privateKey,
								{ name: 'ECDH', namedCurve: 'P-256' },
								true,
								['deriveKey', 'deriveBits']
							),
							publicKey: await crypto.subtle.importKey(
								'jwk',
								keyData.publicKey,
								{ name: 'ECDH', namedCurve: 'P-256' },
								true,
								[]
							),
						}

						console.log('ECDH –∫–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã')
					} else {
						console.log('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π ECDH –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä—ã')
						userKeyPair = await ECDHZKEncryption.generateKeyPair()

						// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
						const exportedPrivate = await crypto.subtle.exportKey(
							'jwk',
							userKeyPair.privateKey
						)
						const exportedPublic = await crypto.subtle.exportKey(
							'jwk',
							userKeyPair.publicKey
						)

						// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á–∏ –≤ localStorage
						localStorage.setItem(
							`ecdh_keypair_${userId}`,
							JSON.stringify({
								privateKey: exportedPrivate,
								publicKey: exportedPublic,
							})
						)

						console.log('–ù–æ–≤–∞—è ECDH –∫–ª—é—á–µ–≤–∞—è –ø–∞—Ä–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞')
					}

					// –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π
					console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ –¥–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π')
					await getSelfChatSecret()

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º sharedSecrets Map –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
					if (!sharedSecrets) {
						sharedSecrets = new Map()
					}

					console.log('ECDH —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
					return true
				} catch (error) {
					console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ECDH —Å–∏—Å—Ç–µ–º—ã:', error)

					// –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
					try {
						console.log('–ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ECDH —Å–∏—Å—Ç–µ–º—ã...')
						localStorage.removeItem(
							`ecdh_keypair_${localStorage.getItem('user_id')}`
						)
						localStorage.removeItem(
							`self_chat_secret_${localStorage.getItem('user_id')}`
						)

						// –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏
						const userId = localStorage.getItem('user_id')
						if (userId) {
							userKeyPair = await ECDHZKEncryption.generateKeyPair()

							const exportedPrivate = await crypto.subtle.exportKey(
								'jwk',
								userKeyPair.privateKey
							)
							const exportedPublic = await crypto.subtle.exportKey(
								'jwk',
								userKeyPair.publicKey
							)

							localStorage.setItem(
								`ecdh_keypair_${userId}`,
								JSON.stringify({
									privateKey: exportedPrivate,
									publicKey: exportedPublic,
								})
							)

							await getSelfChatSecret()
							console.log('ECDH —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏')
							return true
						}
					} catch (recoveryError) {
						console.error(
							'–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ECDH —Å–∏—Å—Ç–µ–º—É:',
							recoveryError
						)
					}

					return false
				}
			}

			async function getSelfChatSecret() {
				try {
					const userId = localStorage.getItem('user_id')
					if (!userId) {
						throw new Error('User ID not found')
					}

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à –≤ –ø–∞–º—è—Ç–∏
					if (sharedSecrets && sharedSecrets.has(userId)) {
						return sharedSecrets.get(userId)
					}

					// –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á —Å —Å–µ—Ä–≤–µ—Ä–∞
					console.log('Getting self chat secret from server')
					const serverResponse = await eel.get_self_chat_secret(userId)()

					if (serverResponse.success) {
						console.log('Server returned self chat secret')
						// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á –∏–∑ base64
						const sharedSecret = await crypto.subtle.importKey(
							'raw',
							ECDHZKEncryption.base64ToArrayBuffer(
								serverResponse.shared_secret
							),
							{ name: 'AES-GCM', length: 256 },
							true,
							['encrypt', 'decrypt']
						)

						if (sharedSecrets) {
							sharedSecrets.set(userId, sharedSecret)
						}
						return sharedSecret
					} else {
						throw new Error('Failed to get self chat secret from server')
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–∞ –¥–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π:', error)
					throw error
				}
			}

			async function computeSharedSecret(peerUserId) {
				try {
					const currentUserId = localStorage.getItem('user_id')

					if (!userKeyPair) {
						throw new Error('ECDH –∫–ª—é—á–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã')
					}

					// –î–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
					if (peerUserId === currentUserId) {
						return await getSelfChatSecret()
					}

					console.log('Computing shared secret for peer:', peerUserId)

					// –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
					const peerPublicKeyResponse = await eel.get_user_public_key(
						peerUserId
					)()
					if (!peerPublicKeyResponse.success) {
						throw new Error(
							'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞: ' +
								peerPublicKeyResponse.message
						)
					}

					console.log('Got peer public key, importing...')
					const peerPublicKey = await ECDHZKEncryption.importPublicKey(
						peerPublicKeyResponse.public_key
					)

					// –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç
					console.log('Deriving shared secret...')
					const sharedSecret = await ECDHZKEncryption.deriveSharedSecret(
						userKeyPair.privateKey,
						peerPublicKey
					)

					// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
					const exportedKey = await crypto.subtle.exportKey('raw', sharedSecret)
					const keyBase64 = ECDHZKEncryption.arrayBufferToBase64(exportedKey)

					console.log('Saving shared secret to server...')
					// –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è persistence
					await eel.compute_shared_secret(currentUserId, peerUserId)()

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç –≤ –∫–µ—à–µ
					sharedSecrets.set(peerUserId, sharedSecret)

					console.log('Shared secret computed and saved successfully')
					return sharedSecret
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –æ–±—â–µ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞:', error)
					throw error
				}
			}

			async function getSharedSecret(peerUserId) {
				try {
					const currentUserId = localStorage.getItem('user_id')

					// –û—Å–æ–±—ã–π —Å–ª—É—á–∞–π: —á–∞—Ç —Å —Å–∞–º–∏–º —Å–æ–±–æ–π
					if (peerUserId === currentUserId) {
						return await getSelfChatSecret()
					}

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à –≤ –ø–∞–º—è—Ç–∏
					if (sharedSecrets && sharedSecrets.has(peerUserId)) {
						console.log('Using cached shared secret for:', peerUserId)
						return sharedSecrets.get(peerUserId)
					}

					// –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
					console.log('Getting shared secret from server for:', peerUserId)
					const serverResponse = await eel.get_shared_secret(
						currentUserId,
						peerUserId
					)()

					if (serverResponse.success) {
						console.log('Server returned shared secret')
						// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª—é—á –∏–∑ base64
						const sharedSecret = await crypto.subtle.importKey(
							'raw',
							ECDHZKEncryption.base64ToArrayBuffer(
								serverResponse.shared_secret
							),
							{ name: 'AES-GCM', length: 256 },
							true,
							['encrypt', 'decrypt']
						)

						if (sharedSecrets) {
							sharedSecrets.set(peerUserId, sharedSecret)
						}
						return sharedSecret
					} else {
						console.log('No shared secret on server, computing new one...')
						// –ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ—Ç, –≤—ã—á–∏—Å–ª—è–µ–º –∑–∞–Ω–æ–≤–æ
						return await computeSharedSecret(peerUserId)
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞:', error)
					throw error
				}
			}
			async function repairEncryptionSystem() {
				try {
					const userId = localStorage.getItem('user_id')
					console.log('Repairing encryption system for user:', userId)

					// –û—á–∏—â–∞–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏
					localStorage.removeItem(`ecdh_keypair_${userId}`)
					localStorage.removeItem(`self_chat_secret_${userId}`)
					if (sharedSecrets) {
						sharedSecrets.clear()
					}
					userKeyPair = null

					// –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É
					const success = await initializeECDHSystem()

					if (success) {
						console.log('Encryption system repaired successfully')

						// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
						if (currentChatUserId) {
							await loadZKChatHistory(currentChatUserId)
						}

						return true
					} else {
						throw new Error('Failed to reinitialize encryption system')
					}
				} catch (error) {
					console.error('Error repairing encryption system:', error)
					return false
				}
			}

			async function decryptMessageContent(messageId) {
				try {
					const result = await eel.decrypt_message_content(
						localStorage.getItem('user_id'),
						messageId
					)()

					if (result.success) {
						return result.decrypted_text
					} else {
						console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:', result.message)
						return '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error)
					return '[–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è]'
				}
			}

			async function updateLastMessageAfterDelete(chatUserId) {
				try {
					const lastMessage = await eel.get_last_message(
						localStorage.getItem('user_id'),
						chatUserId
					)()
					const userCard = document.querySelector(
						`.user-bar[data-user-id="${chatUserId}"]`
					)

					if (!userCard) return

					const lastMsgDiv = userCard.querySelector('.last-message')
					const contentWrapper = userCard.querySelector('.user-content-wrapper')

					if (lastMessage) {
						let displayText = lastMessage.text
						if (displayText.length > 25) {
							displayText = displayText.substring(0, 22) + '...'
						}

						if (lastMessage.sender_id === localStorage.getItem('user_id')) {
							if (lastMsgDiv) {
								lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
							} else if (contentWrapper) {
								const newLastMsgDiv = document.createElement('div')
								newLastMsgDiv.className = 'last-message'
								newLastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
								contentWrapper.appendChild(newLastMsgDiv)
							}
						} else {
							if (lastMsgDiv) {
								lastMsgDiv.textContent = displayText
							} else if (contentWrapper) {
								const newLastMsgDiv = document.createElement('div')
								newLastMsgDiv.className = 'last-message'
								newLastMsgDiv.textContent = displayText
								contentWrapper.appendChild(newLastMsgDiv)
							}
						}
					} else {
						// –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ last-message
						if (lastMsgDiv) {
							lastMsgDiv.remove()
						}
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
				}
			}

			async function checkEncryptionKeys() {
				try {
					const user_id = localStorage.getItem('user_id')
					if (!user_id) {
						console.error('No user ID found')
						return false
					}

					// –ü–æ–ª—É—á–∞–µ–º —Å–æ–ª—å —Å —Å–µ—Ä–≤–µ—Ä–∞
					const saltResponse = await eel.get_user_salt(user_id)()
					if (!saltResponse.success) {
						console.error('Failed to get salt from server')
						return false
					}

					// –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ sessionStorage
					const userPassword = sessionStorage.getItem('user_password')
					if (!userPassword) {
						console.error('No password in sessionStorage')
						return false
					}

					// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–ª—å
					const saltBytes = Uint8Array.from(atob(saltResponse.salt), c =>
						c.charCodeAt(0)
					)

					// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
					const newKey = await zkCrypto.deriveKey(userPassword, saltBytes)

					// –í–º–µ—Å—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–ª—é—á–µ–π, —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏—Ö —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
					const testResult = await testEncryptionKeyWithKey(newKey)

					console.log('Keys check result:', testResult)

					if (testResult) {
						// –ï—Å–ª–∏ –Ω–æ–≤—ã–π –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á
						userEncryptionKey = newKey
						return true
					}

					return false
				} catch (error) {
					console.error('Error checking encryption keys:', error)
					return false
				}
			}
			function sendAllMedia() {
				alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
				closeMediaModal()
			}

			function openFileSelector() {
				alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
			}

			function closeMediaModal() {
				// –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
			}

			function handleFileSelect(event) {
				alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
				event.target.value = ''
			}

			function showMediaUploadProgress() {}
			function hideMediaUploadProgress() {}
			function updateMediaUploadProgress() {}
			function sendZKMediaMessage() {
				alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
				return false
			}
			// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
			async function testEncryptionKeyWithKey(key) {
				try {
					const testText = 'test message'
					const encrypted = await zkCrypto.encryptText(testText, key)
					const decrypted = await zkCrypto.decryptText(encrypted, key)
					return decrypted === testText
				} catch (error) {
					console.error('Key test failed:', error)
					return false
				}
			}

			document.addEventListener('click', function (e) {
				let userBar = e.target.closest('.user-bar')
				if (userBar) {
					const userId = userBar.dataset.userId

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç —á–∞—Ç
					if (
						currentChatUserId === userId &&
						!document
							.getElementById('chat-container')
							.classList.contains('hidden')
					) {
						return // –ß–∞—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
					}

					openChat(userId)

					document.querySelectorAll('.user-bar').forEach(el => {
						el.classList.remove('active-chat')
					})
					userBar.classList.add('active-chat')
				}
			})

			class ZKEncryptionSystem {
				static async deriveMasterKey(password1, password2, salt) {
					// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª–∏
					const combinedPassword = `${password1}:${password2}`

					// –ò—Å–ø–æ–ª—å–∑—É–µ–º PBKDF2 –¥–ª—è –≤—ã–≤–æ–¥–∞ –∫–ª—é—á–∞
					const encoder = new TextEncoder()
					const combinedPasswordBytes = encoder.encode(combinedPassword)

					const keyMaterial = await crypto.subtle.importKey(
						'raw',
						combinedPasswordBytes,
						'PBKDF2',
						false,
						['deriveBits']
					)

					const derivedBits = await crypto.subtle.deriveBits(
						{
							name: 'PBKDF2',
							salt: salt,
							iterations: 100000,
							hash: 'SHA-256',
						},
						keyMaterial,
						256
					)

					return new Uint8Array(derivedBits)
				}

				static async encryptMessage(message, masterKey) {
					const encoder = new TextEncoder()
					const messageBytes = encoder.encode(message)

					// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π nonce
					const nonce = crypto.getRandomValues(new Uint8Array(16))

					// –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á–∞
					const cryptoKey = await crypto.subtle.importKey(
						'raw',
						masterKey,
						{ name: 'AES-GCM' },
						false,
						['encrypt']
					)

					// –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
					const encrypted = await crypto.subtle.encrypt(
						{
							name: 'AES-GCM',
							iv: nonce,
						},
						cryptoKey,
						messageBytes
					)

					// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º nonce + –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
					const result = new Uint8Array(nonce.length + encrypted.byteLength)
					result.set(nonce)
					result.set(new Uint8Array(encrypted), nonce.length)

					return btoa(String.fromCharCode(...result))
				}

				static async decryptMessage(encryptedMessage, masterKey) {
					const encryptedData = Uint8Array.from(atob(encryptedMessage), c =>
						c.charCodeAt(0)
					)

					// –ò–∑–≤–ª–µ–∫–∞–µ–º nonce –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
					const nonce = encryptedData.slice(0, 16)
					const encryptedBytes = encryptedData.slice(16)

					// –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
					const cryptoKey = await crypto.subtle.importKey(
						'raw',
						masterKey,
						{ name: 'AES-GCM' },
						false,
						['decrypt']
					)

					// –î–µ—à–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
					const decrypted = await crypto.subtle.decrypt(
						{
							name: 'AES-GCM',
							iv: nonce,
						},
						cryptoKey,
						encryptedBytes
					)

					const decoder = new TextDecoder()
					return decoder.decode(decrypted)
				}
			}

			// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è ZK —Å–∏—Å—Ç–µ–º—ã
			let zkMasterKeys = new Map()

			async function initializeZKChat(
				userId,
				peerUserId,
				myPassword,
				peerPassword
			) {
				try {
					// –ü–æ–ª—É—á–∞–µ–º —Å–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
					const myUserData = await eel.get_user_data(userId)()
					const peerUserData = await eel.get_user_data(peerUserId)()

					if (!myUserData || !peerUserData) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')
					}

					const mySalt = Uint8Array.from(atob(myUserData.salt), c =>
						c.charCodeAt(0)
					)
					const peerSalt = Uint8Array.from(atob(peerUserData.salt), c =>
						c.charCodeAt(0)
					)

					// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º —Å–æ–ª–∏
					const combinedSalt = new Uint8Array([...mySalt, ...peerSalt])

					// –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á
					const masterKey = await ZKEncryptionSystem.deriveMasterKey(
						myPassword,
						peerPassword,
						combinedSalt
					)

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á –≤ –ø–∞–º—è—Ç–∏
					const chatKey = `${userId}-${peerUserId}`
					zkMasterKeys.set(chatKey, masterKey)

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è persistence
					await eel.compute_shared_master_key(
						userId,
						peerUserId,
						myPassword,
						peerPassword
					)()

					return masterKey
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ZK —á–∞—Ç–∞:', error)
					throw error
				}
			}

			async function getZKMasterKey(userId, peerUserId) {
				const chatKey = `${userId}-${peerUserId}`

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à –≤ –ø–∞–º—è—Ç–∏
				if (zkMasterKeys.has(chatKey)) {
					return zkMasterKeys.get(chatKey)
				}

				// –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
				const serverResponse = await eel.get_shared_master_key(
					userId,
					peerUserId
				)()
				if (serverResponse.success) {
					const masterKey = Uint8Array.from(
						atob(serverResponse.master_key),
						c => c.charCodeAt(0)
					)
					zkMasterKeys.set(chatKey, masterKey)
					return masterKey
				}

				throw new Error('–ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω')
			}

			async function sendZKMessage(text) {
				if (!currentChatUserId || !text) return

				try {
					const userId = localStorage.getItem('user_id')
					const messageInput = document.getElementById('message-input')

					// –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
					if (messageInput.disabled) return
					messageInput.disabled = true

					// –î–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º ZK —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–∞—Ä–æ–ª–µ–º –∞–∫–∫–∞—É–Ω—Ç–∞
					if (currentChatUserId === userId) {
						console.log(
							'üîê –ò—Å–ø–æ–ª—å–∑—É–µ–º AES-256 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π'
						)

						// –ü–æ–ª—É—á–∞–µ–º —Å–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
						const saltResponse = await eel.get_user_salt(userId)()
						if (!saltResponse.success) {
							throw new Error(
								'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: ' +
									saltResponse.message
							)
						}

						const salt = saltResponse.salt

						// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ZK —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞—Å—Ç–æ—è—â–∏–º AES —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º
						const result = await eel.send_zk_message(
							userId,
							currentChatUserId,
							text,
							salt
						)()

						if (result.success) {
							await handleSuccessfulMessage(result, text, true)
						} else {
							throw new Error(result.message)
						}
					} else {
						// –î–ª—è —á–∞—Ç–∞ —Å –¥—Ä—É–≥–∏–º–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º ECDH + AES —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
						console.log(
							'üîê –ò—Å–ø–æ–ª—å–∑—É–µ–º ECDH + AES-256 —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Ç–∞ —Å –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'
						)

						if (!userKeyPair) {
							const ecdhInitialized = await initializeECDHSystem()
							if (!ecdhInitialized) {
								throw new Error('ECDH —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞')
							}
						}

						const sharedSecret = await getSharedSecret(currentChatUserId)
						const encryptedText = await ECDHZKEncryption.encryptTextAES(
							text,
							sharedSecret
						)

						// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
						const result = await eel.send_encrypted_message(
							userId,
							currentChatUserId,
							encryptedText
						)()

						if (result.success) {
							await handleSuccessfulMessage(result, text, true)
						} else {
							throw new Error(result.message)
						}
					}
				} catch (error) {
					console.error('Error sending message:', error)
					alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
				} finally {
					// –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
					const messageInput = document.getElementById('message-input')
					messageInput.disabled = false
				}
			}

			// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è ZK —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
			function base64ToUint8Array(base64) {
				const binary = atob(base64)
				const bytes = new Uint8Array(binary.length)
				for (let i = 0; i < binary.length; i++) {
					bytes[i] = binary.charCodeAt(i)
				}
				return bytes
			}

			async function deriveKeyFromPassword(password, salt) {
				const encoder = new TextEncoder()
				const keyMaterial = await crypto.subtle.importKey(
					'raw',
					encoder.encode(password),
					'PBKDF2',
					false,
					['deriveKey']
				)

				return await crypto.subtle.deriveKey(
					{
						name: 'PBKDF2',
						salt: salt,
						iterations: 100000,
						hash: 'SHA-256',
					},
					keyMaterial,
					{ name: 'AES-GCM', length: 256 },
					false,
					['encrypt', 'decrypt']
				)
			}

			async function encryptWithPassword(text, key) {
				const encoder = new TextEncoder()
				const data = encoder.encode(text)

				const iv = crypto.getRandomValues(new Uint8Array(12))

				const encrypted = await crypto.subtle.encrypt(
					{
						name: 'AES-GCM',
						iv: iv,
					},
					key,
					data
				)

				const combined = new Uint8Array(iv.length + encrypted.byteLength)
				combined.set(iv)
				combined.set(new Uint8Array(encrypted), iv.length)

				return btoa(String.fromCharCode(...combined))
			}

			async function handleSuccessfulMessage(
				result,
				originalText,
				isMyMessage
			) {
				console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ')

				const message = {
					id: result.message_id,
					sender_id: localStorage.getItem('user_id'),
					receiver_id: currentChatUserId,
					text: originalText,
					timestamp: result.timestamp,
					read: result.read,
					is_encrypted: true,
					encryption_type:
						currentChatUserId === localStorage.getItem('user_id')
							? 'zk_password'
							: 'ecdh',
				}

				await addMessageToChat(message, isMyMessage, true)

				document.getElementById('message-input').value = ''

				try {
					await eel.clear_draft_message(
						localStorage.getItem('user_id'),
						currentChatUserId
					)()
					console.log('–ß–µ—Ä–Ω–æ–≤–∏–∫ –æ—á–∏—â–µ–Ω –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞:', error)
				}

				updateLastMessageOnUserCard(currentChatUserId, originalText, true)
			}

			// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞
			function showMediaUploadProgress(text, progress) {
				// –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
				let progressElement = document.getElementById('media-upload-progress')

				if (!progressElement) {
					progressElement = document.createElement('div')
					progressElement.id = 'media-upload-progress'
					progressElement.className = 'media-upload-progress'
					progressElement.innerHTML = `
            <div class="media-upload-progress-content">
                <div class="media-upload-progress-text">${text}</div>
                <div class="media-upload-progress-bar">
                    <div class="media-upload-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="media-upload-progress-percent">${Math.round(
									progress
								)}%</div>
            </div>
        `
					document.body.appendChild(progressElement)
				} else {
					progressElement.querySelector(
						'.media-upload-progress-text'
					).textContent = text
					progressElement.querySelector(
						'.media-upload-progress-fill'
					).style.width = `${progress}%`
					progressElement.querySelector(
						'.media-upload-progress-percent'
					).textContent = `${Math.round(progress)}%`
				}

				progressElement.style.display = 'block'
			}

			document.addEventListener('DOMContentLoaded', async function () {
				const user_id = localStorage.getItem('user_id')
				if (!user_id) {
					window.location.href = 'login.html'
					return
				}

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ECDH —Å–∏—Å—Ç–µ–º—ã
				const ecdhInitialized = await initializeECDHSystem()
				if (!ecdhInitialized) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ECDH —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
					alert(
						'–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.'
					)
				} else {
					console.log('ECDH —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
				}

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
				initCustomScroll()
				initImageModal()

				// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–¥ –≤—ã–≥—Ä—É–∑–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
				window.addEventListener('beforeunload', function () {
					if (currentChatUserId) {
						const currentText = document.getElementById('message-input').value
						if (currentText.trim()) {
							eel.save_draft_message(
								localStorage.getItem('user_id'),
								currentChatUserId,
								currentText
							)()
						}
					}
					eel.update_last_online(localStorage.getItem('user_id'))()
				})

				// –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω
				startOnlineStatusUpdates()

				// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
				try {
					currentUser = await eel.get_user_data(user_id)()
					if (!currentUser) {
						localStorage.removeItem('user_id')
						window.location.href = 'login.html'
						return
					}
					console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', currentUser.nickname)
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error)
					localStorage.removeItem('user_id')
					window.location.href = 'login.html'
					return
				}

				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
				document.getElementById('top-avatar').style.backgroundImage =
					'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)'

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
				const searchInput = document.querySelector('.search-input')
				const clearBtn = document.querySelector('.clear-btn')

				searchInput.addEventListener('input', async function () {
					const searchTerm = this.value.trim()
					if (searchTerm.length > 0) {
						const users = await eel.search_users(searchTerm, user_id)()
						displaySearchResults(users)
					} else {
						loadFriends()
					}
				})

				clearBtn.addEventListener('click', function () {
					searchInput.value = ''
					searchInput.focus()
					loadFriends()
				})

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
				contextMenu = document.getElementById('context-menu')
				document.addEventListener('click', closeContextMenu)
				document
					.getElementById('context-menu-add')
					.addEventListener('click', handleAddFriend)
				document
					.getElementById('context-menu-remove')
					.addEventListener('click', handleRemoveFriend)

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–µ–Ω—é –≤—ã—Ö–æ–¥–∞
				document
					.querySelector('.menu-icon')
					.addEventListener('click', function () {
						document.getElementById('logout-overlay').classList.remove('hidden')
						document.getElementById('logout-modal').classList.remove('hidden')
					})

				document
					.getElementById('logout-close-btn')
					.addEventListener('click', closeLogoutModal)
				document
					.getElementById('logout-cancel-btn')
					.addEventListener('click', closeLogoutModal)
				document
					.getElementById('logout-overlay')
					.addEventListener('click', closeLogoutModal)

				document
					.getElementById('logout-confirm-btn')
					.addEventListener('click', function () {
						// –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
						userEncryptionKey = null
						userKeyPair = null
						sharedSecrets.clear()
						localStorage.removeItem('zk_initialized')
						localStorage.removeItem('user_salt')
						localStorage.removeItem(`ecdh_keypair_${user_id}`)
						localStorage.removeItem(`self_chat_secret_${user_id}`)
						sessionStorage.removeItem('user_password')
						localStorage.removeItem('user_id')

						eel.update_last_online(user_id)()
						window.location.href = 'login.html'
					})

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è ESC
				document.addEventListener('keydown', function (e) {
					if (e.key === 'Escape') {
						// –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
						if (
							!document
								.getElementById('image-modal-overlay')
								.classList.contains('hidden')
						) {
							closeImageModal()
							return
						}

						// –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è - –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
						if (
							!document
								.getElementById('delete-message-modal')
								.classList.contains('hidden')
						) {
							document
								.getElementById('delete-message-overlay')
								.classList.add('hidden')
							document
								.getElementById('delete-message-modal')
								.classList.add('hidden')
							return
						}

						// –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ
						if (
							!document
								.getElementById('chat-container')
								.classList.contains('hidden')
						) {
							// –°–±—Ä–∞—Å—ã–≤–∞–µ–º currentChatUserId —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —á–∞—Ç —Å —Å–∞–º–∏–º —Å–æ–±–æ–π
							if (currentChatUserId !== localStorage.getItem('user_id')) {
								currentChatUserId = null
							}

							// –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —ç–∫—Ä–∞–Ω
							document
								.getElementById('default-content')
								.classList.remove('hidden')
							document.getElementById('chat-container').classList.add('hidden')

							// –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
							document.querySelectorAll('.user-bar').forEach(el => {
								el.classList.remove('active-chat')
							})

							// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
							stopVoiceMessage()
							currentPlayingAudio = null
							voiceMessagePlaying = false
							currentPlayingVoiceElement = null

							// –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
							if (readStatusInterval) {
								clearInterval(readStatusInterval)
								readStatusInterval = null
							}
							if (statusUpdateInterval) {
								clearInterval(statusUpdateInterval)
								statusUpdateInterval = null
							}

							// –î–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞
							if (currentChatUserId === localStorage.getItem('user_id')) {
								const selfChat = document.querySelector(
									`.user-bar[data-user-id="${currentChatUserId}"]`
								)
								if (selfChat) {
									selfChat.classList.add('active-chat')
								}
							}
						}
					}
				})

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
				document.addEventListener('click', function (e) {
					let userBar = e.target.closest('.user-bar')
					if (userBar) {
						const userId = userBar.dataset.userId
						openChat(userId)

						document.querySelectorAll('.user-bar').forEach(el => {
							el.classList.remove('active-chat')
						})
						userBar.classList.add('active-chat')
					}
				})

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
				document
					.getElementById('message-input')
					.addEventListener('keypress', async function (e) {
						if (e.key === 'Enter' && this.value.trim()) {
							const text = this.value.trim()
							if (!text) return

							// –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
							if (this.disabled) return
							this.disabled = true

							try {
								await sendZKMessage(text)
							} catch (error) {
								console.error('Error sending message:', error)
								alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
							} finally {
								// –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
								this.disabled = false
							}
						}
					})

				// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
				setInterval(checkForNewMessages, 2000)

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏–π
				initMessageContextMenu()

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–¥–∏–∞
				const mediaAddButton = document.getElementById('media-add-button')
				const mediaCancelButton = document.getElementById('media-cancel-button')
				const mediaSendButton = document.getElementById('media-send-button')
				const mediaSendOverlay = document.getElementById('media-send-overlay')
				const mediaSendModal = document.getElementById('media-send-modal')
				const mediaCaptionInput = document.getElementById('media-caption-input')

				const photoBtn = document.getElementById('photo-message-btn')
				if (photoBtn) {
					photoBtn.addEventListener('click', function (e) {
						e.preventDefault()
						e.stopPropagation()
						alert(
							'–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è.'
						)
					})
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–µ–¥–∏–∞
				if (mediaAddButton) {
					mediaAddButton.addEventListener('click', function () {
						alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
					})
				}

				if (mediaSendButton) {
					mediaSendButton.addEventListener('click', sendAllMedia)
				}

				if (mediaCancelButton) {
					mediaCancelButton.addEventListener('click', closeMediaModal)
				}

				if (mediaSendOverlay) {
					mediaSendOverlay.addEventListener('click', closeMediaModal)
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–æ—Ç–æ
				if (photoBtn) {
					photoBtn.addEventListener('click', function (e) {
						e.preventDefault()
						e.stopPropagation()
						alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					})
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
				const fileInput = document.getElementById('file-input')
				if (fileInput) {
					fileInput.addEventListener('change', function (e) {
						alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
						e.target.value = ''
					})
				}

				// –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π
				await loadFriends()

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
				setTimeout(initButtonHandlers, 1000)

				// –û—Ç–ª–∞–¥–∫–∞ ECDH —Å–∏—Å—Ç–µ–º—ã
				setTimeout(debugECDHSystem, 2000)

				console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ')
			})
			document
				.getElementById('message-input')
				.addEventListener('keypress', async function (e) {
					if (e.key === 'Enter' && this.value.trim()) {
						const text = this.value.trim()
						if (!text) return

						// –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
						if (this.disabled) return
						this.disabled = true

						try {
							await sendZKMessage(text)
						} catch (error) {
							console.error('Error sending message:', error)
							alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
						} finally {
							// –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
							this.disabled = false
						}
					}
				})

			async function debugECDHSystem() {
				try {
					const userId = localStorage.getItem('user_id')
					console.log('Debug ECDH System for user:', userId)

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–π –≤ localStorage
					const storedKeyPair = localStorage.getItem(`ecdh_keypair_${userId}`)
					console.log('Stored key pair exists:', !!storedKeyPair)

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é ECDH
					if (!userKeyPair) {
						console.log('User key pair not initialized, reinitializing...')
						await initializeECDHSystem()
					}

					console.log('ECDH system debug completed')
					return true
				} catch (error) {
					console.error('ECDH debug error:', error)
					return false
				}
			}

			// –í—ã–∑–æ–≤ –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
			setTimeout(debugECDHSystem, 2000)

			function initCustomScroll() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				const scrollbar = document.getElementById('custom-scrollbar')
				const scrollThumb = document.getElementById('custom-scrollbar-thumb')
				const rightContainer = document.querySelector('.right-container')

				let isDraggingScroll = false
				let scrollDragStartY = 0
				let scrollThumbStartY = 0

				// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–ª–∑—É–Ω–∫–∞
				function updateScrollThumb() {
					if (!messagesWrapper) return

					const { scrollHeight, clientHeight, scrollTop } = messagesWrapper

					// –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è
					if (scrollHeight <= clientHeight) {
						scrollbar.style.display = 'none'
						return
					}

					scrollbar.style.display = 'block'
					const thumbHeight = Math.max(
						20,
						(clientHeight / scrollHeight) * clientHeight
					)
					const thumbPosition =
						(scrollTop / (scrollHeight - clientHeight)) *
						(clientHeight - thumbHeight)

					scrollThumb.style.height = `${thumbHeight}px`
					scrollThumb.style.top = `${thumbPosition}px`
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –ø–æ–ª–∑—É–Ω–∫–∞
				scrollThumb.addEventListener('mousedown', e => {
					isDraggingScroll = true
					scrollThumb.classList.add('dragging') // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
					scrollDragStartY = e.clientY
					scrollThumbStartY = parseInt(scrollThumb.style.top || '0')
					e.preventDefault()

					document.addEventListener('mousemove', handleScrollMove)
					document.addEventListener('mouseup', handleScrollEnd)
				})

				const handleScrollMove = e => {
					if (!isDraggingScroll) return

					const deltaY = e.clientY - scrollDragStartY
					let newThumbPosition = scrollThumbStartY + deltaY

					// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª–∑—É–Ω–∫–∞
					const maxPosition =
						messagesWrapper.clientHeight - scrollThumb.offsetHeight
					newThumbPosition = Math.max(
						0,
						Math.min(maxPosition, newThumbPosition)
					)

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª–∑—É–Ω–∫–∞
					scrollThumb.style.top = `${newThumbPosition}px`

					// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
					const scrollRatio = newThumbPosition / maxPosition
					messagesWrapper.scrollTop =
						scrollRatio *
						(messagesWrapper.scrollHeight - messagesWrapper.clientHeight)
				}

				const handleScrollEnd = () => {
					isDraggingScroll = false
					scrollThumb.classList.remove('dragging') // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
					document.removeEventListener('mousemove', handleScrollMove)
					document.removeEventListener('mouseup', handleScrollEnd)
				}

				// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–±–ª–∞—Å—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞
				scrollbar.addEventListener('click', e => {
					if (e.target === scrollbar) {
						const rect = scrollbar.getBoundingClientRect()
						const clickPosition = e.clientY - rect.top
						const thumbHeight = scrollThumb.offsetHeight

						// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É –∫–ª–∏–∫–∞
						let newThumbPosition = clickPosition - thumbHeight / 2
						newThumbPosition = Math.max(
							0,
							Math.min(rect.height - thumbHeight, newThumbPosition)
						)
						scrollThumb.style.top = `${newThumbPosition}px`

						// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
						const scrollRatio = newThumbPosition / (rect.height - thumbHeight)
						messagesWrapper.scrollTop =
							scrollRatio *
							(messagesWrapper.scrollHeight - messagesWrapper.clientHeight)
					}
				})

				// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –∫–æ–ª–µ—Å–æ–º
				messagesWrapper.addEventListener('scroll', updateScrollThumb)

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–∑—É–Ω–æ–∫
				updateScrollThumb()

				// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
				window.addEventListener('resize', updateScrollThumb)

				// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
				const observer = new MutationObserver(updateScrollThumb)
				observer.observe(messagesWrapper, { childList: true, subtree: true })
			}
			function startOnlineStatusUpdates() {
				updateOnlineStatus()
				onlineStatusInterval = setInterval(updateOnlineStatus, 30000)
				window.addEventListener('beforeunload', updateOnlineStatus)
			}

			async function updateOnlineStatus() {
				try {
					await eel.update_last_online(localStorage.getItem('user_id'))()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω:', error)
				}
			}

			function closeLogoutModal() {
				document.getElementById('logout-overlay').classList.add('hidden')
				document.getElementById('logout-modal').classList.add('hidden')
			}

			function closeChat(softClose = false) {
				document.getElementById('default-content').classList.remove('hidden')
				document.getElementById('chat-container').classList.add('hidden')
				document.querySelectorAll('.user-bar').forEach(el => {
					el.classList.remove('active-chat')
				})

				stopVoiceMessage()
				currentPlayingAudio = null
				voiceMessagePlaying = false
				currentPlayingVoiceElement = null

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º currentChatUserId —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ softClose
				if (!softClose) {
					currentChatUserId = null
				}

				lastMessageId = null

				if (readStatusInterval) {
					clearInterval(readStatusInterval)
					readStatusInterval = null
				}
				if (statusUpdateInterval) {
					clearInterval(statusUpdateInterval)
					statusUpdateInterval = null
				}
			}

			async function restoreUserKey() {
				try {
					const storedSalt = localStorage.getItem('user_salt')
					if (!storedSalt) {
						console.log('–°–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage')
						return false
					}

					// –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ sessionStorage
					let userPassword = sessionStorage.getItem('user_password')
					if (!userPassword) {
						// –ï—Å–ª–∏ –ø–∞—Ä–æ–ª—è –Ω–µ—Ç, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –µ–≥–æ
						userPassword = prompt(
							'–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:'
						)
						if (!userPassword) {
							return false
						}
						// –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –≤ sessionStorage
						sessionStorage.setItem('user_password', userPassword)
					}

					// –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è base64 –≤ Uint8Array
					const saltBytes = Uint8Array.from(atob(storedSalt), c =>
						c.charCodeAt(0)
					)

					// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á
					userEncryptionKey = await zkCrypto.deriveKey(userPassword, saltBytes)

					// –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª—é—á
					const testResult = await testEncryptionKey()
					if (!testResult) {
						throw new Error('–ö–ª—é—á –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É')
					}

					console.log('ZK —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
					return true
				} catch (error) {
					console.error('Error restoring user key:', error)
					// –ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å –∑–∞–Ω–æ–≤–æ
					sessionStorage.removeItem('user_password')
					userEncryptionKey = null
					return false
				}
			}

			async function checkAndRestoreReplyState() {
				if (!currentChatUserId) return

				try {
					const replyState = await eel.get_reply_state(
						localStorage.getItem('user_id'),
						currentChatUserId
					)()
					if (replyState.success) {
						const message = await eel.get_message_data(replyState.message_id)()
						if (message) {
							const replyContainer = document.getElementById('reply-container')
							const isMyMessage =
								message.sender_id === localStorage.getItem('user_id')

							replyContainer.dataset.messageId = message.id
							replyContainer.innerHTML = `
                    <div class="reply-header">
                        <div class="reply-author">${
													isMyMessage
														? '–í—ã'
														: document.getElementById('chat-username')
																.textContent
												}</div>
                        <div class="reply-close">√ó</div>
                    </div>
                    <div class="reply-text">${
											message.text.length > 50
												? message.text.substring(0, 47) + '...'
												: message.text
										}</div>
                `

							replyContainer.classList.remove('hidden')
							document
								.querySelector('.message-input-container')
								.classList.add('expanded')

							// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Ç–≤–µ—Ç–∞
							replyContainer
								.querySelector('.reply-close')
								.addEventListener('click', async () => {
									replyContainer.classList.add('hidden')
									document
										.querySelector('.message-input-container')
										.classList.remove('expanded')
									await eel.clear_reply_state(
										localStorage.getItem('user_id'),
										currentChatUserId
									)()
								})
						}
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:', error)
				}
			}

			async function openChat(userId) {
				// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é ECDH –¥–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π
				if (userId === localStorage.getItem('user_id')) {
					const ecdhInitialized = await initializeECDHSystem()
					if (!ecdhInitialized) {
						alert(
							'–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π'
						)
						return
					}
				}

				// –ï—Å–ª–∏ —á–∞—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
				if (
					currentChatUserId === userId &&
					!document
						.getElementById('chat-container')
						.classList.contains('hidden')
				) {
					const messagesWrapper = document.getElementById(
						'chat-messages-wrapper'
					)
					if (messagesWrapper) {
						messagesWrapper.scrollTop =
							scrollPositions[userId] || messagesWrapper.scrollHeight
					}
					return
				}

				// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —á–∞—Ç–∞
				if (currentChatUserId) {
					const messagesWrapper = document.getElementById(
						'chat-messages-wrapper'
					)
					if (messagesWrapper) {
						scrollPositions[currentChatUserId] = messagesWrapper.scrollTop
					}

					const currentText = document.getElementById('message-input').value
					if (currentText.trim()) {
						await eel.save_draft_message(
							localStorage.getItem('user_id'),
							currentChatUserId,
							currentText
						)()
					}
					chatInputs[currentChatUserId] = currentText
				}

				// –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
				stopVoiceMessage()
				currentPlayingAudio = null
				voiceMessagePlaying = false
				currentPlayingVoiceElement = null

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –¥—Ä—É–≥–æ–π —á–∞—Ç
				const replyContainer = document.getElementById('reply-container')
				if (replyContainer && !replyContainer.classList.contains('hidden')) {
					replyContainer.classList.add('hidden')
					document
						.querySelector('.message-input-container')
						.classList.remove('expanded')
				}

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É –¥–∞—Ç
				dateHeaders.clear()
				currentStickyDate = null
				if (dateHeadersObserver) {
					dateHeadersObserver.disconnect()
					dateHeadersObserver = null
				}

				if (readStatusInterval) clearInterval(readStatusInterval)
				if (statusUpdateInterval) clearInterval(statusUpdateInterval)

				currentChatUserId = userId
				const user = await eel.get_user_data(userId)()

				if (user) {
					document.getElementById('default-content').classList.add('hidden')
					document.getElementById('chat-container').classList.remove('hidden')
					document.getElementById('chat-username').textContent =
						userId === localStorage.getItem('user_id')
							? '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ'
							: user.nickname
					await updateUserStatus()

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä
					initCustomScroll()

					// –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–ª–∏ —ç—Ç–æ –¥—Ä—É–≥–æ–π —á–∞—Ç
					if (!activeChats[userId] || currentChatUserId !== userId) {
						await loadZKChatHistory(userId)
					} else {
						// –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—Ä–æ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI
						document.getElementById('chat-messages').innerHTML =
							activeChats[userId].messages
						lastMessageId = activeChats[userId].lastMessageId

						// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∏–ª–∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
						setTimeout(() => {
							const messagesWrapper = document.getElementById(
								'chat-messages-wrapper'
							)
							if (messagesWrapper) {
								if (scrollPositions[userId] !== undefined) {
									messagesWrapper.scrollTop = scrollPositions[userId]
								} else {
									messagesWrapper.scrollTop = messagesWrapper.scrollHeight
								}
								// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –¥–∞—Ç –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
								initDateHeadersSystem()
								updateStickyDateHeaders()
							}
						}, 0)

						// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
						await updateListenIndicators()
						setupVoiceMessageHandlers()
					}

					// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –∏–ª–∏ –∏–∑ –∫–µ—à–∞
					const draftText = await eel.get_draft_message(
						localStorage.getItem('user_id'),
						userId
					)()
					document.getElementById('message-input').value =
						draftText || chatInputs[userId] || ''

					// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
					await checkAndRestoreReplyState()

					readStatusInterval = setInterval(updateReadStatus, 2000)
					updateReadStatus()

					statusUpdateInterval = setInterval(updateUserStatus, 5000)

					// –ü–æ–º–µ—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
					document.querySelectorAll('.user-bar').forEach(el => {
						el.classList.remove('active-chat')
					})
					const userCard = document.querySelector(
						`.user-bar[data-user-id="${userId}"]`
					)
					if (userCard) {
						userCard.classList.add('active-chat')
					}
				} else {
					console.error('User data not found for ID:', userId)
					document.getElementById('chat-messages').innerHTML =
						'<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>'
				}
			}

			async function preloadMediaForChat(userId) {
				if (!activeChats[userId]?.messagesData) return

				for (const message of activeChats[userId].messagesData) {
					if (message.isMedia && !message.mediaData) {
						try {
							const response = await eel.get_media_message(message.id)()
							if (response.success) {
								message.mediaData = response.media_data
							}
						} catch (error) {
							console.error('Error preloading media:', error)
						}
					}
				}
			}

			async function updateUserStatus() {
				if (!currentChatUserId) return

				try {
					const user = await eel.get_user_data(currentChatUserId)()
					if (!user) return

					const statusElement = document.getElementById('chat-status')
					const now = new Date()
					const lastOnline = new Date(user.last_online + ' UTC')

					const diffMinutes = Math.floor((now - lastOnline) / (1000 * 60))

					if (currentChatUserId === localStorage.getItem('user_id')) {
						statusElement.textContent = ''
						statusElement.classList.remove('online')
					} else if (diffMinutes < 5) {
						statusElement.textContent = '–í —Å–µ—Ç–∏'
						statusElement.classList.add('online')
					} else {
						statusElement.textContent = `–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏ ${formatTimeAgo(
							lastOnline
						)}`
						statusElement.classList.remove('online')
					}

					updateOnlineStatusInContacts()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error)
				}
			}

			function updateOnlineStatusInContacts() {
				const userBars = document.querySelectorAll(
					'.user-bar:not(.current-user)'
				)
				userBars.forEach(async bar => {
					const userId = bar.dataset.userId
					try {
						const user = await eel.get_user_data(userId)()
						if (user) {
							const now = new Date()
							const lastOnline = new Date(user.last_online + ' UTC')
							const diffMinutes = Math.floor((now - lastOnline) / (1000 * 60))

							const avatar = bar.querySelector('.avatar-medium')
							if (diffMinutes < 5) {
								avatar.classList.add('online')
							} else {
								avatar.classList.remove('online')
							}
						}
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞:', error)
					}
				})
			}

			function formatTimeAgo(date) {
				const now = new Date()
				const diff = Math.floor((now - date) / 1000)

				if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ'
				if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω. –Ω–∞–∑–∞–¥`
				if (diff < 86400) return `${Math.floor(diff / 3600)} —á. –Ω–∞–∑–∞–¥`

				const days = Math.floor(diff / 86400)
				if (days === 1) return '–≤—á–µ—Ä–∞'
				if (days < 7) return `${days} –¥–Ω. –Ω–∞–∑–∞–¥`

				return date.toLocaleDateString('ru-RU', {
					day: 'numeric',
					month: 'long',
					year: 'numeric',
				})
			}

			async function updateReadStatus() {
				if (!currentChatUserId) return

				try {
					const myMessages = Array.from(
						document.querySelectorAll('.my-message')
					)
						.map(el => el.dataset.id)
						.filter(id => id)

					if (myMessages.length === 0) return

					const readStatus = await eel.check_message_read_status(myMessages)()

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
					let listenedStatus = {}
					try {
						if (eel.check_voice_messages_listened_status) {
							listenedStatus = await eel.check_voice_messages_listened_status(
								myMessages
							)()
						}
					} catch (error) {
						console.warn('–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞')
					}

					for (const [messageId, isRead] of Object.entries(readStatus)) {
						const messageElement = document.querySelector(
							`.message[data-id="${messageId}"]`
						)
						if (messageElement) {
							// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
							const voiceMessage =
								messageElement.querySelector('.voice-message')
							if (!voiceMessage) {
								const infoElement =
									messageElement.querySelector('.message-info')
								if (infoElement) {
									const timeElement = infoElement.querySelector('span')
									if (timeElement) {
										infoElement.innerHTML = `${timeElement.outerHTML}${
											isRead ? '‚úì‚úì' : '‚úì'
										}`
									}
								}
							}

							// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
							if (voiceMessage) {
								const indicator =
									voiceMessage.querySelector('.listen-indicator')
								if (indicator) {
									const isListened = listenedStatus[messageId] || false
									indicator.style.opacity = isListened ? '0' : '0.7'
								}
							}
						}
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è:', error)
				}
			}

			async function loadChatHistory() {
				if (!currentChatUserId) return

				try {
					const messages = await eel.get_chat_history(
						localStorage.getItem('user_id'),
						currentChatUserId
					)()

					const chatMessages = document.getElementById('chatMessages')
					chatMessages.innerHTML = ''

					for (const msg of messages) {
						let displayText = msg.text

						// –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
						if (
							msg.is_encrypted &&
							msg.sender_id !== localStorage.getItem('user_id')
						) {
							displayText = await decryptMessageContent(msg.id)
						}

						displayMessage({
							...msg,
							text: displayText,
						})
					}

					scrollChatToBottom()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:', error)
				}
			}
			async function loadChatHistory(userId) {
				try {
					const messages = await eel.get_chat_history(
						localStorage.getItem('user_id'),
						userId
					)()
					const messagesContainer = document.getElementById('chat-messages')
					messagesContainer.innerHTML = ''

					// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
					dateHeaders.clear()
					currentStickyDate = null

					if (!activeChats[userId]) {
						activeChats[userId] = {
							messages: '',
							lastMessageId: null,
							messagesData: [],
						}
					}

					if (messages && Array.isArray(messages) && messages.length > 0) {
						messages.sort(
							(a, b) => new Date(a.timestamp) - new Date(b.timestamp)
						)

						const messagesData = []
						let currentDateKey = null

						for (const msg of messages) {
							const isMyMessage =
								msg.sender_id === localStorage.getItem('user_id')

							// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã
							const messageDate = new Date(msg.timestamp)
							const messageDateKey = messageDate.toDateString()

							if (messageDateKey !== currentDateKey) {
								const dateText = formatMessageDate(msg.timestamp)
								const dateHeader = createDateHeader(dateText, messageDateKey)
								messagesContainer.appendChild(dateHeader)
								dateHeaders.set(messageDateKey, dateHeader)
								currentDateKey = messageDateKey
							}

							const messageElement = await addMessageToChat(
								msg,
								isMyMessage,
								false
							)

							// –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
							if (msg.isMedia || msg.is_media) {
								messagesData.push({
									id: msg.id,
									isMedia: true,
									mediaType: msg.media_type,
									file_id: msg.file_id,
									filename: msg.filename,
									text: msg.text,
									mediaData: msg.mediaData,
								})
							} else if (msg.isVoiceMessage || msg.is_voice) {
								messagesData.push({
									id: msg.id,
									voiceData: msg.voice_data,
									duration: msg.duration,
									isVoiceMessage: true,
									listened: msg.listened || false,
								})
							} else {
								messagesData.push({
									id: msg.id,
									text: msg.text,
									sender_id: msg.sender_id,
									timestamp: msg.timestamp,
								})
							}
						}

						lastMessageId = messages[messages.length - 1].id

						activeChats[userId] = {
							messages: messagesContainer.innerHTML,
							lastMessageId: lastMessageId,
							messagesData: messagesData,
						}

						// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
						setTimeout(() => {
							initDateHeadersSystem()
							updateStickyDateHeaders()

							const messagesWrapper = document.getElementById(
								'chat-messages-wrapper'
							)
							if (messagesWrapper) {
								if (scrollPositions[userId] !== undefined) {
									messagesWrapper.scrollTop = scrollPositions[userId]
								} else {
									messagesWrapper.scrollTop = messagesWrapper.scrollHeight
								}
							}
						}, 0)

						setupVoiceMessageHandlers()
					} else {
						messagesContainer.innerHTML =
							'<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'
						lastMessageId = null
						activeChats[userId] = {
							messages: messagesContainer.innerHTML,
							lastMessageId: null,
							messagesData: [],
						}
					}
				} catch (error) {
					console.error('Error loading chat history:', error)
					document.getElementById('chat-messages').innerHTML =
						'<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>'
				}
			}

			function updateLastMessageOnUserCard(userId, messageText, isMyMessage) {
				const userCard = document.querySelector(
					`.user-bar[data-user-id="${userId}"]`
				)
				if (!userCard) return

				const lastMsgDiv = userCard.querySelector('.last-message')
				let displayText = messageText

				if (displayText.length > 25) {
					displayText = displayText.substring(0, 22) + '...'
				}

				if (isMyMessage) {
					if (lastMsgDiv) {
						lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
					} else {
						// –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –µ—â–µ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
						const contentWrapper = userCard.querySelector(
							'.user-content-wrapper'
						)
						if (contentWrapper) {
							const newLastMsgDiv = document.createElement('div')
							newLastMsgDiv.className = 'last-message'
							newLastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
							contentWrapper.appendChild(newLastMsgDiv)
						}
					}
				} else {
					if (lastMsgDiv) {
						lastMsgDiv.textContent = displayText
					} else {
						const contentWrapper = userCard.querySelector(
							'.user-content-wrapper'
						)
						if (contentWrapper) {
							const newLastMsgDiv = document.createElement('div')
							newLastMsgDiv.className = 'last-message'
							newLastMsgDiv.textContent = displayText
							contentWrapper.appendChild(newLastMsgDiv)
						}
					}
				}
			}

			async function addMessageToChat(
				message,
				isMyMessage,
				scrollToBottom = true
			) {
				const messagesContainer = document.getElementById('chat-messages')

				if (!messagesContainer) {
					console.error('Messages container not found')
					return null
				}

				// –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
				const noMessagesDiv = messagesContainer.querySelector('.no-messages')
				if (noMessagesDiv) {
					noMessagesDiv.remove()
				}

				if (!message) {
					console.error('Message is null or undefined')
					return null
				}

				// –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
				const messageElement = document.createElement('div')
				messageElement.className = `message ${
					isMyMessage ? 'my-message' : 'their-message'
				}`
				messageElement.dataset.id = message.id || ''
				messageElement.dataset.sender_id = message.sender_id || ''
				messageElement.dataset.timestamp =
					message.timestamp || new Date().toISOString()

				// –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
				const messageTimestamp = message.timestamp || new Date().toISOString()
				const dateKey = new Date(messageTimestamp).toDateString()
				const dateText = formatMessageDate(messageTimestamp)

				// –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
				if (!dateHeaders.has(dateKey)) {
					const dateHeader = createDateHeader(dateText, dateKey)

					try {
						messagesContainer.appendChild(dateHeader)
						dateHeaders.set(dateKey, dateHeader)
					} catch (error) {
						console.error('Error adding date header:', error)
					}
				}

				// –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ –°–û–û–ë–©–ï–ù–ò–Ø
				const messageContent = document.createElement('div')
				messageContent.className = 'message-content'

				const textElement = document.createElement('div')
				textElement.className = 'message-text'

				// –û–ë–†–ê–ë–û–¢–ö–ê –†–ê–ó–ù–´–• –¢–ò–ü–û–í –°–û–û–ë–©–ï–ù–ò–ô
				let displayText = message.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'

				// 1. –ú–µ–¥–∏–∞-—Å–æ–æ–±—â–µ–Ω–∏—è
				if (message.isMedia || message.is_media) {
					if (message.mediaType === 'video') {
						displayText = 'üé• [–í–∏–¥–µ–æ]'
					} else {
						displayText = 'üñºÔ∏è [–§–æ—Ç–æ]'
					}
					textElement.textContent = displayText
				}
				// 2. –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
				else if (message.isVoiceMessage || message.is_voice) {
					displayText = 'üé§ [–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
					textElement.textContent = displayText
				}
				// 3. –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
				else if (message.is_encrypted) {
					// –û–°–û–ë–´–ô –°–õ–£–ß–ê–ô: –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã
					if (
						isMyMessage &&
						message.sender_id === localStorage.getItem('user_id') &&
						message.receiver_id === localStorage.getItem('user_id') &&
						(message.encryption_type === 'zk_password' ||
							message.encryption_type === 'zk_password_aes') &&
						message.original_encrypted !== undefined
					) {
						// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–∂–µ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
						textElement.textContent = message.text

						// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
						const encryptionBadge = document.createElement('span')
						encryptionBadge.className = 'encryption-badge'
						encryptionBadge.textContent = ' üîê'
						encryptionBadge.title = 'ZK –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ'
						encryptionBadge.style.marginLeft = '5px'
						encryptionBadge.style.fontSize = '0.8em'
						textElement.appendChild(encryptionBadge)
					}
					// –î–ª—è —á—É–∂–∏—Ö –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
					else if (!isMyMessage) {
						if (
							message.encryption_type === 'zk_password' ||
							message.encryption_type === 'zk_password_aes'
						) {
							// –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –î–ï–®–ò–§–†–û–í–ê–ù–ò–ï ZK –°–û–û–ë–©–ï–ù–ò–ô –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
							textElement.textContent = 'üîê –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ...'
							textElement.style.color = '#666'
							textElement.style.fontStyle = 'italic'

							// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ—à–∏—Ñ—Ä—É–µ–º
							try {
								const decryptedText = await decryptZKMessage(message.id)
								textElement.textContent = decryptedText
								textElement.style.color = ''
								textElement.style.fontStyle = ''

								// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
								const encryptionBadge = document.createElement('span')
								encryptionBadge.className = 'encryption-badge'
								encryptionBadge.textContent = ' üîê'
								encryptionBadge.title = 'ZK –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ'
								encryptionBadge.style.marginLeft = '5px'
								encryptionBadge.style.fontSize = '0.8em'
								textElement.appendChild(encryptionBadge)
							} catch (error) {
								textElement.textContent = '‚ùå –û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è'
								textElement.style.color = '#ff4444'
								textElement.style.cursor = 'pointer'
								textElement.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏'

								// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
								textElement.addEventListener('click', async () => {
									textElement.textContent = 'üîê –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ...'
									textElement.style.color = '#666'

									try {
										const retryText = await decryptZKMessage(message.id)
										textElement.textContent = retryText
										textElement.style.color = ''
										textElement.style.cursor = ''
										textElement.title = ''

										// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
										const encryptionBadge = document.createElement('span')
										encryptionBadge.className = 'encryption-badge'
										encryptionBadge.textContent = ' üîê'
										encryptionBadge.title = 'ZK –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ'
										encryptionBadge.style.marginLeft = '5px'
										encryptionBadge.style.fontSize = '0.8em'
										textElement.appendChild(encryptionBadge)
									} catch (retryError) {
										textElement.textContent = '‚ùå –û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è'
										textElement.style.color = '#ff4444'
									}
								})
							}
						}
						// –†–£–ß–ù–û–ï –î–ï–®–ò–§–†–û–í–ê–ù–ò–ï ECDH –°–û–û–ë–©–ï–ù–ò–ô
						else if (
							message.encryption_type === 'ecdh' ||
							message.encryption_type === 'ecdh_aes'
						) {
							textElement.textContent = 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
							textElement.style.cursor = 'pointer'
							textElement.style.color = '#007bff'
							textElement.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è ECDH'

							textElement.addEventListener('click', async () => {
								textElement.textContent = 'üîí –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ECDH...'
								textElement.style.color = '#666'

								try {
									const decryptedText = await decryptMessageContent(message.id)
									textElement.textContent = decryptedText
									textElement.style.color = ''
									textElement.style.cursor = ''
									textElement.title = ''

									// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
									const encryptionBadge = document.createElement('span')
									encryptionBadge.className = 'encryption-badge'
									encryptionBadge.textContent = ' üîí'
									encryptionBadge.title = 'ECDH –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ'
									encryptionBadge.style.marginLeft = '5px'
									encryptionBadge.style.fontSize = '0.8em'
									textElement.appendChild(encryptionBadge)
								} catch (error) {
									textElement.textContent = '‚ùå –û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è ECDH'
									textElement.style.color = '#ff4444'
								}
							})
						}
						// –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –ó–ê–®–ò–§–†–û–í–ê–ù–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
						else {
							textElement.textContent = 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
							textElement.style.cursor = 'pointer'
							textElement.style.color = '#007bff'
							textElement.title = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è'

							textElement.addEventListener('click', async () => {
								textElement.textContent = 'üîí –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ...'
								textElement.style.color = '#666'

								try {
									const decryptedText = await decryptMessageContent(message.id)
									textElement.textContent = decryptedText
									textElement.style.color = ''
									textElement.style.cursor = ''
									textElement.title = ''

									// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
									const encryptionBadge = document.createElement('span')
									encryptionBadge.className = 'encryption-badge'
									encryptionBadge.textContent = ' üîí'
									encryptionBadge.title = '–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ'
									encryptionBadge.style.marginLeft = '5px'
									encryptionBadge.style.fontSize = '0.8em'
									textElement.appendChild(encryptionBadge)
								} catch (error) {
									textElement.textContent = '‚ùå –û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è'
									textElement.style.color = '#ff4444'
								}
							})
						}
					}
					// –î–ª—è —Å–≤–æ–∏—Ö –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–µ –≤ —á–∞—Ç–µ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π)
					else {
						textElement.textContent = message.text

						const encryptionBadge = document.createElement('span')
						encryptionBadge.className = 'encryption-badge'
						encryptionBadge.textContent =
							message.encryption_type === 'zk_password' ||
							message.encryption_type === 'zk_password_aes'
								? ' üîê'
								: ' üîí'
						encryptionBadge.title =
							message.encryption_type === 'zk_password' ||
							message.encryption_type === 'zk_password_aes'
								? 'ZK –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ'
								: 'ECDH –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ'
						encryptionBadge.style.marginLeft = '5px'
						encryptionBadge.style.fontSize = '0.8em'
						textElement.appendChild(encryptionBadge)
					}
				}
				// 4. –û–ë–´–ß–ù–´–ï –¢–ï–ö–°–¢–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø
				else {
					textElement.textContent = displayText
				}

				messageContent.appendChild(textElement)

				// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ (–≤—Ä–µ–º—è –∏ —Å—Ç–∞—Ç—É—Å)
				const infoElement = document.createElement('div')
				infoElement.className = 'message-info'

				const timeElement = document.createElement('span')
				timeElement.textContent = formatMessageTime(
					message.timestamp || new Date().toISOString()
				)
				infoElement.appendChild(timeElement)

				// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
				if (isMyMessage) {
					const readStatus = document.createElement('span')
					readStatus.textContent = message.read ? '‚úì‚úì' : '‚úì'
					readStatus.className = 'read-status'
					infoElement.appendChild(readStatus)
				}

				messageContent.appendChild(infoElement)
				messageElement.appendChild(messageContent)

				// –î–û–ë–ê–í–õ–Ø–ï–ú –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–Ø
				messageElement.addEventListener('contextmenu', e => {
					e.preventDefault()
					currentContextMessage = messageElement

					const isMyMessage =
						message.sender_id === localStorage.getItem('user_id')
					const isMediaMessage = message.isMedia || message.is_media
					const isVoiceMessage = message.isVoiceMessage || message.is_voice
					const isEncrypted = message.is_encrypted

					// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
					const contextMenu = document.getElementById('message-context-menu')
					if (contextMenu) {
						// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
						document
							.getElementById('message-edit')
							.classList.toggle(
								'hidden',
								!isMyMessage || isMediaMessage || isVoiceMessage || isEncrypted
							)

						// –£–¥–∞–ª–µ–Ω–∏–µ - —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Å–≤–æ–∏—Ö –∏ —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
						document
							.getElementById('message-delete')
							.classList.toggle('hidden', !isMyMessage)
						document
							.getElementById('message-delete-for-me')
							.classList.toggle('hidden', isMyMessage)

						// –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
						document
							.getElementById('message-pin')
							.classList.toggle('hidden', !isMyMessage || isVoiceMessage)

						// –û—Ç–≤–µ—Ç, –ø–µ—Ä–µ—Å—ã–ª–∫–∞, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ - –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
						document
							.getElementById('message-reply')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-forward')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-copy')
							.classList.toggle('hidden', false)

						// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
						showMessageContextMenu(e)
					}
				})

				// –î–û–ë–ê–í–õ–Ø–ï–ú –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–í–û–ô–ù–û–ì–û –ö–õ–ò–ö–ê –î–õ–Ø –ë–´–°–¢–†–û–ì–û –û–¢–í–ï–¢–ê
				messageElement.addEventListener('dblclick', () => {
					if (message.sender_id !== localStorage.getItem('user_id')) {
						handleQuickReply(message)
					}
				})

				// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
				try {
					messagesContainer.appendChild(messageElement)

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
					if (message.id) {
						if (!window.messageElements) {
							window.messageElements = new Map()
						}
						window.messageElements.set(message.id, messageElement)
					}
				} catch (error) {
					console.error('Error adding message to container:', error)
					return null
				}

				// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
				if (scrollToBottom) {
					setTimeout(() => {
						const messagesWrapper = document.getElementById(
							'chat-messages-wrapper'
						)
						if (messagesWrapper) {
							messagesWrapper.scrollTop = messagesWrapper.scrollHeight
							setTimeout(updateStickyDateHeaders, 100)
						}
					}, 0)
				}

				// –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–° –ü–†–û–°–õ–£–®–ò–í–ê–ù–ò–Ø –î–õ–Ø –ì–û–õ–û–°–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô
				if (message.isVoiceMessage || message.is_voice) {
					await updateVoiceMessageStatus(messageElement, message)
				}

				return messageElement
			}

			function handleQuickReply(message) {
				const messageText = message.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
				const messageInput = document.getElementById('message-input')
				messageInput.value = `> ${messageText}\n`
				messageInput.focus()

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∞
				const replyContainer = document.getElementById('reply-container')
				if (replyContainer) {
					const isMyMessage =
						message.sender_id === localStorage.getItem('user_id')

					replyContainer.innerHTML = `
            <div class="reply-header">
                <div class="reply-author">${
									isMyMessage ? '–í—ã' : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'
								}</div>
                <div class="reply-close">√ó</div>
            </div>
            <div class="reply-text">${
							messageText.length > 50
								? messageText.substring(0, 47) + '...'
								: messageText
						}</div>
        `

					replyContainer.classList.remove('hidden')
					document
						.querySelector('.message-input-container')
						.classList.add('expanded')

					// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Ç–≤–µ—Ç–∞
					replyContainer
						.querySelector('.reply-close')
						.addEventListener('click', () => {
							replyContainer.classList.add('hidden')
							document
								.querySelector('.message-input-container')
								.classList.remove('expanded')
							messageInput.value = ''
						})
				}
			}

			async function updateVoiceMessageStatus(messageElement, message) {
				// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
				const voiceElement = messageElement.querySelector('.voice-message')
				if (voiceElement) {
					const indicator = voiceElement.querySelector('.listen-indicator')
					if (indicator) {
						// –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
						// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—Å–ª—É—à–∞–Ω–æ
						indicator.style.opacity = message.listened ? '0' : '0.7'
					}
				}
			}

			function updateMessageReadStatus(messageId, isRead) {
				if (window.messageElements && window.messageElements.has(messageId)) {
					const messageElement = window.messageElements.get(messageId)
					const readStatus = messageElement.querySelector('.read-status')
					if (readStatus) {
						readStatus.textContent = isRead ? '‚úì‚úì' : '‚úì'
						readStatus.style.color = isRead ? '#4CAF50' : '#999'
					}
				}
			}

			function updateMessageText(messageId, newText) {
				if (window.messageElements && window.messageElements.has(messageId)) {
					const messageElement = window.messageElements.get(messageId)
					const textElement = messageElement.querySelector('.message-text')
					if (textElement) {
						textElement.textContent = newText

						// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const editBadge = document.createElement('span')
						editBadge.className = 'edit-badge'
						editBadge.textContent = ' (—Ä–µ–¥.)'
						editBadge.style.color = '#999'
						editBadge.style.fontSize = '0.8em'
						textElement.appendChild(editBadge)
					}
				}
			}

			async function checkForNewMessages() {
				if (!currentChatUserId) return

				try {
					const newMessages = await eel.check_new_messages(
						localStorage.getItem('user_id'),
						lastMessageId
					)()

					if (newMessages && newMessages.length > 0) {
						for (const msg of newMessages) {
							// –í–ê–ñ–ù–û: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏–∏
							// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏
							const existingMessage = document.querySelector(
								`.message[data-id="${msg.id}"]`
							)
							if (existingMessage) {
								console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', msg.id)
								continue
							}

							// –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ù–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è
							if (
								msg.sender_id === currentChatUserId &&
								msg.sender_id !== localStorage.getItem('user_id')
							) {
								await addMessageToChat(msg, false, true)
								// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ
								updateLastMessageOnUserCard(currentChatUserId, msg.text, false)
							}
						}

						if (newMessages.length > 0) {
							lastMessageId = newMessages[newMessages.length - 1].id
						}

						const messagesContainer = document.getElementById('chat-messages')
						activeChats[currentChatUserId] = {
							messages: messagesContainer.innerHTML,
							lastMessageId: lastMessageId,
						}

						updateOnlineStatusInContacts()

						// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
						setupVoiceMessageHandlers()
					}
				} catch (error) {
					console.error('Error checking new messages:', error)
				}
			}

			async function loadFriends() {
				const user_id = localStorage.getItem('user_id')
				console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user_id)

				try {
					currentUser = await eel.get_user_data(user_id)()
					console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã:', currentUser)

					const container = document.getElementById('user-container')
					if (!container) {
						console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω!')
						return
					}

					container.innerHTML = ''

					// –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π –ü–ï–†–í–û–ô
					const selfCard = createUserCard({
						user_id: user_id,
						nickname: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
						isCurrentUser: true,
						isSelfChat: true,
					})
					container.appendChild(selfCard)
					console.log('–ö–∞—Ä—Ç–æ—á–∫–∞ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" —Å–æ–∑–¥–∞–Ω–∞')

					// –î–æ–±–∞–≤–ª—è–µ–º –¥—Ä—É–∑–µ–π
					if (currentUser.friends && currentUser.friends.length > 0) {
						console.log('–ù–∞–π–¥–µ–Ω–æ –¥—Ä—É–∑–µ–π:', currentUser.friends.length)

						for (const friendId of currentUser.friends) {
							try {
								const friend = await eel.get_user_data(friendId)()
								if (friend) {
									// –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
									const lastMessage = await eel.get_last_message(
										user_id,
										friendId
									)()
									const friendCard = createUserCard({
										user_id: friendId,
										nickname: friend.nickname,
										isFriend: true,
										lastMessage: lastMessage,
									})
									container.appendChild(friendCard)
									console.log('–î–æ–±–∞–≤–ª–µ–Ω –¥—Ä—É–≥:', friend.nickname)
								}
							} catch (error) {
								console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–≥–∞:', friendId, error)
							}
						}

						updateOnlineStatusInContacts()
					} else {
						console.log('–î—Ä—É–∑–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ')
						const noFriends = document.createElement('div')
						noFriends.className = 'no-friends'
						noFriends.textContent =
							'–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π. –ù–∞–π–¥–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫!'
						container.appendChild(noFriends)
					}

					console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞')
				} catch (error) {
					console.error('Error loading friends:', error)
				}
			}

			function createUserCard(userData) {
				console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData)

				const card = document.createElement('div')
				card.className =
					'user-bar' + (userData.isCurrentUser ? ' current-user' : '')
				card.dataset.userId = userData.user_id

				const avatar = document.createElement('div')
				avatar.className = 'avatar-medium'

				// –†–∞–∑–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
				if (userData.isSelfChat) {
					avatar.style.backgroundImage =
						'url(https://cdn-icons-png.flaticon.com/512/1077/1077114.png)' // –ó–≤–µ–∑–¥–æ—á–∫–∞ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
					avatar.style.backgroundColor = '#4CAF50' // –ó–µ–ª–µ–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
				} else {
					avatar.style.backgroundImage =
						'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)' // –û–±—ã—á–Ω—ã–π –∞–≤–∞—Ç–∞—Ä
				}

				const contentWrapper = document.createElement('div')
				contentWrapper.className = 'user-content-wrapper'

				const username = document.createElement('div')
				username.className = 'username'

				// –†–∞–∑–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫
				if (userData.isSelfChat) {
					username.textContent = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ'
					username.style.fontWeight = 'bold'
					username.style.color = '#4CAF50'
				} else if (userData.isCurrentUser) {
					username.textContent = '–í—ã'
				} else {
					username.textContent = userData.nickname
				}

				contentWrapper.appendChild(username)

				// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
				if (userData.lastMessage && !userData.isCurrentUser) {
					const lastMsgDiv = document.createElement('div')
					lastMsgDiv.className = 'last-message'

					let messageText =
						userData.lastMessage.text || '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
					if (messageText.length > 25) {
						messageText = messageText.substring(0, 22) + '...'
					}

					if (
						userData.lastMessage.sender_id === localStorage.getItem('user_id')
					) {
						lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${messageText}`
					} else {
						lastMsgDiv.textContent = messageText
					}

					contentWrapper.appendChild(lastMsgDiv)
				}

				card.appendChild(avatar)
				card.appendChild(contentWrapper)

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
				card.addEventListener('click', function () {
					console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç —Å:', userData.user_id)
					openChat(userData.user_id)

					// –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–º—É
					document.querySelectorAll('.user-bar').forEach(el => {
						el.classList.remove('active-chat')
					})
					card.classList.add('active-chat')
				})

				// –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Ç–æ–ª—å–∫–æ –¥–ª—è –¥—Ä—É–∑–µ–π (–Ω–µ –¥–ª—è —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π)
				if (!userData.isSelfChat && !userData.isCurrentUser) {
					card.addEventListener('contextmenu', function (e) {
						e.preventDefault()
						showContextMenu(e, userData)
					})
				}

				console.log('–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
				return card
			}

			function showContextMenu(e, userData) {
				closeContextMenu()

				contextMenuTarget = userData.user_id

				const addBtn = document.getElementById('context-menu-add')
				const removeBtn = document.getElementById('context-menu-remove')

				if (currentUser.friends.includes(userData.user_id)) {
					addBtn.classList.add('hidden')
					removeBtn.classList.remove('hidden')
				} else {
					addBtn.classList.remove('hidden')
					removeBtn.classList.add('hidden')
				}

				contextMenu.style.display = 'block'
				contextMenu.style.left = `${e.pageX}px`
				contextMenu.style.top = `${e.pageY}px`
			}

			function closeContextMenu() {
				if (contextMenu) {
					contextMenu.style.display = 'none'
				}
				contextMenuTarget = null
			}

			async function handleAddFriend() {
				if (!contextMenuTarget) return

				const user_id = localStorage.getItem('user_id')
				try {
					const response = await eel.add_friend(user_id, contextMenuTarget)()

					if (response.success) {
						await loadFriends()
					}
					alert(response.message)
				} catch (error) {
					alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –¥—Ä—É–∑—å—è')
					console.error('Error adding friend:', error)
				}

				closeContextMenu()
			}

			async function handleRemoveFriend() {
				if (!contextMenuTarget) return

				const user_id = localStorage.getItem('user_id')
				try {
					const response = await eel.remove_friend(user_id, contextMenuTarget)()

					if (response.success) {
						await loadFriends()
						if (currentChatUserId === contextMenuTarget) {
							closeChat()
						}
					}
					alert(response.message)
				} catch (error) {
					alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –¥—Ä—É–∑–µ–π')
					console.error('Error removing friend:', error)
				}

				closeContextMenu()
			}

			async function displaySearchResults(users) {
				const container = document.getElementById('user-container')
				container.innerHTML = ''

				if (users.length === 0) {
					const noResults = document.createElement('div')
					noResults.className = 'no-results'
					noResults.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
					container.appendChild(noResults)
					return
				}

				for (const user of users) {
					const isFriend = currentUser.friends.includes(user.user_id)
					// –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
					const lastMessage = await eel.get_last_message(
						localStorage.getItem('user_id'),
						user.user_id
					)()
					const userCard = createUserCard({
						user_id: user.user_id,
						nickname: user.nickname, // –û—Ç–∫—Ä—ã—Ç—ã–π –Ω–∏–∫–Ω–µ–π–º
						isFriend: isFriend,
						lastMessage: lastMessage,
					})
					container.appendChild(userCard)
				}

				updateOnlineStatusInContacts()
			}

			function initButtonHandlers() {
				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
				const messageInput = document.getElementById('message-input')
				const sendButton = document.querySelector('.message-input-container')

				if (messageInput) {
					messageInput.addEventListener('keypress', async function (e) {
						if (e.key === 'Enter' && this.value.trim()) {
							await sendZKMessage(this.value.trim())
						}
					})
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
				const menuIcon = document.querySelector('.menu-icon')
				if (menuIcon) {
					menuIcon.addEventListener('click', function () {
						document.getElementById('logout-overlay').classList.remove('hidden')
						document.getElementById('logout-modal').classList.remove('hidden')
					})
				}

				console.log('Button handlers initialized')
			}

			// –í—ã–∑–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
			setTimeout(initButtonHandlers, 1000)

			function initMessageContextMenu() {
				console.log('initMessageContextMenu –≤—ã–∑–≤–∞–Ω–∞')
				const messageContextMenu = document.getElementById(
					'message-context-menu'
				)
				window.messageContextMenu = messageContextMenu // –î–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π

				// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
				document.addEventListener('click', function (e) {
					if (messageContextMenu && !messageContextMenu.contains(e.target)) {
						messageContextMenu.classList.add('hidden')
					}
				})

				// –í —Ñ—É–Ω–∫—Ü–∏–∏ initMessageContextMenu –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞:
				document.addEventListener('contextmenu', function (e) {
					const messageElement = e.target.closest('.message')
					if (messageElement) {
						e.preventDefault()
						currentContextMessage = messageElement

						const isVideoMessage =
							messageElement.querySelector('.video-preview') !== null
						const isVoiceMessage =
							messageElement.querySelector('.voice-message') !== null
						const isMyMessage = messageElement.classList.contains('my-message')

						// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
						document
							.getElementById('message-edit')
							.classList.toggle(
								'hidden',
								!isMyMessage || isVideoMessage || isVoiceMessage
							)
						document
							.getElementById('message-delete')
							.classList.toggle('hidden', !isMyMessage)
						document
							.getElementById('message-delete-for-me')
							.classList.toggle('hidden', isMyMessage)
						document
							.getElementById('message-pin')
							.classList.toggle('hidden', !isMyMessage || isVoiceMessage)
						document
							.getElementById('message-reply')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-forward')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-copy')
							.classList.toggle('hidden', false)

						// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é
						const menuWidth = messageContextMenu.offsetWidth
						const menuHeight = messageContextMenu.offsetHeight
						const windowWidth = window.innerWidth
						const windowHeight = window.innerHeight

						let left = e.clientX
						let top = e.clientY

						// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –º–µ–Ω—é –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
						if (left + menuWidth > windowWidth) {
							left = windowWidth - menuWidth - 5
						}

						if (top + menuHeight > windowHeight) {
							top = windowHeight - menuHeight - 5
						}

						messageContextMenu.style.left = `${left}px`
						messageContextMenu.style.top = `${top}px`
						messageContextMenu.style.display = 'block'
						messageContextMenu.classList.remove('hidden')

						// –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–µ–Ω—é –ø–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
						messageContextMenu.style.zIndex = '1000'
					}
				})

				// –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
				function closeMessageContextMenu() {
					if (messageContextMenu) {
						messageContextMenu.classList.add('hidden')
					}
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
				document
					.getElementById('message-reply')
					.addEventListener('click', function () {
						handleReply()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-edit')
					.addEventListener('click', function () {
						handleEdit()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-pin')
					.addEventListener('click', function () {
						handlePin()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-delete')
					.addEventListener('click', function () {
						handleDelete()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-forward')
					.addEventListener('click', function () {
						handleForward()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-copy')
					.addEventListener('click', function () {
						handleCopy()
						closeMessageContextMenu()
					})

				async function handleReply() {
					if (!currentContextMessage) return

					try {
						const messageText =
							currentContextMessage.querySelector('.message-text')
								?.textContent || '[–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
						const isMyMessage =
							currentContextMessage.classList.contains('my-message')
						const replyContainer = document.getElementById('reply-container')
						const messageId = currentContextMessage.dataset.id

						// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –ë–î –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
						await eel.save_reply_state(
							localStorage.getItem('user_id'),
							currentChatUserId,
							messageId
						)()

						// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—á–∞–µ–º
						replyContainer.dataset.messageId = messageId

						replyContainer.innerHTML = `
            <div class="reply-header">
                <div class="reply-author">${
									isMyMessage
										? '–í—ã'
										: document.getElementById('chat-username').textContent
								}</div>
                <div class="reply-close">√ó</div>
            </div>
            <div class="reply-text">${
							messageText.length > 50
								? messageText.substring(0, 47) + '...'
								: messageText
						}</div>
        `

						replyContainer.classList.remove('hidden')
						document
							.querySelector('.message-input-container')
							.classList.add('expanded')

						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Ç–≤–µ—Ç–∞
						replyContainer
							.querySelector('.reply-close')
							.addEventListener('click', async () => {
								replyContainer.classList.add('hidden')
								document
									.querySelector('.message-input-container')
									.classList.remove('expanded')
								// –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –ë–î –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
								await eel.clear_reply_state(
									localStorage.getItem('user_id'),
									currentChatUserId
								)()
							})

						const messageInput = document.getElementById('message-input')
						messageInput.focus()
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞:', error)
					}
				}

				function handleEdit() {
					if (!currentContextMessage) {
						messageContextMenu.classList.add('hidden')
						return
					}

					try {
						const messageId = currentContextMessage.dataset.id
						const messageTextElement =
							currentContextMessage.querySelector('.message-text')
						const originalText = messageTextElement.textContent

						// –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const input = document.createElement('input')
						input.type = 'text'
						input.value = originalText
						input.className = 'edit-message-input'

						// –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
						messageTextElement.replaceWith(input)
						input.focus()

						// –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const finishEditing = async newText => {
							if (newText && newText !== originalText) {
								const result = await eel.edit_message(messageId, newText)()
								if (!result.success) {
									throw new Error(
										result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'
									)
								}
								return newText
							}
							return originalText
						}

						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
						const handleKeyDown = async e => {
							if (e.key === 'Enter') {
								const newText = input.value.trim()
								try {
									const finalText = await finishEditing(newText)
									messageTextElement.textContent = finalText
								} catch (error) {
									alert(error.message)
									messageTextElement.textContent = originalText
								}
								cleanup()
							} else if (e.key === 'Escape') {
								messageTextElement.textContent = originalText
								cleanup()
							}
						}

						const handleBlur = async () => {
							const newText = input.value.trim()
							try {
								const finalText = await finishEditing(newText)
								messageTextElement.textContent = finalText
							} catch (error) {
								alert(error.message)
								messageTextElement.textContent = originalText
							}
							cleanup()
						}

						const cleanup = () => {
							input.replaceWith(messageTextElement)
							input.removeEventListener('keydown', handleKeyDown)
							input.removeEventListener('blur', handleBlur)
							messageContextMenu.classList.add('hidden')
						}

						input.addEventListener('keydown', handleKeyDown)
						input.addEventListener('blur', handleBlur)
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error)
						alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è')
						messageContextMenu.classList.add('hidden')
					}
				}

				function handlePin() {
					alert('–§—É–Ω–∫—Ü–∏—è "–ó–∞–∫—Ä–µ–ø–∏—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					messageContextMenu.classList.add('hidden')
				}

				eel.expose(get_current_user_id)
				function get_current_user_id() {
					return localStorage.getItem('user_id')
				}

				function handleForward() {
					alert('–§—É–Ω–∫—Ü–∏—è "–ü–µ—Ä–µ—Å–ª–∞—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					messageContextMenu.classList.add('hidden')
				}

				function handleCopy() {
					if (!currentContextMessage) {
						messageContextMenu.classList.add('hidden')
						return
					}

					try {
						const messageText =
							currentContextMessage.querySelector('.message-text').textContent
						navigator.clipboard
							.writeText(messageText)
							.then(() => {
								console.log('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞')
							})
							.catch(err => {
								console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err)
								alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç')
							})
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', error)
						alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞')
					} finally {
						messageContextMenu.classList.add('hidden')
					}
				}
			}

			function showMessageContextMenu(e) {
				const messageContextMenu = document.getElementById(
					'message-context-menu'
				)
				if (!messageContextMenu) return

				messageContextMenu.classList.add('hidden')

				const menuWidth = messageContextMenu.offsetWidth
				const menuHeight = messageContextMenu.offsetHeight
				const windowWidth = window.innerWidth
				const windowHeight = window.innerHeight

				let left = e.clientX
				let top = e.clientY

				if (left + menuWidth > windowWidth) {
					left = windowWidth - menuWidth - 5
				}

				if (top + menuHeight > windowHeight) {
					top = windowHeight - menuHeight - 5
				}

				messageContextMenu.style.left = `${left}px`
				messageContextMenu.style.top = `${top}px`
				messageContextMenu.style.display = 'block'
				messageContextMenu.classList.remove('hidden')
				messageContextMenu.style.zIndex = '1000'
			}

			// –°–¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π
			window.showMessageContextMenu = showMessageContextMenu

			// –í—ã–∑–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
			document.addEventListener('DOMContentLoaded', function () {
				initMessageContextMenu()
			})

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
			document.getElementById('message-reply').addEventListener('click', () => {
				if (currentContextMessage) {
					const messageText =
						currentContextMessage.querySelector('.message-text').textContent
					const messageInput = document.getElementById('message-input')
					messageInput.value = `–û—Ç–≤–µ—Ç –Ω–∞: "${messageText}" `
					messageInput.focus()
				}
				messageContextMenu.classList.add('hidden')
			})

			document
				.getElementById('message-edit')
				.addEventListener('click', async () => {
					if (currentContextMessage) {
						const messageId = currentContextMessage.dataset.id
						const messageText =
							currentContextMessage.querySelector('.message-text')
						const originalText = messageText.textContent

						// –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const input = document.createElement('input')
						input.type = 'text'
						input.value = originalText
						input.className = 'edit-message-input'

						// –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
						messageText.replaceWith(input)
						input.focus()

						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const handleEdit = async e => {
							if (e.key === 'Enter' || e.type === 'blur') {
								const newText = input.value.trim()
								if (newText && newText !== originalText) {
									try {
										const result = await eel.edit_message(messageId, newText)()
										if (result.success) {
											messageText.textContent = newText
										} else {
											alert(result.message)
											messageText.textContent = originalText
										}
									} catch (error) {
										console.error('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error)
										messageText.textContent = originalText
									}
								} else {
									messageText.textContent = originalText
								}

								input.replaceWith(messageText)
								input.removeEventListener('keydown', handleEdit)
								input.removeEventListener('blur', handleEdit)
							} else if (e.key === 'Escape') {
								messageText.textContent = originalText
								input.replaceWith(messageText)
								input.removeEventListener('keydown', handleEdit)
								input.removeEventListener('blur', handleEdit)
							}
						}

						input.addEventListener('keydown', handleEdit)
						input.addEventListener('blur', handleEdit)
					}
					messageContextMenu.classList.add('hidden')
				})

			document.getElementById('message-pin').addEventListener('click', () => {
				if (currentContextMessage) {
					alert('–§—É–Ω–∫—Ü–∏—è "–ó–∞–∫—Ä–µ–ø–∏—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
				}
				messageContextMenu.classList.add('hidden')
			})

			document
				.getElementById('message-delete')
				.addEventListener('click', async () => {
					if (currentContextMessage) {
						if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
							const messageId = currentContextMessage.dataset.id
							try {
								const result = await eel.delete_message(messageId)()
								if (result.success) {
									currentContextMessage.remove()
								} else {
									alert(result.message)
								}
							} catch (error) {
								console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error)
								alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è')
							}
						}
					}
					messageContextMenu.classList.add('hidden')
				})

			document
				.getElementById('message-forward')
				.addEventListener('click', () => {
					if (currentContextMessage) {
						alert('–§—É–Ω–∫—Ü–∏—è "–ü–µ—Ä–µ—Å–ª–∞—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					}
					messageContextMenu.classList.add('hidden')
				})

			document.getElementById('message-copy').addEventListener('click', () => {
				if (currentContextMessage) {
					const messageText =
						currentContextMessage.querySelector('.message-text').textContent
					navigator.clipboard
						.writeText(messageText)
						.then(() => {
							// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
							console.log('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')
						})
						.catch(err => {
							console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err)
						})
				}
				messageContextMenu.classList.add('hidden')
			})

			// –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
			const style = document.createElement('style')
			style.textContent = `
    .edit-message-input {
        width: 100%;
        padding: 5px;
        border: 1px solid #4CAF50;
        border-radius: 4px;
        font-size: 14px;
    }
`
			document.head.appendChild(style)

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–µ–Ω—é —Ñ–æ—Ç–æ
			const photoBtn = document.getElementById('photo-message-btn')
			const photoOptionsMenu = document.getElementById('photo-options-menu')
			const fileInput = document.getElementById('file-input')
			const mediaSendModal = document.getElementById('media-send-modal')
			const mediaSendOverlay = document.getElementById('media-send-overlay')
			const mediaSendTitle = document.getElementById('media-send-title')
			const imagePreview = document.getElementById('image-preview')
			const videoPreview = document.getElementById('video-preview')
			const mediaCaptionInput = document.getElementById('media-caption-input')
			const mediaAddButton = document.getElementById('media-add-button')
			const mediaCancelButton = document.getElementById('media-cancel-button')
			const mediaSendButton = document.getElementById('media-send-button')

			let currentMediaType = 'photo'
			let photoMenuTimeout

			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
			photoBtn.addEventListener('mouseenter', () => {
				clearTimeout(photoMenuTimeout)
				positionPhotoMenu()
				photoOptionsMenu.classList.remove('hidden')
				photoOptionsMenu.classList.add('show')
			})

			// –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –∫–Ω–æ–ø–∫–∏ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
			photoBtn.addEventListener('mouseleave', () => {
				photoMenuTimeout = setTimeout(() => {
					photoOptionsMenu.classList.remove('show')
				}, 200)
			})

			// –û—Ç–º–µ–Ω—è–µ–º —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –º–µ–Ω—é
			photoOptionsMenu.addEventListener('mouseenter', () => {
				clearTimeout(photoMenuTimeout)
			})

			// –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –Ω–µ–≥–æ
			photoOptionsMenu.addEventListener('mouseleave', () => {
				photoOptionsMenu.classList.remove('show')
			})

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
			document.querySelectorAll('.photo-option').forEach(option => {
				option.addEventListener('click', function () {
					const type = this.dataset.type
					if (type === 'photo-video') {
						openFileSelector()
					} else {
						alert(`–í—ã–±—Ä–∞–Ω–∞ –æ–ø—Ü–∏—è: ${this.querySelector('span').textContent}`)
					}
					photoOptionsMenu.classList.remove('show')
				})
			})

			function formatMessageDate(timestamp) {
				const messageDate = new Date(timestamp)
				const today = new Date()
				const yesterday = new Date(today)
				yesterday.setDate(yesterday.getDate() - 1)
				const twoDaysAgo = new Date(today)
				twoDaysAgo.setDate(twoDaysAgo.getDate() - 2)

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–∞—Ç
				const messageDateOnly = new Date(
					messageDate.getFullYear(),
					messageDate.getMonth(),
					messageDate.getDate()
				)
				const todayOnly = new Date(
					today.getFullYear(),
					today.getMonth(),
					today.getDate()
				)
				const yesterdayOnly = new Date(
					yesterday.getFullYear(),
					yesterday.getMonth(),
					yesterday.getDate()
				)
				const twoDaysAgoOnly = new Date(
					twoDaysAgo.getFullYear(),
					twoDaysAgo.getMonth(),
					twoDaysAgo.getDate()
				)

				if (messageDateOnly.getTime() === todayOnly.getTime()) {
					return '–°–µ–≥–æ–¥–Ω—è'
				} else if (messageDateOnly.getTime() === yesterdayOnly.getTime()) {
					return '–í—á–µ—Ä–∞'
				} else if (messageDateOnly.getTime() === twoDaysAgoOnly.getTime()) {
					return '–ü–æ–∑–∞–≤—á–µ—Ä–∞'
				} else {
					// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –¥–∞—Ç–∞ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
					const startOfWeek = new Date(today)
					startOfWeek.setDate(today.getDate() - today.getDay())
					startOfWeek.setHours(0, 0, 0, 0)

					if (messageDate >= startOfWeek) {
						// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
						const days = [
							'–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ',
							'–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
							'–í—Ç–æ—Ä–Ω–∏–∫',
							'–°—Ä–µ–¥–∞',
							'–ß–µ—Ç–≤–µ—Ä–≥',
							'–ü—è—Ç–Ω–∏—Ü–∞',
							'–°—É–±–±–æ—Ç–∞',
						]
						return days[messageDate.getDay()]
					} else {
						// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –¥–∞—Ç—É
						const months = [
							'—è–Ω–≤–∞—Ä—è',
							'—Ñ–µ–≤—Ä–∞–ª—è',
							'–º–∞—Ä—Ç–∞',
							'–∞–ø—Ä–µ–ª—è',
							'–º–∞—è',
							'–∏—é–Ω—è',
							'–∏—é–ª—è',
							'–∞–≤–≥—É—Å—Ç–∞',
							'—Å–µ–Ω—Ç—è–±—Ä—è',
							'–æ–∫—Ç—è–±—Ä—è',
							'–Ω–æ—è–±—Ä—è',
							'–¥–µ–∫–∞–±—Ä—è',
						]
						return `${messageDate.getDate()} ${
							months[messageDate.getMonth()]
						} ${messageDate.getFullYear()}`
					}
				}
			}

			function createDateHeader(dateText, dateKey) {
				const dateHeader = document.createElement('div')
				dateHeader.className = 'date-header'
				dateHeader.dataset.dateKey = dateKey

				const dateContent = document.createElement('div')
				dateContent.className = 'date-header-content'
				dateContent.textContent = dateText

				dateHeader.appendChild(dateContent)
				return dateHeader
			}

			function addDateHeaderToMessage(messageElement, timestamp) {
				const dateKey = new Date(timestamp).toDateString() // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã
				const dateText = formatMessageDate(timestamp)

				// –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
				if (dateHeaders.has(dateKey)) {
					return
				}

				const dateHeader = createDateHeader(dateText, dateKey)
				dateHeaders.set(dateKey, dateHeader)

				// –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–µ—Ä–µ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
				const messagesContainer = document.getElementById('chat-messages')
				messagesContainer.insertBefore(dateHeader, messageElement)
			}

			function updateStickyDateHeaders() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				if (!messagesWrapper) return

				const scrollTop = messagesWrapper.scrollTop
				const dateHeaderElements = Array.from(
					document.querySelectorAll('.date-header')
				)

				let newStickyDate = null

				// –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–¥–∏–º—ã–π –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏)
				for (let i = dateHeaderElements.length - 1; i >= 0; i--) {
					const header = dateHeaderElements[i]
					const rect = header.getBoundingClientRect()
					const messagesWrapperRect = messagesWrapper.getBoundingClientRect()

					// –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
					if (
						rect.top <= messagesWrapperRect.top + 60 &&
						rect.bottom > messagesWrapperRect.top
					) {
						newStickyDate = header
						break
					}
				}

				// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
				if (!newStickyDate && dateHeaderElements.length > 0) {
					newStickyDate = dateHeaderElements[0]
				}

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ sticky –∫–ª–∞—Å—Å—ã
				dateHeaderElements.forEach(header => {
					header.classList.remove('sticky')
				})

				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π sticky –∑–∞–≥–æ–ª–æ–≤–æ–∫
				if (newStickyDate && newStickyDate !== currentStickyDate) {
					newStickyDate.classList.add('sticky')
					currentStickyDate = newStickyDate
				} else if (!newStickyDate) {
					currentStickyDate = null
				}
			}

			function initDateHeadersSystem() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				if (!messagesWrapper) return

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
				messagesWrapper.addEventListener('scroll', updateStickyDateHeaders)

				// Intersection Observer –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
				dateHeadersObserver = new IntersectionObserver(
					entries => {
						entries.forEach(entry => {
							if (entry.isIntersecting) {
								// –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–∏–º—ã–º, —Å–Ω–∏–º–∞–µ–º sticky
								if (entry.target.classList.contains('sticky')) {
									entry.target.classList.remove('sticky')
								}
							}
						})
					},
					{
						root: messagesWrapper,
						threshold: 1.0,
					}
				)

				// –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –≤—Å–µ–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
				document.querySelectorAll('.date-header').forEach(header => {
					dateHeadersObserver.observe(header)
				})
			}

			// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–Ω–æ–ø–∫–∏
			function positionPhotoMenu() {
				const rect = photoBtn.getBoundingClientRect()
				photoOptionsMenu.style.left = `${rect.left}px`
				photoOptionsMenu.style.bottom = `${
					window.innerHeight - rect.top + 10
				}px`
			}

			// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
			window.addEventListener('resize', positionPhotoMenu)

			const KEY_STORAGE_KEY = 'user_encryption_key'
			const KEY_EXPIRY_TIME = 24 * 60 * 60 * 1000 // 24 —á–∞—Å–∞

			async function testEncryptionKey() {
				try {
					const testText = 'test message'
					console.log('Testing encryption key with text:', testText)

					// –®–∏—Ñ—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º ZKEncryption, –∞ –Ω–µ zkCrypto
					const encrypted = await ZKEncryption.encryptText(
						testText,
						userEncryptionKey
					)
					console.log('Text encrypted successfully')

					// –î–µ—à–∏—Ñ—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ
					const decrypted = await ZKEncryption.decryptText(
						encrypted,
						userEncryptionKey
					)
					console.log('Text decrypted successfully:', decrypted)

					const result = decrypted === testText
					console.log('Key test result:', result)

					return result
				} catch (error) {
					console.error('Key test failed:', error)
					return false
				}
			}

			async function requestPasswordAndInitialize() {
				try {
					const userPassword = prompt(
						'–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:'
					)
					if (!userPassword) {
						alert('–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞')
						return false
					}

					const success = await initializeUserKey(userPassword)
					if (success) {
						// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –≤ localStorage
						await saveEncryptionKey()
						return true
					}
					return false
				} catch (error) {
					console.error('Error in password initialization:', error)
					return false
				}
			}

			async function saveEncryptionKey() {
				try {
					if (!userEncryptionKey) return false

					// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á –≤ raw —Ñ–æ—Ä–º–∞—Ç
					const exportedKey = await crypto.subtle.exportKey(
						'raw',
						userEncryptionKey
					)
					const keyBytes = new Uint8Array(exportedKey)
					const keyBase64 = btoa(String.fromCharCode(...keyBytes))

					const keyData = {
						userId: localStorage.getItem('user_id'),
						key: keyBase64,
						timestamp: Date.now(),
					}

					localStorage.setItem(KEY_STORAGE_KEY, JSON.stringify(keyData))
					return true
				} catch (error) {
					console.error('Error saving encryption key:', error)
					return false
				}
			}

			async function initializeUserKey(password) {
				try {
					const user_id = localStorage.getItem('user_id')
					if (!user_id) {
						throw new Error('User ID not found')
					}

					// –ü–æ–ª—É—á–∞–µ–º —Å–æ–ª—å —Å —Å–µ—Ä–≤–µ—Ä–∞
					const saltResponse = await eel.get_user_salt(user_id)()
					if (!saltResponse.success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')
					}

					// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–ª—å
					const saltBytes = Uint8Array.from(atob(saltResponse.salt), c =>
						c.charCodeAt(0)
					)

					// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á —Å –ø–æ–º–æ—â—å—é Web Crypto API
					const encoder = new TextEncoder()
					const keyMaterial = await crypto.subtle.importKey(
						'raw',
						encoder.encode(password),
						'PBKDF2',
						false,
						['deriveKey']
					)

					userEncryptionKey = await crypto.subtle.deriveKey(
						{
							name: 'PBKDF2',
							salt: saltBytes,
							iterations: 100000,
							hash: 'SHA-256',
						},
						keyMaterial,
						{ name: 'AES-GCM', length: 256 },
						false,
						['encrypt', 'decrypt']
					)

					// –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª—é—á
					const testResult = await testEncryptionKey()
					if (!testResult) {
						throw new Error('–ö–ª—é—á –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É')
					}

					console.log('ZK —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
					return true
				} catch (error) {
					console.error('Error initializing user key:', error)
					userEncryptionKey = null
					return false
				}
			}

			async function loadZKChatHistory(userId) {
				// –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —á–∞—Ç
				if (window.isLoadingChat === userId) {
					console.log('–ß–∞—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', userId)
					return
				}

				try {
					window.isLoadingChat = userId // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏

					console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId)
					const messages = await eel.get_chat_history(
						localStorage.getItem('user_id'),
						userId
					)()
					console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π:', messages ? messages.length : 0)

					const messagesContainer = document.getElementById('chat-messages')
					messagesContainer.innerHTML = ''

					dateHeaders.clear()
					currentStickyDate = null
					if (dateHeadersObserver) {
						dateHeadersObserver.disconnect()
						dateHeadersObserver = null
					}

					if (messages && Array.isArray(messages) && messages.length > 0) {
						messages.sort(
							(a, b) => new Date(a.timestamp) - new Date(b.timestamp)
						)

						let currentDateKey = null

						for (const msg of messages) {
							const isMyMessage =
								msg.sender_id === localStorage.getItem('user_id')

							console.log(
								'–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:',
								msg.id,
								'is_encrypted:',
								msg.is_encrypted,
								'encryption_type:',
								msg.encryption_type
							)

							// –û–°–û–ë–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ß–ê–¢–ê –° –°–ê–ú–ò–ú –°–û–ë–û–ô - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –î–ï–®–ò–§–†–û–í–ê–ù–ò–ï
							if (
								userId === localStorage.getItem('user_id') &&
								msg.is_encrypted
							) {
								if (
									msg.encryption_type === 'zk_password_aes' ||
									msg.encryption_type === 'zk_password'
								) {
									console.log(
										'–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ZK —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π'
									)

									try {
										// –î–µ—à–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
										const decryptedText = await decryptZKMessage(msg.id)
										console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ:', decryptedText)

										// –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é —Å–æ–æ–±—â–µ–Ω–∏—è —Å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
										const displayMessage = {
											...msg,
											text: decryptedText,
											is_encrypted: false, // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ
											original_encrypted: true, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ –±—ã–ª–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ
										}

										// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã
										const messageDate = new Date(displayMessage.timestamp)
										const messageDateKey = messageDate.toDateString()

										if (messageDateKey !== currentDateKey) {
											const dateText = formatMessageDate(
												displayMessage.timestamp
											)
											const dateHeader = createDateHeader(
												dateText,
												messageDateKey
											)
											messagesContainer.appendChild(dateHeader)
											dateHeaders.set(messageDateKey, dateHeader)
											currentDateKey = messageDateKey
										}

										await addMessageToChat(displayMessage, isMyMessage, false)
										continue // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
									} catch (error) {
										console.warn(
											'–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:',
											error
										)
										// –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
									}
								}
							}

							// –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–µ ZK –∏–ª–∏ –Ω–µ—É–¥–∞—á–Ω–æ–µ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ)
							// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã
							const messageDate = new Date(msg.timestamp)
							const messageDateKey = messageDate.toDateString()

							if (messageDateKey !== currentDateKey) {
								const dateText = formatMessageDate(msg.timestamp)
								const dateHeader = createDateHeader(dateText, messageDateKey)
								messagesContainer.appendChild(dateHeader)
								dateHeaders.set(messageDateKey, dateHeader)
								currentDateKey = messageDateKey
							}

							await addMessageToChat(msg, isMyMessage, false)
						}

						// –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º lastMessageId —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
						lastMessageId = messages[messages.length - 1].id
						console.log('Last message ID —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', lastMessageId)

						// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞
						activeChats[userId] = {
							messages: messagesContainer.innerHTML,
							lastMessageId: lastMessageId,
							messagesData: messages,
						}

						setTimeout(() => {
							initDateHeadersSystem()
							updateStickyDateHeaders()

							const messagesWrapper = document.getElementById(
								'chat-messages-wrapper'
							)
							if (messagesWrapper) {
								messagesWrapper.scrollTop = messagesWrapper.scrollHeight
							}
						}, 0)
					} else {
						messagesContainer.innerHTML =
							'<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'
						lastMessageId = null
						activeChats[userId] = {
							messages: messagesContainer.innerHTML,
							lastMessageId: null,
							messagesData: [],
						}
					}
				} catch (error) {
					console.error('Error loading chat history:', error)
					document.getElementById('chat-messages').innerHTML =
						'<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>'
				} finally {
					// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
					window.isLoadingChat = null
				}
			}

			// –î–æ–±–∞–≤—å—Ç–µ –≤ DOMContentLoaded –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ECDH
			async function verifyEncryptionSystem() {
				try {
					const userId = localStorage.getItem('user_id')
					const result = await eel.verify_encryption_system(userId)()

					if (!result.success) {
						console.warn('–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', result.message)
						// –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
						await repairEncryptionSystem()
					} else {
						console.log('–°–∏—Å—Ç–µ–º–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error)
				}
			}

			// –í—ã–∑–æ–≤–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Å–ª–µ initializeECDHSystem()
			setTimeout(verifyEncryptionSystem, 1000)

			async function decryptZKMessage(messageId) {
				try {
					const userId = localStorage.getItem('user_id')

					console.log('–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è', messageId, '—Å –ø–∞—Ä–æ–ª–µ–º –∞–∫–∫–∞—É–Ω—Ç–∞')

					const messageResponse = await eel.decrypt_zk_message(
						userId,
						messageId
					)()

					if (messageResponse.success) {
						console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ')
						return messageResponse.decrypted_text
					} else {
						console.error(
							'–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:',
							messageResponse.message
						)
						throw new Error(
							messageResponse.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'
						)
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è ZK —Å–æ–æ–±—â–µ–Ω–∏—è:', error)

					// –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
					if (
						error.message.includes('–ø–∞—Ä–æ–ª') ||
						error.message.includes('password')
					) {
						throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è')
					} else if (
						error.message.includes('—Å–æ–ª—å') ||
						error.message.includes('salt')
					) {
						throw new Error('–û—à–∏–±–∫–∞ —Å–æ–ª–∏ –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è')
					} else {
						throw new Error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: ' + error.message)
					}
				}
			}

			async function reinitializeEncryptionSystem() {
				try {
					// –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
					sessionStorage.removeItem('user_password')
					localStorage.removeItem('user_salt')
					userEncryptionKey = null

					// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å –∑–∞–Ω–æ–≤–æ
					const userPassword = prompt(
						'–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:'
					)
					if (!userPassword) {
						throw new Error('–ü–∞—Ä–æ–ª—å –Ω–µ –≤–≤–µ–¥–µ–Ω')
					}

					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –∑–∞–Ω–æ–≤–æ
					const success = await initializeZKSystem()
					if (!success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
					}

					alert('–°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
					return true
				} catch (error) {
					console.error('Error reinitializing encryption system:', error)
					alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message)
					return false
				}
			}

			async function sendZKMediaMessage(file, caption = '') {
				if (!currentChatUserId || !userEncryptionKey) {
					throw new Error('–°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞')
				}

				try {
					// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
					showMediaUploadProgress(`–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: ${file.name}`, 10)

					// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
					const MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB
					if (file.size > MAX_FILE_SIZE) {
						hideMediaUploadProgress()
						alert(
							`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ${
								MAX_FILE_SIZE / 1024 / 1024
							}MB`
						)
						return false
					}

					console.log(
						'–ù–∞—á–∞–ª–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:',
						file.name,
						'—Ä–∞–∑–º–µ—Ä:',
						file.size
					)

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
					updateMediaUploadProgress(`–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: ${file.name}`, 30)

					// –®–∏—Ñ—Ä—É–µ–º —Ñ–∞–π–ª —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
					let encryptedMediaData
					try {
						encryptedMediaData = await zkCrypto.encryptFile(
							file,
							userEncryptionKey
						)
					} catch (encryptError) {
						console.error('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', encryptError)

						// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–≤—è–∑–∞–Ω–∞ –ª–∏ –æ—à–∏–±–∫–∞ —Å –∫–ª—é—á–æ–º
						if (
							encryptError.message.includes('key') ||
							encryptError.message.includes('Key')
						) {
							// –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É
							const reinitSuccess = await initializeZKSystem()
							if (reinitSuccess) {
								// –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
								encryptedMediaData = await zkCrypto.encryptFile(
									file,
									userEncryptionKey
								)
							} else {
								throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
							}
						} else {
							throw new Error(
								`–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞: ${encryptError.message}`
							)
						}
					}

					console.log('–§–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...')

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
					updateMediaUploadProgress(`–û—Ç–ø—Ä–∞–≤–∫–∞: ${file.name}`, 70)

					const fileType = file.type.startsWith('video/') ? 'video' : 'image'

					const result = await eel.send_media_message(
						localStorage.getItem('user_id'),
						currentChatUserId,
						encryptedMediaData,
						fileType,
						file.name,
						caption
					)()

					if (result.success) {
						console.log('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω')

						// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
						const message = {
							id: result.message_id,
							sender_id: localStorage.getItem('user_id'),
							receiver_id: currentChatUserId,
							text: caption || (fileType === 'video' ? '[–í–∏–¥–µ–æ]' : '[–§–æ—Ç–æ]'),
							timestamp: result.timestamp,
							read: result.read,
							isMedia: true,
							mediaType: fileType,
							is_encrypted: true,
						}

						await addMessageToChat(message, true, true)
						lastMessageId = message.id

						// –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
						if (activeChats[currentChatUserId]) {
							const messagesContainer = document.getElementById('chat-messages')
							activeChats[currentChatUserId].messages =
								messagesContainer.innerHTML
							activeChats[currentChatUserId].lastMessageId = lastMessageId

							if (!activeChats[currentChatUserId].messagesData) {
								activeChats[currentChatUserId].messagesData = []
							}

							activeChats[currentChatUserId].messagesData.push({
								id: message.id,
								isMedia: true,
								mediaType: fileType,
								text: message.text,
								filename: file.name,
							})
						}

						// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ 100% –∏ —Å–∫—Ä—ã–≤–∞–µ–º
						updateMediaUploadProgress(file.name, 100)
						setTimeout(hideMediaUploadProgress, 1000)

						return true // –í–ê–ñ–ù–û: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
					} else {
						throw new Error(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞')
					}
				} catch (error) {
					console.error('Error sending ZK media message:', error)
					hideMediaUploadProgress()

					if (error.message && error.message.includes('File too large')) {
						alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB')
					} else if (error.message.includes('Maximum call stack')) {
						alert(
							'–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.'
						)
					} else {
						alert(
							'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞: ' +
								(error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
						)
					}
					return false
				}
			}

			async function initializeUserKey(password) {
				try {
					const user_id = localStorage.getItem('user_id')
					if (!user_id) {
						throw new Error('User ID not found')
					}

					// –ü–æ–ª—É—á–∞–µ–º —Å–æ–ª—å —Å —Å–µ—Ä–≤–µ—Ä–∞
					const saltResponse = await eel.get_user_salt(user_id)()
					if (!saltResponse.success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')
					}

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–ª—å –≤ localStorage
					localStorage.setItem('user_salt', saltResponse.salt)

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –≤ sessionStorage
					sessionStorage.setItem('user_password', password)

					// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–ª—å
					const saltBytes = Uint8Array.from(atob(saltResponse.salt), c =>
						c.charCodeAt(0)
					)

					// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á
					userEncryptionKey = await zkCrypto.deriveKey(password, saltBytes)

					// –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª—é—á
					const testResult = await testEncryptionKey()
					if (!testResult) {
						throw new Error('–ö–ª—é—á –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç')
					}

					localStorage.setItem('zk_initialized', 'true')
					console.log('ZK —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
					return true
				} catch (error) {
					console.error('Error initializing user key:', error)
					// –û—á–∏—â–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
					localStorage.removeItem('zk_initialized')
					localStorage.removeItem('user_salt')
					sessionStorage.removeItem('user_password')
					userEncryptionKey = null
					return false
				}
			}
		</script>
		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
		<div class="modal-overlay hidden" id="delete-message-overlay"></div>
		<div class="delete-message-modal hidden" id="delete-message-modal">
			<button class="modal-close-btn" id="delete-message-close-btn">√ó</button>
			<div class="delete-message-text">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
			<div class="delete-message-buttons">
				<button
					class="delete-message-button delete-for-all"
					id="delete-for-all-btn"
				>
					–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö
				</button>
				<button
					class="delete-message-button delete-for-me"
					id="delete-for-me-btn"
				>
					–¢–æ–ª—å–∫–æ —É –º–µ–Ω—è
				</button>
			</div>
			<button class="delete-message-cancel" id="delete-message-cancel-btn">
				–û—Ç–º–µ–Ω–∞
			</button>
		</div>
	</body>
</html>
