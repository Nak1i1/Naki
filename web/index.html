<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<div class="media-send-overlay hidden" id="media-send-overlay"></div>
		<div class="media-send-modal hidden" id="media-send-modal">
			<div class="media-send-title" id="media-send-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞</div>
			<div class="media-preview-grid" id="media-preview-grid"></div>

			<input
				type="text"
				class="media-caption-input"
				id="media-caption-input"
				placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"
			/>

			<div class="media-send-buttons">
				<button class="media-send-button add" id="media-add-button">
					–î–æ–±–∞–≤–∏—Ç—å
				</button>
				<button class="media-send-button cancel" id="media-cancel-button">
					–û—Ç–º–µ–Ω–∞
				</button>
				<button class="media-send-button send" id="media-send-button">
					–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ
				</button>
			</div>
		</div>
		<div class="image-modal-overlay hidden" id="image-modal-overlay">
			<div class="image-modal-content">
				<button class="image-modal-close" id="image-modal-close">√ó</button>
				<img
					src=""
					alt="Full screen image"
					class="image-modal-img"
					id="image-modal-img"
				/>
			</div>
		</div>
		<input
			type="file"
			id="file-input"
			class="file-input"
			accept="image/*,video/*"
			onchange="handleFileSelect(event)"
		/>

		<div class="top-container">
			<div class="top-row">
				<div class="menu-icon">‚ò∞</div>
				<div class="avatar-small" id="top-avatar"></div>
				<div class="search-container">
					<input type="text" class="search-input" placeholder="–ø–æ–∏—Å–∫" />
					<span class="clear-btn">√ó</span>
				</div>
			</div>

			<div class="user-container" id="user-container"></div>
		</div>

		<div class="right-container">
			<div class="default-content" id="default-content">
				<img
					src="https://cdn-icons-png.flaticon.com/512/5757/5757765.png"
					alt="–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç"
					class="default-image"
				/>
			</div>

			<div class="chat-container hidden" id="chat-container">
				<div class="chat-header">
					<div class="chat-username" id="chat-username"></div>
					<div class="chat-header-info">
						<div class="chat-status" id="chat-status"></div>
					</div>
				</div>
				<div class="chat-scroll-container">
					<div class="chat-messages-wrapper" id="chat-messages-wrapper">
						<div class="chat-messages" id="chat-messages"></div>
					</div>
					<div class="custom-scrollbar" id="custom-scrollbar">
						<div
							class="custom-scrollbar-thumb"
							id="custom-scrollbar-thumb"
						></div>
					</div>
				</div>
				<div class="message-input-container">
					<div class="reply-container hidden" id="reply-container"></div>
					<div class="input-row">
						<button class="photo-message-btn" id="photo-message-btn">
							<img
								src="https://cdn-icons-png.flaticon.com/512/266/266074.png"
								alt="–§–æ—Ç–æ"
							/>
						</button>
						<div class="message-input-wrapper">
							<input
								type="text"
								class="message-input"
								placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
								id="message-input"
							/>
							<div class="recording-container hidden" id="recording-container">
								–ó–∞–ø–∏—Å—å: <span id="recording-time">0</span> —Å–µ–∫.
							</div>
						</div>
						<button class="voice-message-btn" id="voice-message-btn">
							<img
								src="https://images.icon-icons.com/2066/PNG/512/mic_icon_125214.png"
								alt="–ó–∞–ø–∏—Å—å"
							/>
						</button>
					</div>
				</div>
			</div>
		</div>
		<div class="photo-options-menu hidden" id="photo-options-menu">
			<button class="photo-option" data-type="photo-video">
				<img
					src="https://cdn-icons-png.flaticon.com/512/266/266074.png"
					alt="–§–æ—Ç–æ/–í–∏–¥–µ–æ"
				/>
				<span>–§–æ—Ç–æ –∏ –≤–∏–¥–µ–æ</span>
			</button>
			<button class="photo-option" data-type="documents">
				<img
					src="https://cdn-icons-png.flaticon.com/512/2991/2991112.png"
					alt="–î–æ–∫—É–º–µ–Ω—Ç—ã"
				/>
				<span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
			</button>
			<button class="photo-option" data-type="poll">
				<img
					src="https://cdn-icons-png.flaticon.com/512/3034/3034626.png"
					alt="–û–ø—Ä–æ—Å"
				/>
				<span>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</span>
			</button>
			<button class="photo-option" data-type="location">
				<img
					src="https://cdn-icons-png.flaticon.com/512/535/535137.png"
					alt="–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è"
				/>
				<span>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</span>
			</button>
		</div>
		<div class="video-message-container hidden" id="video-loading-overlay">
			<div class="video-loading-content">
				<div class="video-loading-spinner"></div>
				<div class="video-loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>
				<div class="video-loading-progress">0 MB / 0 MB</div>
				<button class="video-loading-cancel">–û—Ç–º–µ–Ω–∞</button>
			</div>
		</div>
		<div class="context-menu" id="context-menu">
			<div class="context-menu-item add-friend hidden" id="context-menu-add">
				–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
			</div>
			<div
				class="context-menu-item remove-friend hidden"
				id="context-menu-remove"
			>
				–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π
			</div>
		</div>
		<div class="modal-overlay hidden" id="logout-overlay"></div>
		<div class="logout-modal hidden" id="logout-modal">
			<button class="modal-close-btn" id="logout-close-btn">√ó</button>
			<div class="logout-text">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
			<div class="logout-buttons">
				<button class="logout-button logout-cancel" id="logout-cancel-btn">
					–û—Ç–º–µ–Ω–∞
				</button>
				<button class="logout-button logout-confirm" id="logout-confirm-btn">
					–í—ã–π—Ç–∏
				</button>
			</div>
		</div>

		<div class="message-context-menu hidden" id="message-context-menu">
			<div class="message-context-item" id="message-reply">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
			<div class="message-context-item" id="message-edit">–ò–∑–º–µ–Ω–∏—Ç—å</div>
			<div class="message-context-item" id="message-pin">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
			<div class="message-context-item" id="message-delete">–£–¥–∞–ª–∏—Ç—å</div>
			<div
				class="message-context-item"
				id="message-delete-for-me"
				style="display: none"
			>
				–£–¥–∞–ª–∏—Ç—å —É –º–µ–Ω—è
			</div>
			<div class="message-context-item" id="message-forward">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
			<div class="message-context-item" id="message-copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
		</div>
		<div class="modal-overlay hidden" id="delete-message-overlay"></div>
		<div class="delete-message-modal hidden" id="delete-message-modal">
			<button class="modal-close-btn" id="delete-message-close-btn">√ó</button>
			<div class="delete-message-text">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
			<div class="delete-message-buttons">
				<button
					class="delete-message-button delete-for-all"
					id="delete-for-all-btn"
				>
					–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö
				</button>
				<button
					class="delete-message-button delete-for-me"
					id="delete-for-me-btn"
				>
					–¢–æ–ª—å–∫–æ —É –º–µ–Ω—è
				</button>
			</div>
			<button class="delete-message-cancel" id="delete-message-cancel-btn">
				–û—Ç–º–µ–Ω–∞
			</button>
		</div>

		<script src="eel.js"></script>
		<script>
			let currentUser = null
			let contextMenu = null
			let contextMenuTarget = null
			let currentChatUserId = null
			let lastMessageId = null
			let activeChats = {}
			let readStatusInterval = null
			let statusUpdateInterval = null
			let onlineStatusInterval = null
			let currentPlayingAudio = null
			let voiceMessagePlaying = false
			let currentPlayingVoiceElement = null
			let ecdhInitialized = false
			let currentContextMessage = null
			let chatInputs = {}
			let scrollPositions = {}
			let isDraggingScroll = false
			let scrollDragStartY = 0
			let scrollThumbStartY = 0
			let messageElementsCache = new Map()
			let dateHeaders = new Map()
			let currentStickyDate = null
			let dateHeadersObserver = null
			let encryptionEnabled = false
			let currentPeerKey = null
			document.addEventListener('keydown', function (e) {
				if (e.key === 'Escape') {
					if (
						!document
							.getElementById('image-modal-overlay')
							.classList.contains('hidden')
					) {
						closeImageModal()
						return
					}
					if (
						!document
							.getElementById('delete-message-modal')
							.classList.contains('hidden')
					) {
						document
							.getElementById('delete-message-overlay')
							.classList.add('hidden')
						document
							.getElementById('delete-message-modal')
							.classList.add('hidden')
						return
					}
					if (
						!document
							.getElementById('logout-modal')
							.classList.contains('hidden')
					) {
						closeLogoutModal()
						return
					}
					if (
						!document
							.getElementById('chat-container')
							.classList.contains('hidden')
					) {
						closeChatAndReset()
					}
				}
			})

			// –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞

			function closeChatAndReset() {
				document.getElementById('default-content').classList.remove('hidden')
				document.getElementById('chat-container').classList.add('hidden')
				currentChatUserId = null
				document.querySelectorAll('.user-bar').forEach(el => {
					el.classList.remove('active-chat')
				})
				stopVoiceMessage()
				currentPlayingAudio = null
				voiceMessagePlaying = false
				currentPlayingVoiceElement = null
				const messageInput = document.getElementById('message-input')
				if (messageInput) {
					messageInput.value = ''
				}
				const replyContainer = document.getElementById('reply-container')
				if (replyContainer) {
					replyContainer.classList.add('hidden')
					document
						.querySelector('.message-input-container')
						.classList.remove('expanded')
				}
				if (readStatusInterval) {
					clearInterval(readStatusInterval)
					readStatusInterval = null
				}
				if (statusUpdateInterval) {
					clearInterval(statusUpdateInterval)
					statusUpdateInterval = null
				}

				console.log('–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç –ø–æ ESC, –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω')
			}

			// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

			function initImageModal() {
				const imageModalOverlay = document.getElementById('image-modal-overlay')
				const imageModalImg = document.getElementById('image-modal-img')
				const imageModalClose = document.getElementById('image-modal-close')

				if (!imageModalOverlay || !imageModalImg || !imageModalClose) {
					console.error('Image modal elements not found')
					return
				}
				window.openImageModal = function (imageSrc) {
					imageModalImg.src = imageSrc
					imageModalOverlay.classList.remove('hidden')
					document.body.style.overflow = 'hidden'
				}
				window.closeImageModal = function () {
					imageModalOverlay.classList.add('hidden')
					imageModalImg.src = ''
					document.body.style.overflow = ''
				}
				imageModalClose.addEventListener('click', closeImageModal)
				imageModalOverlay.addEventListener('click', function (e) {
					if (e.target === imageModalOverlay) {
						closeImageModal()
					}
				})
				document.addEventListener('keydown', function (e) {
					if (
						e.key === 'Escape' &&
						!imageModalOverlay.classList.contains('hidden')
					) {
						closeImageModal()
					}
				})

				console.log('Image modal initialized')
			}

			// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ–ª–æ—Å–∞

			function stopVoiceMessage() {
				if (currentPlayingAudio) {
					currentPlayingAudio.pause()
					currentPlayingAudio = null
				}
				voiceMessagePlaying = false

				if (currentPlayingVoiceElement) {
					currentPlayingVoiceElement.classList.remove('playing')
					const playIcon =
						currentPlayingVoiceElement.querySelector('.voice-play-icon')
					if (playIcon) {
						playIcon.textContent = '‚ñ∂'
					}
					currentPlayingVoiceElement = null
				}
			}

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≥–æ–ª–æ—Å–∞

			function setupVoiceMessageHandlers() {}

			// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è

			function updateListenIndicators() {
				return Promise.resolve()
			}
			class ECDHEncryption {
				static async generateKeyPair() {
					return await window.crypto.subtle.generateKey(
						{
							name: 'ECDH',
							namedCurve: 'P-256',
						},
						true,
						['deriveKey']
					)
				}
				static async exportPublicKey(key) {
					const exported = await window.crypto.subtle.exportKey('spki', key)
					return btoa(String.fromCharCode(...new Uint8Array(exported)))
				}
				static async exportPrivateKey(key) {
					const exported = await window.crypto.subtle.exportKey('pkcs8', key)
					return btoa(String.fromCharCode(...new Uint8Array(exported)))
				}
				static async importPublicKey(base64Key) {
					const binary = atob(base64Key)
					const buffer = new Uint8Array(binary.length)
					for (let i = 0; i < binary.length; i++) {
						buffer[i] = binary.charCodeAt(i)
					}

					return await window.crypto.subtle.importKey(
						'spki',
						buffer,
						{
							name: 'ECDH',
							namedCurve: 'P-256',
						},
						true,
						[]
					)
				}
				static async deriveSharedSecret(privateKey, peerPublicKey) {
					return await window.crypto.subtle.deriveKey(
						{
							name: 'ECDH',
							public: peerPublicKey,
						},
						privateKey,
						{
							name: 'AES-GCM',
							length: 256,
						},
						false,
						['encrypt', 'decrypt']
					)
				}
				static async encryptMessage(sharedKey, plaintext) {
					const encoder = new TextEncoder()
					const encoded = encoder.encode(plaintext)
					const iv = window.crypto.getRandomValues(new Uint8Array(12)) // 12 –±–∞–π—Ç –¥–ª—è AES-GCM

					const ciphertext = await window.crypto.subtle.encrypt(
						{
							name: 'AES-GCM',
							iv: iv,
						},
						sharedKey,
						encoded
					)

					return {
						ciphertext: Array.from(new Uint8Array(ciphertext)),
						nonce: Array.from(iv),
					}
				}
				static async decryptMessage(sharedKey, ciphertextArray, nonceArray) {
					const ciphertext = new Uint8Array(ciphertextArray)
					const nonce = new Uint8Array(nonceArray)

					const decrypted = await window.crypto.subtle.decrypt(
						{
							name: 'AES-GCM',
							iv: nonce,
						},
						sharedKey,
						ciphertext
					)

					const decoder = new TextDecoder()
					return decoder.decode(decrypted)
				}
				static arrayToHex(array) {
					return Array.from(array)
						.map(b => b.toString(16).padStart(2, '0'))
						.join('')
				}
				static hexToArray(hex) {
					const bytes = []
					for (let i = 0; i < hex.length; i += 2) {
						bytes.push(parseInt(hex.substr(i, 2), 16))
					}
					return bytes
				}
			}

			// –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ ECDH

			async function setupEcdhEncryption(peerUserId) {
				try {
					const userId = localStorage.getItem('user_id')
					const password = sessionStorage.getItem('user_password')

					if (!userId || !password) {
						throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è')
					}
					const peerKeyResult = await eel.get_public_key(peerUserId)()
					if (!peerKeyResult.success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞')
					}
					const sharedSecretResult = await eel.compute_shared_secret(
						userId,
						peerKeyResult.public_key,
						password
					)()

					if (!sharedSecretResult.success) {
						throw new Error(
							'–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç: ' + sharedSecretResult.message
						)
					}

					console.log('ECDH —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –¥–ª—è —á–∞—Ç–∞ —Å', peerUserId)
					return true
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ECDH —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error)
					return false
				}
			}

			ECDHEncryption.importPrivateKeyFromPem = async function (pem) {
				const pemContents = pem
					.replace(/-----BEGIN PRIVATE KEY-----/, '')
					.replace(/-----END PRIVATE KEY-----/, '')
					.replace(/\s/g, '')

				const binaryDer = Uint8Array.from(atob(pemContents), c =>
					c.charCodeAt(0)
				)

				return await window.crypto.subtle.importKey(
					'pkcs8',
					binaryDer,
					{
						name: 'ECDH',
						namedCurve: 'P-256',
					},
					false,
					['deriveKey']
				)
			}

			ECDHEncryption.importPublicKeyFromPem = async function (pem) {
				const pemContents = pem
					.replace(/-----BEGIN PUBLIC KEY-----/, '')
					.replace(/-----END PUBLIC KEY-----/, '')
					.replace(/\s/g, '')

				const binaryDer = Uint8Array.from(atob(pemContents), c =>
					c.charCodeAt(0)
				)

				return await window.crypto.subtle.importKey(
					'spki',
					binaryDer,
					{
						name: 'ECDH',
						namedCurve: 'P-256',
					},
					true,
					[]
				)
			}
			document
				.getElementById('message-input')
				.addEventListener('keypress', async function (e) {
					if (e.key === 'Enter' && this.value.trim()) {
						const text = this.value.trim()
						if (!text) return
						if (this.disabled) return
						this.disabled = true

						try {
							const sent = await sendEcdhMessage(text)
							if (!sent) {
								alert('–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ')
								await sendSecureMessage(text)
							}
						} catch (error) {
							console.error('Error sending message:', error)
							alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
						} finally {
							this.disabled = false
						}
					}
				})

			// –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞

			async function loadEcdhChatHistory(userId) {
				try {
					const currentUserId = localStorage.getItem('user_id')
					console.log(
						'–ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é ECDH —á–∞—Ç–∞ –º–µ–∂–¥—É',
						currentUserId,
						'–∏',
						userId
					)
					const messagesContainer = document.getElementById('chat-messages')
					if (messagesContainer) {
						messagesContainer.innerHTML = ''
						dateHeaders.clear()
						if (window.messageElements) {
							window.messageElements.clear()
						}
					}
					const response = await eel.get_ecdh_chat_history(
						currentUserId,
						userId
					)()

					if (!response.success) {
						console.warn(
							'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é ECDH —á–∞—Ç–∞:',
							response.message
						)
						const fallbackResponse = await eel.get_encrypted_chat_history(
							currentUserId,
							userId
						)()
						if (fallbackResponse.success) {
							await processEncryptedMessages(
								fallbackResponse.messages,
								currentUserId,
								userId
							)
						}
						return
					}

					console.log(
						'–ü–æ–ª—É—á–µ–Ω–æ ECDH —Å–æ–æ–±—â–µ–Ω–∏–π:',
						response.messages ? response.messages.length : 0
					)

					if (response.messages && response.messages.length > 0) {
						await processEcdhMessages(response.messages, currentUserId, userId)
					} else {
						messagesContainer.innerHTML =
							'<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ ECDH —á–∞—Ç–∞:', error)
				}
			}

			// –ó–∞—â–∏—â—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

			async function sendSecureMessage(text) {
				try {
					const userId = localStorage.getItem('user_id')
					const userPassword = sessionStorage.getItem('user_password')

					if (!userId || !userPassword) {
						throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è')
					}
					let sentWithECDH = false
					if (currentChatUserId && currentChatUserId !== userId) {
						try {
							sentWithECDH = await sendEcdhMessage(text)
						} catch (ecdhError) {
							console.warn('ECDH —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ:', ecdhError)
						}
					}
					if (!sentWithECDH) {
						const encryptedText = await MessageEncryption.encryptMessage(
							text,
							userPassword
						)

						const result = await eel.send_encrypted_message(
							userId,
							currentChatUserId,
							encryptedText
						)()

						if (result.success) {
							const messageData = {
								id: result.message_id,
								sender_id: userId,
								receiver_id: currentChatUserId,
								text: text,
								timestamp: result.timestamp,
								read: result.read,
								is_encrypted: true,
							}

							await addMessageToChat(messageData, true, true)
							updateLastMessageOnUserCard(currentChatUserId, text, true)
							document.getElementById('message-input').value = ''

							console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ —Å—Ç–∞—Ä—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º')
						} else {
							throw new Error(result.message)
						}
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
					alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
				}
			}

			// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

			async function processEcdhMessages(messages, currentUserId, peerUserId) {
				const messagesContainer = document.getElementById('chat-messages')

				if (!messages || messages.length === 0) {
					messagesContainer.innerHTML =
						'<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>'
					return
				}

				const userPassword = sessionStorage.getItem('user_password')
				if (!userPassword) {
					showNoPasswordError()
					return
				}
				const processedMessageIds = new Set()

				for (const msg of messages) {
					if (msg.id && processedMessageIds.has(msg.id)) {
						console.log('–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:', msg.id)
						continue
					}
					processedMessageIds.add(msg.id)

					const isMyMessage = msg.sender_id === currentUserId

					try {
						let displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'

						if (msg.is_encrypted && msg.ciphertext && msg.nonce) {
							displayText = await decryptEcdhMessage(
								msg.ciphertext,
								msg.nonce,
								currentUserId,
								isMyMessage ? peerUserId : msg.sender_id,
								userPassword,
								isMyMessage
							)
						}

						const messageObj = {
							...msg,
							text: displayText,
							is_encrypted: true,
						}
						if (msg.replied_message && !msg.replied_message.text) {
							try {
								const repliedMessage = await getFullEcdhMessageData(
									msg.replied_message.id
								)
								if (repliedMessage) {
									let repliedText = '[–°–æ–æ–±—â–µ–Ω–∏–µ]'

									if (repliedMessage.is_encrypted) {
										if (
											repliedMessage.encryption_type === 'ECDH-AES-GCM' &&
											repliedMessage.ciphertext &&
											repliedMessage.nonce
										) {
											repliedText = await decryptEcdhMessage(
												repliedMessage.ciphertext,
												repliedMessage.nonce,
												currentUserId,
												repliedMessage.sender_id === currentUserId
													? repliedMessage.receiver_id
													: repliedMessage.sender_id,
												userPassword,
												repliedMessage.sender_id === currentUserId
											)
										} else if (repliedMessage.text) {
											repliedText = await MessageEncryption.decryptMessage(
												repliedMessage.text,
												userPassword
											)
										}
									} else {
										repliedText = repliedMessage.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
									}

									messageObj.replied_message = {
										...msg.replied_message,
										text: repliedText,
									}
								}
							} catch (error) {
								console.error(
									'–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:',
									error
								)
							}
						}

						await addMessageToChat(messageObj, isMyMessage, false)
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
						const errorMessage = {
							...msg,
							text: '[–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è]',
							is_encrypted: true,
						}
						await addMessageToChat(errorMessage, isMyMessage, false)
					}
				}
				setTimeout(() => {
					const messagesWrapper = document.getElementById(
						'chat-messages-wrapper'
					)
					if (messagesWrapper) {
						messagesWrapper.scrollTop = messagesWrapper.scrollHeight
						updateStickyDateHeaders()
					}
				}, 100)
			}

			// –û—à–∏–±–∫–∞ –ø–∞—Ä–æ–ª—è

			function showNoPasswordError() {
				const messagesContainer = document.getElementById('chat-messages')
				messagesContainer.innerHTML = `
        <div class="error-message">
            <div style="color: #f44336; font-weight: bold;">–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</div>
            <div style="margin-top: 10px;">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.</div>
            <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
            </button>
        </div>
    `
			}

			// –û—Ç–ø—Ä–∞–≤–∫–∞ ECDH

			async function sendEcdhMessage(text) {
				try {
					if (!currentChatUserId || !text.trim()) {
						return false
					}

					const userId = localStorage.getItem('user_id')
					const password = sessionStorage.getItem('user_password')

					if (!password) {
						throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è')
					}
					const peerKeyResult = await eel.get_public_key(currentChatUserId)()
					if (!peerKeyResult.success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞')
					}
					const privateKeyResult = await eel.get_decrypted_private_key(
						userId,
						password
					)()
					if (!privateKeyResult.success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á')
					}
					const privateKey = await ECDHEncryption.importPrivateKeyFromPem(
						privateKeyResult.private_key
					)
					const peerPublicKey = await ECDHEncryption.importPublicKeyFromPem(
						peerKeyResult.public_key
					)
					const sharedKey = await ECDHEncryption.deriveSharedSecret(
						privateKey,
						peerPublicKey
					)
					const encrypted = await ECDHEncryption.encryptMessage(sharedKey, text)
					const ciphertextHex = ECDHEncryption.arrayToHex(encrypted.ciphertext)
					const nonceHex = ECDHEncryption.arrayToHex(encrypted.nonce)
					const replyContainer = document.getElementById('reply-container')
					const isReply = !replyContainer.classList.contains('hidden')
					let replyToMessageId = null
					let repliedMessageData = null

					if (isReply) {
						replyToMessageId = replyContainer.dataset.messageId

						try {
							const repliedMessage = await getFullEcdhMessageData(
								replyToMessageId
							)
							if (repliedMessage) {
								let displayText = '[–°–æ–æ–±—â–µ–Ω–∏–µ]'

								if (repliedMessage.is_encrypted) {
									if (
										repliedMessage.encryption_type === 'ECDH-AES-GCM' &&
										repliedMessage.ciphertext &&
										repliedMessage.nonce
									) {
										try {
											displayText = await decryptEcdhMessage(
												repliedMessage.ciphertext,
												repliedMessage.nonce,
												userId,
												repliedMessage.sender_id === userId
													? repliedMessage.receiver_id
													: repliedMessage.sender_id,
												password,
												repliedMessage.sender_id === userId
											)
										} catch (decryptError) {
											console.error(
												'–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –æ—Ç–≤–µ—Ç–∞:',
												decryptError
											)
											displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
										}
									} else if (repliedMessage.text) {
										try {
											displayText = await MessageEncryption.decryptMessage(
												repliedMessage.text,
												password
											)
										} catch (error) {
											console.error(
												'–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:',
												error
											)
											displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
										}
									}
								} else {
									displayText = repliedMessage.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
								}
								repliedMessageData = {
									id: repliedMessage.id,
									sender_id: repliedMessage.sender_id,
									text: displayText,
									is_encrypted: repliedMessage.is_encrypted,
									encryption_type: repliedMessage.encryption_type || null,
									timestamp: repliedMessage.timestamp,
								}
							}
						} catch (error) {
							console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞:', error)
						}
					}
					const result = await eel.send_ecdh_encrypted_message(
						userId,
						currentChatUserId,
						ciphertextHex,
						nonceHex,
						replyToMessageId
					)()

					if (result.success) {
						const messageData = {
							id: result.message_id,
							sender_id: userId,
							receiver_id: currentChatUserId,
							text: text,
							ciphertext: ciphertextHex,
							nonce: nonceHex,
							timestamp: result.timestamp,
							read: result.read,
							is_encrypted: true,
							encryption_type: 'ECDH-AES-GCM',
						}
						if (isReply && replyToMessageId) {
							messageData.reply_to_message_id = replyToMessageId
							if (repliedMessageData) {
								messageData.replied_message = repliedMessageData
							}
						}

						await addMessageToChat(messageData, true, true)
						updateLastMessageOnUserCard(currentChatUserId, text, true)
						document.getElementById('message-input').value = ''

						if (isReply) {
							await clearReplyState()
						}

						console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å ECDH')
						return true
					} else {
						throw new Error(result.message)
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ECDH —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
					alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
					return false
				}
			}

			document
				.getElementById('message-input')
				.addEventListener('keypress', async function (e) {
					if (e.key === 'Enter' && this.value.trim()) {
						const text = this.value.trim()
						if (!text) return
						if (this.disabled) return
						this.disabled = true

						try {
							await sendSecureMessage(text)
						} catch (error) {
							console.error('Error sending message:', error)
							alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
						} finally {
							this.disabled = false
						}
					}
				})

			// –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ ECDH

			async function decryptEcdhMessage(
				ciphertextHex,
				nonceHex,
				myUserId,
				peerUserId,
				password,
				isMyMessage
			) {
				try {
					const privateKeyResult = await eel.get_decrypted_private_key(
						myUserId,
						password
					)()
					if (!privateKeyResult.success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á')
					}
					const peerKeyResult = await eel.get_public_key(peerUserId)()
					if (!peerKeyResult.success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞')
					}
					const privateKey = await ECDHEncryption.importPrivateKeyFromPem(
						privateKeyResult.private_key
					)
					const peerPublicKey = await ECDHEncryption.importPublicKeyFromPem(
						peerKeyResult.public_key
					)
					const sharedKey = await ECDHEncryption.deriveSharedSecret(
						privateKey,
						peerPublicKey
					)
					const ciphertextArray = ECDHEncryption.hexToArray(ciphertextHex)
					const nonceArray = ECDHEncryption.hexToArray(nonceHex)
					return await ECDHEncryption.decryptMessage(
						sharedKey,
						ciphertextArray,
						nonceArray
					)
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è ECDH —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
					return '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
				}
			}

			class MessageEncryption {
				static async deriveKey(password, salt) {
					const encoder = new TextEncoder()
					const keyMaterial = await crypto.subtle.importKey(
						'raw',
						encoder.encode(password),
						'PBKDF2',
						false,
						['deriveKey']
					)

					return await crypto.subtle.deriveKey(
						{
							name: 'PBKDF2',
							salt: salt,
							iterations: 100000,
							hash: 'SHA-256',
						},
						keyMaterial,
						{
							name: 'AES-GCM',
							length: 256,
						},
						false,
						['encrypt', 'decrypt']
					)
				}

				static async encryptMessage(text, password) {
					try {
						const salt = crypto.getRandomValues(new Uint8Array(16))
						const iv = crypto.getRandomValues(new Uint8Array(12))
						const key = await this.deriveKey(password, salt)
						const encoder = new TextEncoder()
						const encodedText = encoder.encode(text)

						const encryptedContent = await crypto.subtle.encrypt(
							{
								name: 'AES-GCM',
								iv: iv,
							},
							key,
							encodedText
						)
						const result = new Uint8Array(
							salt.length + iv.length + encryptedContent.byteLength
						)
						result.set(salt, 0)
						result.set(iv, salt.length)
						result.set(
							new Uint8Array(encryptedContent),
							salt.length + iv.length
						)
						return btoa(String.fromCharCode.apply(null, result))
					} catch (error) {
						console.error('Encryption error:', error)
						throw error
					}
				}

				static async decryptMessage(encryptedData, password) {
					try {
						const binaryString = atob(encryptedData)
						const bytes = new Uint8Array(binaryString.length)
						for (let i = 0; i < binaryString.length; i++) {
							bytes[i] = binaryString.charCodeAt(i)
						}
						const salt = bytes.slice(0, 16)
						const iv = bytes.slice(16, 28)
						const encryptedContent = bytes.slice(28)
						const key = await this.deriveKey(password, salt)
						const decryptedContent = await crypto.subtle.decrypt(
							{
								name: 'AES-GCM',
								iv: iv,
							},
							key,
							encryptedContent
						)

						const decoder = new TextDecoder()
						return decoder.decode(decryptedContent)
					} catch (error) {
						console.error('Decryption error:', error)
						throw error
					}
				}
			}

			async function closeChatAndReset() {
				document.getElementById('default-content').classList.remove('hidden')
				document.getElementById('chat-container').classList.add('hidden')
				currentChatUserId = null
				document.querySelectorAll('.user-bar').forEach(el => {
					el.classList.remove('active-chat')
				})
				stopVoiceMessage()
				currentPlayingAudio = null
				voiceMessagePlaying = false
				currentPlayingVoiceElement = null
				const messageInput = document.getElementById('message-input')
				if (messageInput) {
					messageInput.value = ''
				}
				await clearReplyState()
				if (readStatusInterval) {
					clearInterval(readStatusInterval)
					readStatusInterval = null
				}
				if (statusUpdateInterval) {
					clearInterval(statusUpdateInterval)
					statusUpdateInterval = null
				}

				console.log('–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç –ø–æ ESC, –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω')
			}

			// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏

			function formatMessageTime(timestamp) {
				try {
					const date = new Date(timestamp)

					return date.toLocaleTimeString('ru-RU', {
						hour: '2-digit',
						minute: '2-digit',
					})
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', error)
					return '--:--'
				}
			}

			// –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

			async function getFullEcdhMessageData(messageId) {
				try {
					const userId = localStorage.getItem('user_id')

					if (!currentChatUserId) {
						console.error('–ù–µ –≤—ã–±—Ä–∞–Ω —á–∞—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è')
						return null
					}
					try {
						const ecdhHistory = await eel.get_ecdh_chat_history(
							userId,
							currentChatUserId
						)()

						if (ecdhHistory.success && ecdhHistory.messages) {
							const message = ecdhHistory.messages.find(
								msg => msg.id === messageId
							)
							if (message) {
								return message
							}
						}
					} catch (ecdhError) {
						console.warn('ECDH –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', ecdhError)
					}
					try {
						const regularHistory = await eel.get_encrypted_chat_history(
							userId,
							currentChatUserId
						)()

						if (regularHistory.success && regularHistory.messages) {
							const message = regularHistory.messages.find(
								msg => msg.id === messageId
							)
							if (message) {
								return message
							}
						}
					} catch (regularError) {
						console.warn('–û–±—ã—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', regularError)
					}
					try {
						const messageData = await eel.get_message_data(messageId)()
						return messageData
					} catch (basicError) {
						console.error(
							'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:',
							basicError
						)
						return null
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
					return null
				}
			}

			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

			async function initializeUserEncryption() {
				try {
					const userId = localStorage.getItem('user_id')
					const password = sessionStorage.getItem('user_password')

					if (!userId || !password) {
						console.warn('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω')
						return false
					}
					const keyResult = await eel.get_public_key(userId)()
					if (!keyResult.success) {
						const generateResult = await eel.generate_ecdh_keypair(
							userId,
							password
						)()
						if (!generateResult.success) {
							console.error(
								'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ECDH –∫–ª—é—á–∏:',
								generateResult.message
							)
							return false
						}
						console.log('ECDH –∫–ª—é—á–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã')
					} else {
						console.log('ECDH –∫–ª—é—á–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç')
					}

					return true
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error)
					return false
				}
			}

			// –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö

			async function decryptLastMessageForAllUsers() {
				try {
					const user_id = localStorage.getItem('user_id')
					const userPassword = sessionStorage.getItem('user_password')

					if (!user_id || !userPassword) {
						console.warn('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è')
						return
					}

					const userData = await eel.get_user_data(user_id)()
					if (!userData || !userData.friends || userData.friends.length === 0) {
						return
					}

					console.log(
						'–ù–∞—á–∏–Ω–∞–µ–º –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –¥—Ä—É–∑–µ–π...'
					)

					for (const friendId of userData.friends) {
						try {
							const lastMessage = await eel.get_last_message(
								user_id,
								friendId
							)()

							if (lastMessage && lastMessage.is_encrypted) {
								const chatHistory = await eel.get_encrypted_chat_history(
									user_id,
									friendId
								)()

								if (
									chatHistory.success &&
									chatHistory.messages &&
									chatHistory.messages.length > 0
								) {
									const lastMsg =
										chatHistory.messages[chatHistory.messages.length - 1]

									if (lastMsg.is_encrypted && lastMsg.text) {
										try {
											const decryptedText =
												await MessageEncryption.decryptMessage(
													lastMsg.text,
													userPassword
												)

											updateLastMessageOnUserCard(
												friendId,
												decryptedText,
												lastMsg.sender_id === user_id
											)

											console.log(
												`–°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${friendId}`
											)
										} catch (decryptError) {
											console.error(
												`–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è ${friendId}:`,
												decryptError
											)
											updateLastMessageOnUserCard(
												friendId,
												'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
												false
											)
										}
									}
								}
							} else if (lastMessage) {
								updateLastMessageOnUserCard(
									friendId,
									lastMessage.text,
									lastMessage.sender_id === user_id
								)
							}
						} catch (friendError) {
							console.error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—Ä—É–≥–∞ ${friendId}:`, friendError)
						}
					}

					console.log('–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error)
				}
			}

			// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è

			async function updateLastMessageAfterDelete(chatUserId) {
				try {
					const lastMessage = await eel.get_last_message(
						localStorage.getItem('user_id'),
						chatUserId
					)()
					const userCard = document.querySelector(
						`.user-bar[data-user-id="${chatUserId}"]`
					)

					if (!userCard) return

					const lastMsgDiv = userCard.querySelector('.last-message')
					const contentWrapper = userCard.querySelector('.user-content-wrapper')

					if (lastMessage) {
						let displayText = lastMessage.text
						if (displayText.length > 25) {
							displayText = displayText.substring(0, 22) + '...'
						}

						if (lastMessage.sender_id === localStorage.getItem('user_id')) {
							if (lastMsgDiv) {
								lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
							} else if (contentWrapper) {
								const newLastMsgDiv = document.createElement('div')
								newLastMsgDiv.className = 'last-message'
								newLastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
								contentWrapper.appendChild(newLastMsgDiv)
							}
						} else {
							if (lastMsgDiv) {
								lastMsgDiv.textContent = displayText
							} else if (contentWrapper) {
								const newLastMsgDiv = document.createElement('div')
								newLastMsgDiv.className = 'last-message'
								newLastMsgDiv.textContent = displayText
								contentWrapper.appendChild(newLastMsgDiv)
							}
						}
					} else {
						if (lastMsgDiv) {
							lastMsgDiv.remove()
						}
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
				}
			}

			// –û—á–∏—Å—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞

			async function clearReplyState() {
				const replyContainer = document.getElementById('reply-container')
				replyContainer.classList.add('hidden')
				document
					.querySelector('.message-input-container')
					.classList.remove('expanded')
				if (currentChatUserId) {
					const clearResult = await eel.clear_reply_state(
						localStorage.getItem('user_id'),
						currentChatUserId
					)()
					if (!clearResult.success) {
						console.error(
							'–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞:',
							clearResult.message
						)
					} else {
						console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—á–∏—â–µ–Ω–æ –¥–ª—è —á–∞—Ç–∞:', currentChatUserId)
					}
				}
			}

			// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞

			async function initializeZKChat(
				userId,
				peerUserId,
				myPassword,
				peerPassword
			) {
				try {
					const myUserData = await eel.get_user_data(userId)()
					const peerUserData = await eel.get_user_data(peerUserId)()

					if (!myUserData || !peerUserData) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')
					}

					const mySalt = Uint8Array.from(atob(myUserData.salt), c =>
						c.charCodeAt(0)
					)
					const peerSalt = Uint8Array.from(atob(peerUserData.salt), c =>
						c.charCodeAt(0)
					)
					const combinedSalt = new Uint8Array([...mySalt, ...peerSalt])
					const masterKey = await ZKEncryptionSystem.deriveMasterKey(
						myPassword,
						peerPassword,
						combinedSalt
					)
					const chatKey = `${userId}-${peerUserId}`
					zkMasterKeys.set(chatKey, masterKey)
					await eel.compute_shared_master_key(
						userId,
						peerUserId,
						myPassword,
						peerPassword
					)()

					return masterKey
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ZK —á–∞—Ç–∞:', error)
					throw error
				}
			}

			document.addEventListener('DOMContentLoaded', async function () {
				console.log('=== DOMContentLoaded –Ω–∞—á–∞—Ç ===')
				if (window.appInitialized) {
					console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ')
					return
				}
				window.appInitialized = true

				const user_id = localStorage.getItem('user_id')
				console.log('User ID –∏–∑ localStorage:', user_id)

				if (!user_id) {
					console.log('User ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ login')
					window.location.href = 'login.html'
					return
				}

				try {
					console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...')
					currentUser = await eel.get_user_data(user_id)()
					console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', currentUser)

					if (!currentUser) {
						console.error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö')
						localStorage.removeItem('user_id')
						sessionStorage.removeItem('user_password')
						window.location.href = 'login.html'
						return
					}

					console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...')
					const userPassword = sessionStorage.getItem('user_password')
					if (!userPassword) {
						console.error(
							'–ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ sessionStorage. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≤—Ö–æ–¥.'
						)
						localStorage.removeItem('user_id')
						window.location.href = 'login.html'
						return
					}
					// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫)
					try {
						const encryptionInit = await eel.initialize_user_encryption(
							user_id,
							userPassword
						)()
						if (encryptionInit.success) {
							console.log('–°–∏—Å—Ç–µ–º–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞')
						} else {
							console.warn(
								'–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:',
								encryptionInit.message
							)
						}
					} catch (encryptionError) {
						console.warn(
							'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:',
							encryptionError
						)
					}

					console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...')
					initCustomScroll()
					initImageModal()
					if (!window.messageElements) {
						window.messageElements = new Map()
					}
					document.getElementById('top-avatar').style.backgroundImage =
						'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)'
					const searchInput = document.querySelector('.search-input')
					const clearBtn = document.querySelector('.clear-btn')

					if (searchInput && clearBtn) {
						searchInput.addEventListener('input', async function () {
							const searchTerm = this.value.trim()
							if (searchTerm.length > 0) {
								const users = await eel.search_users(searchTerm, user_id)()
								displaySearchResults(users)
							} else {
								await loadFriends()
							}
						})

						clearBtn.addEventListener('click', function () {
							searchInput.value = ''
							searchInput.focus()
							loadFriends()
						})
					}
					contextMenu = document.getElementById('context-menu')
					if (contextMenu) {
						document.addEventListener('click', closeContextMenu)
						document
							.getElementById('context-menu-add')
							.addEventListener('click', handleAddFriend)
						document
							.getElementById('context-menu-remove')
							.addEventListener('click', handleRemoveFriend)
					}
					const menuIcon = document.querySelector('.menu-icon')
					if (menuIcon) {
						menuIcon.addEventListener('click', function () {
							document
								.getElementById('logout-overlay')
								.classList.remove('hidden')
							document.getElementById('logout-modal').classList.remove('hidden')
						})
					}

					document
						.getElementById('logout-close-btn')
						?.addEventListener('click', closeLogoutModal)
					document
						.getElementById('logout-cancel-btn')
						?.addEventListener('click', closeLogoutModal)
					document
						.getElementById('logout-overlay')
						?.addEventListener('click', closeLogoutModal)
					document
						.getElementById('logout-confirm-btn')
						?.addEventListener('click', function () {
							localStorage.removeItem('user_id')
							sessionStorage.removeItem('user_password')
							localStorage.removeItem('user_salt')
							window.location.href = 'login.html'
						})
					startOnlineStatusUpdates()

					console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π...')
					await loadFriends()
					console.log('–ù–∞—á–∏–Ω–∞–µ–º –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...')
					setTimeout(async () => {
						await loadAllLastMessages()
					}, 1000)
					initMessageContextMenu()
					initButtonHandlers()

					console.log('=== –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ ===')
					console.log('–°–∏—Å—Ç–µ–º–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', error)
					alert(
						'–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ' +
							error.message +
							'\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.'
					)
				}
			})
			document
				.getElementById('message-input')
				.addEventListener('keypress', async function (e) {
					if (e.key === 'Enter' && this.value.trim()) {
						const text = this.value.trim()
						if (!text) return
						if (this.disabled) return
						this.disabled = true

						try {
							await sendSecureMessage(text)
						} catch (error) {
							console.error('Error sending message:', error)
							alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
						} finally {
							this.disabled = false
						}
					}
				})

			// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞

			function initCustomScroll() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				const scrollbar = document.getElementById('custom-scrollbar')
				const scrollThumb = document.getElementById('custom-scrollbar-thumb')
				const rightContainer = document.querySelector('.right-container')

				let isDraggingScroll = false
				let scrollDragStartY = 0
				let scrollThumbStartY = 0

				// –ü–æ–ª–æ—Å–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏

				function updateScrollThumb() {
					if (!messagesWrapper) return

					const { scrollHeight, clientHeight, scrollTop } = messagesWrapper
					if (scrollHeight <= clientHeight) {
						scrollbar.style.display = 'none'
						return
					}

					scrollbar.style.display = 'block'
					const thumbHeight = Math.max(
						20,
						(clientHeight / scrollHeight) * clientHeight
					)
					const thumbPosition =
						(scrollTop / (scrollHeight - clientHeight)) *
						(clientHeight - thumbHeight)

					scrollThumb.style.height = `${thumbHeight}px`
					scrollThumb.style.top = `${thumbPosition}px`
				}
				scrollThumb.addEventListener('mousedown', e => {
					isDraggingScroll = true
					scrollThumb.classList.add('dragging')
					scrollDragStartY = e.clientY
					scrollThumbStartY = parseInt(scrollThumb.style.top || '0')
					e.preventDefault()

					document.addEventListener('mousemove', handleScrollMove)
					document.addEventListener('mouseup', handleScrollEnd)
				})

				const handleScrollMove = e => {
					if (!isDraggingScroll) return

					const deltaY = e.clientY - scrollDragStartY
					let newThumbPosition = scrollThumbStartY + deltaY
					const maxPosition =
						messagesWrapper.clientHeight - scrollThumb.offsetHeight
					newThumbPosition = Math.max(
						0,
						Math.min(maxPosition, newThumbPosition)
					)
					scrollThumb.style.top = `${newThumbPosition}px`
					const scrollRatio = newThumbPosition / maxPosition
					messagesWrapper.scrollTop =
						scrollRatio *
						(messagesWrapper.scrollHeight - messagesWrapper.clientHeight)
				}

				// –ö–æ–Ω–µ—Ü –ø—Ä–æ–∫—Ä—É—Ç–∫–∏

				const handleScrollEnd = () => {
					isDraggingScroll = false
					scrollThumb.classList.remove('dragging')
					document.removeEventListener('mousemove', handleScrollMove)
					document.removeEventListener('mouseup', handleScrollEnd)
				}
				scrollbar.addEventListener('click', e => {
					if (e.target === scrollbar) {
						const rect = scrollbar.getBoundingClientRect()
						const clickPosition = e.clientY - rect.top
						const thumbHeight = scrollThumb.offsetHeight
						let newThumbPosition = clickPosition - thumbHeight / 2
						newThumbPosition = Math.max(
							0,
							Math.min(rect.height - thumbHeight, newThumbPosition)
						)
						scrollThumb.style.top = `${newThumbPosition}px`
						const scrollRatio = newThumbPosition / (rect.height - thumbHeight)
						messagesWrapper.scrollTop =
							scrollRatio *
							(messagesWrapper.scrollHeight - messagesWrapper.clientHeight)
					}
				})
				messagesWrapper.addEventListener('scroll', updateScrollThumb)
				updateScrollThumb()
				window.addEventListener('resize', updateScrollThumb)
				const observer = new MutationObserver(updateScrollThumb)
				observer.observe(messagesWrapper, { childList: true, subtree: true })
			}

			// –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

			function startOnlineStatusUpdates() {
				updateOnlineStatus()
				onlineStatusInterval = setInterval(updateOnlineStatus, 30000)
				window.addEventListener('beforeunload', updateOnlineStatus)
			}

			// –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω

			async function updateOnlineStatus() {
				try {
					await eel.update_last_online(localStorage.getItem('user_id'))()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω:', error)
				}
			}

			// –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã—Ö–æ–¥–∞

			function closeLogoutModal() {
				document.getElementById('logout-overlay').classList.add('hidden')
				document.getElementById('logout-modal').classList.add('hidden')
			}

			// –ó–∞–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞

			function closeChat(softClose = false) {
				document.getElementById('default-content').classList.remove('hidden')
				document.getElementById('chat-container').classList.add('hidden')
				document.querySelectorAll('.user-bar').forEach(el => {
					el.classList.remove('active-chat')
				})

				stopVoiceMessage()
				currentPlayingAudio = null
				voiceMessagePlaying = false
				currentPlayingVoiceElement = null
				if (!softClose) {
					currentChatUserId = null
				}

				lastMessageId = null

				if (readStatusInterval) {
					clearInterval(readStatusInterval)
					readStatusInterval = null
				}
				if (statusUpdateInterval) {
					clearInterval(statusUpdateInterval)
					statusUpdateInterval = null
				}
			}

			// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞

			async function checkAndRestoreReplyState() {
				if (!currentChatUserId) return

				try {
					const replyState = await eel.get_reply_state(
						localStorage.getItem('user_id'),
						currentChatUserId
					)()

					if (replyState.success && replyState.message_id) {
						const fullMessageData = await getFullEcdhMessageData(
							replyState.message_id
						)

						if (fullMessageData) {
							const replyContainer = document.getElementById('reply-container')
							const isMyMessage =
								fullMessageData.sender_id === localStorage.getItem('user_id')

							let displayText = '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
							if (fullMessageData.is_encrypted) {
								if (
									fullMessageData.encryption_type === 'ECDH-AES-GCM' &&
									fullMessageData.ciphertext &&
									fullMessageData.nonce
								) {
									try {
										const userId = localStorage.getItem('user_id')
										const password = sessionStorage.getItem('user_password')

										if (password) {
											displayText = await decryptEcdhMessage(
												fullMessageData.ciphertext,
												fullMessageData.nonce,
												userId,
												fullMessageData.sender_id === userId
													? fullMessageData.receiver_id
													: fullMessageData.sender_id,
												password,
												fullMessageData.sender_id === userId
											)
										} else {
											displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
										}
									} catch (decryptError) {
										console.error(
											'–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞:',
											decryptError
										)
										displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
									}
								} else if (fullMessageData.text) {
									try {
										const userPassword = sessionStorage.getItem('user_password')
										if (userPassword) {
											displayText = await MessageEncryption.decryptMessage(
												fullMessageData.text,
												userPassword
											)
										} else {
											displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
										}
									} catch (error) {
										console.error(
											'–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏:',
											error
										)
										displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
									}
								}
							} else {
								displayText = fullMessageData.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
							}
							replyContainer.dataset.messageId = fullMessageData.id
							replyContainer.innerHTML = `
                    <div class="reply-header">
                        <div class="reply-author">${
													isMyMessage
														? '–í—ã'
														: document.getElementById('chat-username')
																.textContent
												}</div>
                        <div class="reply-close">√ó</div>
                    </div>
                    <div class="reply-text">${
											displayText.length > 50
												? displayText.substring(0, 47) + '...'
												: displayText
										}</div>
                `

							replyContainer.classList.remove('hidden')
							document
								.querySelector('.message-input-container')
								.classList.add('expanded')
							replyContainer
								.querySelector('.reply-close')
								.addEventListener('click', async () => {
									await clearReplyState()
								})

							console.log(
								'–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è —á–∞—Ç–∞:',
								currentChatUserId
							)
						}
					} else {
						console.log(
							'–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª–æ:',
							replyState.message
						)
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:', error)
				}
			}

			// –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç

			async function getDecryptedMessageText(messageData) {
				let text = messageData.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'

				if (messageData.is_encrypted) {
					try {
						const userPassword = sessionStorage.getItem('user_password')
						if (userPassword) {
							text = await MessageEncryption.decryptMessage(
								messageData.text,
								userPassword
							)
						} else {
							text = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
						}
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
						text = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
					}
				}

				return text
			}

			// –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞

			function showEncryptionIndicator() {
				const chatHeader = document.querySelector('.chat-header')
				if (chatHeader && !chatHeader.querySelector('.encryption-indicator')) {
					const indicator = document.createElement('div')
					indicator.className = 'encryption-indicator'
					indicator.innerHTML = 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ ECDH-AES-GCM'
					indicator.style.color = '#4CAF50'
					indicator.style.fontSize = '12px'
					indicator.style.marginLeft = '10px'
					indicator.style.fontWeight = 'bold'
					chatHeader.appendChild(indicator)
				}
			}

			// –°–∫—Ä—ã—Ç–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞

			function hideEncryptionIndicator() {
				const indicator = document.querySelector('.encryption-indicator')
				if (indicator) {
					indicator.remove()
				}
			}

			// –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞

			async function openChat(userId) {
				console.log('=== –ù–ê–ß–ê–õ–û openChat ===')
				console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:', userId)

				const currentUserId = localStorage.getItem('user_id')
				const userPassword = sessionStorage.getItem('user_password')
				if (
					currentChatUserId === userId &&
					!document
						.getElementById('chat-container')
						.classList.contains('hidden')
				) {
					console.log('–ß–∞—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º')
					await updateUserStatus()
					return
				}
				if (readStatusInterval) {
					clearInterval(readStatusInterval)
					readStatusInterval = null
				}
				if (statusUpdateInterval) {
					clearInterval(statusUpdateInterval)
					statusUpdateInterval = null
				}
				if (currentChatUserId) {
					try {
						const messagesWrapper = document.getElementById(
							'chat-messages-wrapper'
						)
						if (messagesWrapper) {
							scrollPositions[currentChatUserId] = messagesWrapper.scrollTop
						}

						const currentText = document.getElementById('message-input').value
						if (currentText.trim()) {
							await eel.save_draft_message(
								currentUserId,
								currentChatUserId,
								currentText
							)()
						}
						chatInputs[currentChatUserId] = currentText
					} catch (error) {
						console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞:', error)
					}
				}
				stopVoiceMessage()
				await clearReplyState()
				dateHeaders.clear()
				currentStickyDate = null
				currentChatUserId = userId

				try {
					const user = await eel.get_user_data(userId)()

					if (!user) {
						console.error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω')
						alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω')
						return
					}
					document.getElementById('default-content').classList.add('hidden')
					document.getElementById('chat-container').classList.remove('hidden')
					const chatUsername = document.getElementById('chat-username')
					if (chatUsername) {
						chatUsername.textContent =
							userId === currentUserId ? '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ' : user.nickname
					}
					await updateUserStatus()
					if (userId !== currentUserId && userPassword) {
						try {
							const peerKeyResult = await eel.get_public_key(userId)()
							if (peerKeyResult.success) {
								try {
									const sharedResult = await eel.compute_shared_secret(
										currentUserId,
										peerKeyResult.public_key,
										userPassword
									)()

									if (sharedResult.success) {
										console.log('ECDH —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ')
										showEncryptionIndicator()
									} else {
										console.warn(
											'–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –æ–±—â–∏–π —Å–µ–∫—Ä–µ—Ç:',
											sharedResult.message
										)
										hideEncryptionIndicator()
									}
								} catch (secretError) {
									console.warn('–û—à–∏–±–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –æ–±—â–µ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞:', secretError)
									hideEncryptionIndicator()
								}
							} else {
								console.warn(
									'–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:',
									peerKeyResult.message
								)
								hideEncryptionIndicator()
							}
							try {
								await eel.mark_chat_messages_as_read(currentUserId, userId)()
							} catch (readError) {
								console.warn(
									'–û—à–∏–±–∫–∞ –ø–æ–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:',
									readError
								)
							}
						} catch (encryptionError) {
							console.error(
								'–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ECDH —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:',
								encryptionError
							)
							hideEncryptionIndicator()
						}
					} else {
						hideEncryptionIndicator()
					}
					initCustomScroll()
					const messagesContainer = document.getElementById('chat-messages')
					if (messagesContainer) {
						messagesContainer.innerHTML = ''
						dateHeaders.clear()
						if (window.messageElements) {
							window.messageElements.clear()
						}
					}
					try {
						await loadEcdhChatHistory(userId)
					} catch (historyError) {
						console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', historyError)
						if (messagesContainer) {
							messagesContainer.innerHTML = `
                    <div class="error-message">
                        <div style="color: #f44336; font-weight: bold;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞</div>
                        <div style="margin-top: 10px;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π.</div>
                        <button onclick="window.location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        </button>
                    </div>
                `
						}
					}
					try {
						const draftText = await eel.get_draft_message(
							currentUserId,
							userId
						)()
						const messageInput = document.getElementById('message-input')
						if (messageInput) {
							messageInput.value = draftText || chatInputs[userId] || ''
							messageInput.focus()
						}
					} catch (draftError) {
						console.warn('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞:', draftError)
					}
					try {
						await checkAndRestoreReplyState()
					} catch (replyError) {
						console.warn('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:', replyError)
					}
					readStatusInterval = setInterval(updateReadStatus, 2000)
					updateReadStatus()
					statusUpdateInterval = setInterval(updateUserStatus, 5000)
					document.querySelectorAll('.user-bar').forEach(el => {
						el.classList.remove('active-chat')
					})
					const userCard = document.querySelector(
						`.user-bar[data-user-id="${userId}"]`
					)
					if (userCard) {
						userCard.classList.add('active-chat')
						setTimeout(() => {
							userCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' })
						}, 100)
					}
					setTimeout(() => {
						const messagesWrapper = document.getElementById(
							'chat-messages-wrapper'
						)
						if (messagesWrapper && scrollPositions[userId]) {
							messagesWrapper.scrollTop = scrollPositions[userId]
						} else if (messagesWrapper) {
							messagesWrapper.scrollTop = messagesWrapper.scrollHeight
						}
						updateStickyDateHeaders()
					}, 100)
					window.addEventListener('resize', updateStickyDateHeaders)
					setTimeout(() => checkForNewMessages(), 3000)

					console.log('=== –ß–∞—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç ===')
				} catch (error) {
					console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞:', error)
					if (currentChatUserId) {
						const previousUserCard = document.querySelector(
							`.user-bar[data-user-id="${currentChatUserId}"]`
						)
						if (previousUserCard) {
							previousUserCard.classList.add('active-chat')
						}
					}
					alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç: ' + error.message)
					document.getElementById('default-content').classList.remove('hidden')
					document.getElementById('chat-container').classList.add('hidden')
					currentChatUserId = null
				}
			}

			// –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

			async function updateUserStatus() {
				if (!currentChatUserId) return

				try {
					const user = await eel.get_user_data(currentChatUserId)()
					if (!user) return

					const statusElement = document.getElementById('chat-status')
					const now = new Date()
					const lastOnline = new Date(user.last_online + ' UTC')

					const diffMinutes = Math.floor((now - lastOnline) / (1000 * 60))

					if (currentChatUserId === localStorage.getItem('user_id')) {
						statusElement.textContent = ''
						statusElement.classList.remove('online')
					} else if (diffMinutes < 5) {
						statusElement.textContent = '–í —Å–µ—Ç–∏'
						statusElement.classList.add('online')
					} else {
						statusElement.textContent = `–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏ ${formatTimeAgo(
							lastOnline
						)}`
						statusElement.classList.remove('online')
					}

					updateOnlineStatusInContacts()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error)
				}
			}

			// –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤

			function updateOnlineStatusInContacts() {
				const userBars = document.querySelectorAll(
					'.user-bar:not(.current-user)'
				)
				userBars.forEach(async bar => {
					const userId = bar.dataset.userId
					try {
						const user = await eel.get_user_data(userId)()
						if (user) {
							const now = new Date()
							const lastOnline = new Date(user.last_online + ' UTC')
							const diffMinutes = Math.floor((now - lastOnline) / (1000 * 60))

							const avatar = bar.querySelector('.avatar-medium')
							if (diffMinutes < 5) {
								avatar.classList.add('online')
							} else {
								avatar.classList.remove('online')
							}
						}
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞:', error)
					}
				})
			}

			// –í—Ä–µ–º—è –Ω–∞–∑–∞–¥

			function formatTimeAgo(date) {
				const now = new Date()
				const diff = Math.floor((now - date) / 1000)

				if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ'
				if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω. –Ω–∞–∑–∞–¥`
				if (diff < 86400) return `${Math.floor(diff / 3600)} —á. –Ω–∞–∑–∞–¥`

				const days = Math.floor(diff / 86400)
				if (days === 1) return '–≤—á–µ—Ä–∞'
				if (days < 7) return `${days} –¥–Ω. –Ω–∞–∑–∞–¥`

				return date.toLocaleDateString('ru-RU', {
					day: 'numeric',
					month: 'long',
					year: 'numeric',
				})
			}

			// –°—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è

			async function updateReadStatus() {
				if (!currentChatUserId) return

				try {
					const myMessages = Array.from(
						document.querySelectorAll('.my-message')
					)
						.map(el => el.dataset.id)
						.filter(id => id)

					if (myMessages.length === 0) return

					const readStatus = await eel.check_message_read_status(myMessages)()

					for (const [messageId, isRead] of Object.entries(readStatus)) {
						const messageElement = document.querySelector(
							`.message[data-id="${messageId}"]`
						)
						if (messageElement) {
							const infoElement = messageElement.querySelector('.message-info')
							if (infoElement) {
								const timeElement = infoElement.querySelector('span')
								const existingStatus = infoElement.querySelector('.read-status')

								if (existingStatus) {
									existingStatus.textContent = isRead ? '‚úì‚úì' : '‚úì'
									existingStatus.style.color = isRead ? '#4CAF50' : '#999'
								} else if (timeElement) {
									const readStatusElement = document.createElement('span')
									readStatusElement.className = 'read-status'
									readStatusElement.textContent = isRead ? '‚úì‚úì' : '‚úì'
									readStatusElement.style.color = isRead ? '#4CAF50' : '#999'
									readStatusElement.style.marginLeft = '5px'
									infoElement.appendChild(readStatusElement)
								}
							}
						}
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è:', error)
				}
			}

			// –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

			async function updateLastMessageOnUserCard(
				userId,
				messageText,
				isMyMessage = false
			) {
				const userCard = document.querySelector(
					`.user-bar[data-user-id="${userId}"]`
				)
				if (!userCard) return

				const lastMsgDiv = userCard.querySelector('.last-message')
				const contentWrapper = userCard.querySelector('.user-content-wrapper')

				let displayText = messageText || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'

				if (displayText.length > 25) {
					displayText = displayText.substring(0, 22) + '...'
				}

				if (isMyMessage) {
					if (lastMsgDiv) {
						lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
					} else if (contentWrapper) {
						const newLastMsgDiv = document.createElement('div')
						newLastMsgDiv.className = 'last-message'
						newLastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
						contentWrapper.appendChild(newLastMsgDiv)
					}
				} else {
					if (lastMsgDiv) {
						lastMsgDiv.textContent = displayText
					} else if (contentWrapper) {
						const newLastMsgDiv = document.createElement('div')
						newLastMsgDiv.className = 'last-message'
						newLastMsgDiv.textContent = displayText
						contentWrapper.appendChild(newLastMsgDiv)
					}
				}
			}

			// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

			async function addMessageToChat(
				message,
				isMyMessage,
				scrollToBottom = true
			) {
				const messagesContainer = document.getElementById('chat-messages')

				if (!messagesContainer) {
					console.error('Messages container not found')
					return null
				}
				if (message.id) {
					const existingMessage = document.querySelector(
						`.message[data-id="${message.id}"]`
					)
					if (existingMessage) {
						console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', message.id)
						if (isMyMessage && message.read !== undefined) {
							const readStatus = existingMessage.querySelector('.read-status')
							if (readStatus) {
								readStatus.textContent = message.read ? '‚úì‚úì' : '‚úì'
								readStatus.style.color = message.read ? '#4CAF50' : '#999'
							}
						}

						return existingMessage
					}
					if (
						window.messageElements &&
						window.messageElements.has(message.id)
					) {
						console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –≤ –∫—ç—à–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', message.id)
						return window.messageElements.get(message.id)
					}
				}
				const noMessagesDiv = messagesContainer.querySelector('.no-messages')
				if (noMessagesDiv) {
					noMessagesDiv.remove()
				}

				if (!message) {
					console.error('Message is null or undefined')
					return null
				}
				const messageTimestamp = message.timestamp || new Date().toISOString()
				const dateKey = new Date(messageTimestamp).toDateString()
				if (!dateHeaders.has(dateKey)) {
					const dateText = formatMessageDate(messageTimestamp)
					const dateHeader = createDateHeader(dateText, dateKey)
					const messages = Array.from(messagesContainer.children)
					let insertIndex = messages.length

					for (let i = 0; i < messages.length; i++) {
						const msg = messages[i]
						if (msg.dataset.timestamp) {
							const msgDateKey = new Date(msg.dataset.timestamp).toDateString()
							if (new Date(msgDateKey) > new Date(dateKey)) {
								insertIndex = i
								break
							}
						}
					}

					if (insertIndex < messages.length) {
						messagesContainer.insertBefore(dateHeader, messages[insertIndex])
					} else {
						messagesContainer.appendChild(dateHeader)
					}

					dateHeaders.set(dateKey, dateHeader)
				}
				const messageElement = document.createElement('div')
				messageElement.className = `message ${
					isMyMessage ? 'my-message' : 'their-message'
				}`
				messageElement.dataset.id = message.id || ''
				messageElement.dataset.sender_id = message.sender_id || ''
				messageElement.dataset.timestamp = messageTimestamp
				messageElement.dataset.encryption_type = message.encryption_type || ''
				if (message.reply_to_message_id || message.replied_message) {
					messageElement.classList.add('with-reply')
				}
				const messageContent = document.createElement('div')
				messageContent.className = 'message-content'
				if (message.reply_to_message_id || message.replied_message) {
					const replyPreview = document.createElement('div')
					replyPreview.className = 'reply-preview'

					let repliedText = '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
					let replyAuthor = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'
					if (message.replied_message && message.replied_message.text) {
						repliedText = message.replied_message.text
						replyAuthor =
							message.replied_message.sender_id ===
							localStorage.getItem('user_id')
								? '–í—ã'
								: document.getElementById('chat-username')?.textContent ||
								  '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'
					} else if (message.reply_to_message_id) {
						try {
							const repliedMessage = await getFullEcdhMessageData(
								message.reply_to_message_id
							)

							if (repliedMessage) {
								if (repliedMessage.is_encrypted) {
									if (
										repliedMessage.encryption_type === 'ECDH-AES-GCM' &&
										repliedMessage.ciphertext &&
										repliedMessage.nonce
									) {
										try {
											const userId = localStorage.getItem('user_id')
											const password = sessionStorage.getItem('user_password')

											if (password) {
												repliedText = await decryptEcdhMessage(
													repliedMessage.ciphertext,
													repliedMessage.nonce,
													userId,
													repliedMessage.sender_id === userId
														? repliedMessage.receiver_id
														: repliedMessage.sender_id,
													password,
													repliedMessage.sender_id === userId
												)
											} else {
												repliedText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
											}
										} catch (decryptError) {
											console.error(
												'–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:',
												decryptError
											)
											repliedText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
										}
									} else {
										const userPassword = sessionStorage.getItem('user_password')
										if (userPassword) {
											repliedText = await MessageEncryption.decryptMessage(
												repliedMessage.text || repliedMessage.ciphertext || '',
												userPassword
											)
										} else {
											repliedText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
										}
									}
								} else {
									repliedText = repliedMessage.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
								}

								replyAuthor =
									repliedMessage.sender_id === localStorage.getItem('user_id')
										? '–í—ã'
										: document.getElementById('chat-username')?.textContent ||
										  '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'
							}
						} catch (error) {
							console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞:', error)
							repliedText = '[–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å]'
						}
					}
					const displayRepliedText =
						repliedText.length > 50
							? repliedText.substring(0, 47) + '...'
							: repliedText
					replyPreview.innerHTML = `
            <div class="reply-author">${replyAuthor}</div>
            <div class="reply-text">${displayRepliedText}</div>
        `
					replyPreview.addEventListener('click', function () {
						const originalMessage = document.querySelector(
							`.message[data-id="${message.reply_to_message_id}"]`
						)
						if (originalMessage) {
							originalMessage.scrollIntoView({
								behavior: 'smooth',
								block: 'center',
							})
							originalMessage.style.backgroundColor = isMyMessage
								? '#c8e6c9'
								: '#e3f2fd'
							originalMessage.style.transition = 'background-color 0.3s'

							setTimeout(() => {
								originalMessage.style.backgroundColor = ''
							}, 1000)
						}
					})

					messageContent.appendChild(replyPreview)
				}
				const textElement = document.createElement('div')
				textElement.className = 'message-text'
				let displayText = message.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
				if (
					message.is_encrypted &&
					message.ciphertext &&
					message.nonce &&
					message.encryption_type === 'ECDH-AES-GCM'
				) {
					try {
						const userId = localStorage.getItem('user_id')
						const password = sessionStorage.getItem('user_password')

						if (password) {
							displayText = await decryptEcdhMessage(
								message.ciphertext,
								message.nonce,
								userId,
								message.sender_id === userId
									? message.receiver_id
									: message.sender_id,
								password,
								message.sender_id === userId
							)
						} else {
							displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
						}
					} catch (decryptError) {
						console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', decryptError)
						displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
					}
				} else if (message.is_encrypted && message.text) {
					try {
						const userPassword = sessionStorage.getItem('user_password')
						if (userPassword) {
							displayText = await MessageEncryption.decryptMessage(
								message.text,
								userPassword
							)
						} else {
							displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
						}
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
						displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
					}
				} else if (message.isMedia || message.is_media) {
					if (message.mediaType === 'video' || message.is_video) {
						displayText = 'üé• [–í–∏–¥–µ–æ]'
					} else {
						displayText = 'üñºÔ∏è [–§–æ—Ç–æ]'
					}
				} else if (message.isVoiceMessage || message.is_voice) {
					displayText = 'üé§ [–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
				}

				textElement.textContent = displayText
				messageContent.appendChild(textElement)
				const infoElement = document.createElement('div')
				infoElement.className = 'message-info'
				const timeElement = document.createElement('span')
				timeElement.textContent = formatMessageTime(messageTimestamp)
				infoElement.appendChild(timeElement)
				if (isMyMessage) {
					const readStatus = document.createElement('span')
					readStatus.textContent = message.read ? '‚úì‚úì' : '‚úì'
					readStatus.className = 'read-status'
					readStatus.style.color = message.read ? '#4CAF50' : '#999'
					readStatus.style.marginLeft = '5px'
					infoElement.appendChild(readStatus)
				}

				messageContent.appendChild(infoElement)
				messageElement.appendChild(messageContent)
				messageElement.addEventListener('contextmenu', e => {
					e.preventDefault()
					currentContextMessage = messageElement

					const isMyMessage =
						message.sender_id === localStorage.getItem('user_id')
					const isMediaMessage = message.isMedia || message.is_media
					const isVoiceMessage = message.isVoiceMessage || message.is_voice
					const contextMenu = document.getElementById('message-context-menu')

					if (contextMenu) {
						document
							.getElementById('message-edit')
							.classList.toggle(
								'hidden',
								!isMyMessage || isMediaMessage || isVoiceMessage
							)
						document
							.getElementById('message-delete')
							.classList.toggle('hidden', !isMyMessage)
						document
							.getElementById('message-delete-for-me')
							.classList.toggle('hidden', isMyMessage)
						document
							.getElementById('message-pin')
							.classList.toggle('hidden', !isMyMessage || isVoiceMessage)
						document
							.getElementById('message-reply')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-forward')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-copy')
							.classList.toggle('hidden', false)

						showMessageContextMenu(e)
					}
				})
				messageElement.addEventListener('dblclick', () => {
					if (message.sender_id !== localStorage.getItem('user_id')) {
						handleQuickReply(message)
					}
				})
				try {
					const messages = Array.from(messagesContainer.children)
					let insertIndex = messages.length

					for (let i = 0; i < messages.length; i++) {
						const msg = messages[i]
						if (msg.classList.contains('message') && msg.dataset.timestamp) {
							const msgTime = new Date(msg.dataset.timestamp)
							const newMsgTime = new Date(messageTimestamp)

							if (newMsgTime < msgTime) {
								insertIndex = i
								break
							}
						}
					}

					if (insertIndex < messages.length) {
						messagesContainer.insertBefore(
							messageElement,
							messages[insertIndex]
						)
					} else {
						messagesContainer.appendChild(messageElement)
					}
					if (message.id) {
						if (!window.messageElements) {
							window.messageElements = new Map()
						}
						window.messageElements.set(message.id, messageElement)
					}
				} catch (error) {
					console.error('Error adding message to container:', error)
					return null
				}
				if (scrollToBottom) {
					setTimeout(() => {
						const messagesWrapper = document.getElementById(
							'chat-messages-wrapper'
						)
						if (messagesWrapper) {
							messagesWrapper.scrollTop = messagesWrapper.scrollHeight
							setTimeout(updateStickyDateHeaders, 100)
						}
					}, 0)
				}
				if (message.isVoiceMessage || message.is_voice) {
					await updateVoiceMessageStatus(messageElement, message)
				}

				return messageElement
			}

			// –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç

			async function handleQuickReply(message) {
				const messageInput = document.getElementById('message-input')
				messageInput.focus()
				const replyContainer = document.getElementById('reply-container')

				if (replyContainer) {
					const isMyMessage =
						message.sender_id === localStorage.getItem('user_id')
					const fullMessageData = await getFullEcdhMessageData(message.id)
					let displayText = '[–°–æ–æ–±—â–µ–Ω–∏–µ]'

					if (fullMessageData) {
						if (fullMessageData.is_encrypted) {
							if (
								fullMessageData.encryption_type === 'ECDH-AES-GCM' &&
								fullMessageData.ciphertext &&
								fullMessageData.nonce
							) {
								try {
									const userId = localStorage.getItem('user_id')
									const password = sessionStorage.getItem('user_password')

									if (password) {
										displayText = await decryptEcdhMessage(
											fullMessageData.ciphertext,
											fullMessageData.nonce,
											userId,
											fullMessageData.sender_id === userId
												? fullMessageData.receiver_id
												: fullMessageData.sender_id,
											password,
											fullMessageData.sender_id === userId
										)
									} else {
										displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
									}
								} catch (decryptError) {
									console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ:', decryptError)
									displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
								}
							} else {
								try {
									const userPassword = sessionStorage.getItem('user_password')
									if (userPassword) {
										displayText = await MessageEncryption.decryptMessage(
											fullMessageData.text,
											userPassword
										)
									} else {
										displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
									}
								} catch (error) {
									console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ:', error)
									displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
								}
							}
						} else {
							displayText = fullMessageData.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
						}
					}

					replyContainer.innerHTML = `
            <div class="reply-header">
                <div class="reply-author">${
									isMyMessage ? '–í—ã' : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'
								}</div>
                <div class="reply-close">√ó</div>
            </div>
            <div class="reply-text">${
							displayText.length > 50
								? displayText.substring(0, 47) + '...'
								: displayText
						}</div>
        `

					replyContainer.dataset.messageId = message.id
					replyContainer.classList.remove('hidden')
					document
						.querySelector('.message-input-container')
						.classList.add('expanded')

					replyContainer
						.querySelector('.reply-close')
						.addEventListener('click', async () => {
							await clearReplyState()
						})
					const saveResult = await eel.save_reply_state(
						localStorage.getItem('user_id'),
						currentChatUserId,
						message.id
					)()

					if (!saveResult.success) {
						console.error(
							'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞:',
							saveResult.message
						)
					}
				}
			}

			// –°—Ç–∞—Ç—É—Å –≥–æ–ª–æ—Å–∞

			async function updateVoiceMessageStatus(messageElement, message) {
				const voiceElement = messageElement.querySelector('.voice-message')
				if (voiceElement) {
					const indicator = voiceElement.querySelector('.listen-indicator')
					if (indicator) {
						indicator.style.opacity = message.listened ? '0' : '0.7'
					}
				}
			}

			// –ü—Ä–æ—á—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

			function updateMessageReadStatus(messageId, isRead) {
				if (window.messageElements && window.messageElements.has(messageId)) {
					const messageElement = window.messageElements.get(messageId)
					const readStatus = messageElement.querySelector('.read-status')
					if (readStatus) {
						readStatus.textContent = isRead ? '‚úì‚úì' : '‚úì'
						readStatus.style.color = isRead ? '#4CAF50' : '#999'
					}
				}
			}

			// –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

			function updateMessageText(messageId, newText) {
				if (window.messageElements && window.messageElements.has(messageId)) {
					const messageElement = window.messageElements.get(messageId)
					const textElement = messageElement.querySelector('.message-text')
					if (textElement) {
						textElement.textContent = newText
						const editBadge = document.createElement('span')
						editBadge.className = 'edit-badge'
						editBadge.textContent = ' (—Ä–µ–¥.)'
						editBadge.style.color = '#999'
						editBadge.style.fontSize = '0.8em'
						textElement.appendChild(editBadge)
					}
				}
			}

			// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

			async function checkForNewMessages() {
				if (!currentChatUserId) return

				try {
					const newMessages = await eel.check_new_messages(
						localStorage.getItem('user_id'),
						lastMessageId
					)()

					if (newMessages && newMessages.length > 0) {
						for (const msg of newMessages) {
							const existingMessage = document.querySelector(
								`.message[data-id="${msg.id}"]`
							)
							if (existingMessage) {
								console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', msg.id)
								continue
							}
							if (
								msg.sender_id === currentChatUserId &&
								msg.sender_id !== localStorage.getItem('user_id')
							) {
								await addMessageToChat(msg, false, true)
								updateLastMessageOnUserCard(currentChatUserId, msg.text, false)
							}
						}

						if (newMessages.length > 0) {
							lastMessageId = newMessages[newMessages.length - 1].id
						}

						const messagesContainer = document.getElementById('chat-messages')
						activeChats[currentChatUserId] = {
							messages: messagesContainer.innerHTML,
							lastMessageId: lastMessageId,
						}

						updateOnlineStatusInContacts()
						setupVoiceMessageHandlers()
					}
				} catch (error) {
					console.error('Error checking new messages:', error)
				}
			}

			// –ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π

			async function loadFriends() {
				console.log('=== –ù–ê–ß–ê–õ–û loadFriends ===')
				const user_id = localStorage.getItem('user_id')

				if (!user_id) {
					console.error('User ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage')
					return
				}

				try {
					currentUser = await eel.get_user_data(user_id)()
					const container = document.getElementById('user-container')
					container.innerHTML = ''
					const selfCard = createUserCard({
						user_id: user_id,
						nickname: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
						isCurrentUser: true,
						isSelfChat: true,
					})
					container.appendChild(selfCard)

					if (currentUser.friends && currentUser.friends.length > 0) {
						const friendPromises = currentUser.friends.map(async friendId => {
							try {
								const friend = await eel.get_user_data(friendId)()
								if (friend) {
									const lastMessage = await eel.get_last_message(
										user_id,
										friendId
									)()
									let decryptedText = '[–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π]'
									if (lastMessage) {
										if (lastMessage.is_encrypted) {
											try {
												const userPassword =
													sessionStorage.getItem('user_password')
												if (userPassword) {
													if (
														lastMessage.encryption_type === 'ECDH-AES-GCM' &&
														lastMessage.ciphertext &&
														lastMessage.nonce
													) {
														decryptedText = await decryptEcdhMessage(
															lastMessage.ciphertext,
															lastMessage.nonce,
															user_id,
															lastMessage.sender_id === user_id
																? friendId
																: lastMessage.sender_id,
															userPassword,
															lastMessage.sender_id === user_id
														)
													} else {
														decryptedText =
															await MessageEncryption.decryptMessage(
																lastMessage.text,
																userPassword
															)
													}
												} else {
													decryptedText = 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
												}
											} catch (decryptError) {
												console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', decryptError)
												decryptedText = 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
											}
										} else {
											decryptedText = lastMessage.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
										}
									}
									const lastMessageForCard = lastMessage
										? {
												...lastMessage,
												text: decryptedText,
												is_decrypted: true,
										  }
										: null

									return {
										user_id: friendId,
										nickname: friend.nickname,
										isFriend: true,
										lastMessage: lastMessageForCard,
									}
								}
							} catch (error) {
								console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–≥–∞:', friendId, error)
								return null
							}
						})
						const friendsData = await Promise.all(friendPromises)
						friendsData.forEach(friendData => {
							if (friendData) {
								const friendCard = createUserCard(friendData)
								container.appendChild(friendCard)
							}
						})

						updateOnlineStatusInContacts()
					} else {
						const noFriends = document.createElement('div')
						noFriends.className = 'no-friends'
						noFriends.textContent =
							'–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π. –ù–∞–π–¥–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫!'
						container.appendChild(noFriends)
					}
				} catch (error) {
					console.error('Error loading friends:', error)
				}
			}

			// –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

			function createUserCard(userData) {
				const card = document.createElement('div')
				card.className =
					'user-bar' + (userData.isCurrentUser ? ' current-user' : '')
				card.dataset.userId = userData.user_id

				const avatar = document.createElement('div')
				avatar.className = 'avatar-medium'

				if (userData.isSelfChat) {
					avatar.style.backgroundImage =
						'url(https://cdn-icons-png.flaticon.com/512/1077/1077114.png)'
					avatar.style.backgroundColor = '#4CAF50'
				} else {
					avatar.style.backgroundImage =
						'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)'
				}

				const contentWrapper = document.createElement('div')
				contentWrapper.className = 'user-content-wrapper'

				const username = document.createElement('div')
				username.className = 'username'

				if (userData.isSelfChat) {
					username.textContent = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ'
					username.style.fontWeight = 'bold'
					username.style.color = '#4CAF50'
				} else if (userData.isCurrentUser) {
					username.textContent = '–í—ã'
				} else {
					username.textContent = userData.nickname
				}

				contentWrapper.appendChild(username)
				if (
					userData.lastMessage &&
					!userData.isCurrentUser &&
					!userData.isSelfChat
				) {
					const lastMsgDiv = document.createElement('div')
					lastMsgDiv.className = 'last-message'

					let messageText = userData.lastMessage.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
					if (messageText.length > 25) {
						messageText = messageText.substring(0, 22) + '...'
					}

					if (
						userData.lastMessage.sender_id === localStorage.getItem('user_id')
					) {
						lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${messageText}`
					} else {
						lastMsgDiv.textContent = messageText
					}

					contentWrapper.appendChild(lastMsgDiv)
				}

				card.appendChild(avatar)
				card.appendChild(contentWrapper)
				card.addEventListener('click', function (e) {
					e.stopPropagation()
					const userId = userData.user_id

					if (
						currentChatUserId === userId &&
						!document
							.getElementById('chat-container')
							.classList.contains('hidden')
					) {
						updateUserStatus()
						return
					}

					openChat(userId)

					document.querySelectorAll('.user-bar').forEach(el => {
						el.classList.remove('active-chat')
					})
					card.classList.add('active-chat')
				})
				if (!userData.isSelfChat && !userData.isCurrentUser) {
					card.addEventListener('contextmenu', function (e) {
						e.preventDefault()
						showContextMenu(e, userData)
					})
				}

				return card
			}

			// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö

			async function loadAllLastMessages() {
				try {
					const user_id = localStorage.getItem('user_id')
					const userData = await eel.get_user_data(user_id)()

					if (!userData || !userData.friends || userData.friends.length === 0) {
						console.log('–ù–µ—Ç –¥—Ä—É–∑–µ–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π')
						return
					}

					console.log(
						`–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è ${userData.friends.length} –¥—Ä—É–∑–µ–π...`
					)

					const userPassword = sessionStorage.getItem('user_password')
					if (!userPassword) {
						console.warn(
							'–ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ sessionStorage. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ.'
						)
						return
					}
					for (const friendId of userData.friends) {
						try {
							const lastMessage = await eel.get_last_message(
								user_id,
								friendId
							)()

							if (lastMessage) {
								let displayText = lastMessage.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
								let isMyMessage = lastMessage.sender_id === user_id
								if (lastMessage.is_encrypted) {
									try {
										if (lastMessage.encryption_type === 'ECDH-AES-GCM') {
											if (lastMessage.ciphertext && lastMessage.nonce) {
												displayText = await decryptEcdhMessage(
													lastMessage.ciphertext,
													lastMessage.nonce,
													user_id,
													friendId,
													userPassword,
													isMyMessage
												)
											} else {
												displayText = 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
											}
										} else {
											displayText = await MessageEncryption.decryptMessage(
												lastMessage.text,
												userPassword
											)
										}
									} catch (decryptError) {
										console.error(
											`–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è ${friendId}:`,
											decryptError
										)
										displayText = 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
									}
								}
								updateLastMessageOnUserCard(friendId, displayText, isMyMessage)

								console.log(
									`–°–æ–æ–±—â–µ–Ω–∏–µ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${friendId}:`,
									displayText.substring(0, 30) + '...'
								)
							}
						} catch (friendError) {
							console.error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—Ä—É–≥–∞ ${friendId}:`, friendError)
						}
					}

					console.log('–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ')
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error)
				}
			}

			// –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é

			function showContextMenu(e, userData) {
				closeContextMenu()

				contextMenuTarget = userData.user_id

				const addBtn = document.getElementById('context-menu-add')
				const removeBtn = document.getElementById('context-menu-remove')

				if (currentUser.friends.includes(userData.user_id)) {
					addBtn.classList.add('hidden')
					removeBtn.classList.remove('hidden')
				} else {
					addBtn.classList.remove('hidden')
					removeBtn.classList.add('hidden')
				}

				contextMenu.style.display = 'block'
				contextMenu.style.left = `${e.pageX}px`
				contextMenu.style.top = `${e.pageY}px`
			}

			// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é

			function closeContextMenu() {
				if (contextMenu) {
					contextMenu.style.display = 'none'
				}
				contextMenuTarget = null
			}

			// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞

			async function handleAddFriend() {
				if (!contextMenuTarget) return

				const user_id = localStorage.getItem('user_id')
				try {
					const response = await eel.add_friend(user_id, contextMenuTarget)()

					if (response.success) {
						await loadFriends()
					}
					alert(response.message)
				} catch (error) {
					alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –¥—Ä—É–∑—å—è')
					console.error('Error adding friend:', error)
				}

				closeContextMenu()
			}

			// –£–¥–∞–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞

			async function handleRemoveFriend() {
				if (!contextMenuTarget) return

				const user_id = localStorage.getItem('user_id')
				try {
					const response = await eel.remove_friend(user_id, contextMenuTarget)()

					if (response.success) {
						await loadFriends()
						if (currentChatUserId === contextMenuTarget) {
							closeChat()
						}
					}
					alert(response.message)
				} catch (error) {
					alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –¥—Ä—É–∑–µ–π')
					console.error('Error removing friend:', error)
				}

				closeContextMenu()
			}

			// –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞

			async function displaySearchResults(users) {
				const container = document.getElementById('user-container')
				container.innerHTML = ''

				if (users.length === 0) {
					const noResults = document.createElement('div')
					noResults.className = 'no-results'
					noResults.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
					container.appendChild(noResults)
					return
				}

				const user_id = localStorage.getItem('user_id')

				for (const user of users) {
					const isFriend = currentUser.friends.includes(user.user_id)
					const lastMessage = await eel.get_last_message(
						user_id,
						user.user_id
					)()

					if (lastMessage && lastMessage.is_encrypted) {
						try {
							const userPassword = sessionStorage.getItem('user_password')
							if (userPassword) {
								const chatHistory = await eel.get_encrypted_chat_history(
									user_id,
									user.user_id
								)()
								if (
									chatHistory.success &&
									chatHistory.messages &&
									chatHistory.messages.length > 0
								) {
									const lastMsg =
										chatHistory.messages[chatHistory.messages.length - 1]
									if (lastMsg.is_encrypted && lastMsg.text) {
										const decryptedText =
											await MessageEncryption.decryptMessage(
												lastMsg.text,
												userPassword
											)
										lastMessage.text = decryptedText
									}
								}
							}
						} catch (error) {
							console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–∏—Å–∫–µ:', error)
						}
					}

					const userCard = createUserCard({
						user_id: user.user_id,
						nickname: user.nickname,
						isFriend: isFriend,
						lastMessage: lastMessage,
					})
					container.appendChild(userCard)
				}

				updateOnlineStatusInContacts()
			}

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫

			function initButtonHandlers() {
				const messageInput = document.getElementById('message-input')
				const menuIcon = document.querySelector('.menu-icon')
				if (menuIcon) {
					menuIcon.addEventListener('click', function () {
						document.getElementById('logout-overlay').classList.remove('hidden')
						document.getElementById('logout-modal').classList.remove('hidden')
					})
				}

				console.log('Button handlers initialized')
			}
			setTimeout(initButtonHandlers, 1000)

			// –ú–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è

			function initMessageContextMenu() {
				console.log('initMessageContextMenu –≤—ã–∑–≤–∞–Ω–∞')
				const messageContextMenu = document.getElementById(
					'message-context-menu'
				)
				window.messageContextMenu = messageContextMenu
				document.addEventListener('click', function (e) {
					if (messageContextMenu && !messageContextMenu.contains(e.target)) {
						messageContextMenu.classList.add('hidden')
					}
				})
				document.addEventListener('contextmenu', function (e) {
					const messageElement = e.target.closest('.message')
					if (messageElement) {
						e.preventDefault()
						currentContextMessage = messageElement

						const isVideoMessage =
							messageElement.querySelector('.video-preview') !== null
						const isVoiceMessage =
							messageElement.querySelector('.voice-message') !== null
						const isMyMessage = messageElement.classList.contains('my-message')
						document
							.getElementById('message-edit')
							.classList.toggle(
								'hidden',
								!isMyMessage || isVideoMessage || isVoiceMessage
							)
						document
							.getElementById('message-delete')
							.classList.toggle('hidden', !isMyMessage)
						document
							.getElementById('message-delete-for-me')
							.classList.toggle('hidden', isMyMessage)
						document
							.getElementById('message-pin')
							.classList.toggle('hidden', !isMyMessage || isVoiceMessage)
						document
							.getElementById('message-reply')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-forward')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-copy')
							.classList.toggle('hidden', false)
						const menuWidth = messageContextMenu.offsetWidth
						const menuHeight = messageContextMenu.offsetHeight
						const windowWidth = window.innerWidth
						const windowHeight = window.innerHeight

						let left = e.clientX
						let top = e.clientY
						if (left + menuWidth > windowWidth) {
							left = windowWidth - menuWidth - 5
						}

						if (top + menuHeight > windowHeight) {
							top = windowHeight - menuHeight - 5
						}

						messageContextMenu.style.left = `${left}px`
						messageContextMenu.style.top = `${top}px`
						messageContextMenu.style.display = 'block'
						messageContextMenu.classList.remove('hidden')
						messageContextMenu.style.zIndex = '1000'
					}
				})

				// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é

				function closeMessageContextMenu() {
					if (messageContextMenu) {
						messageContextMenu.classList.add('hidden')
					}
				}
				document
					.getElementById('message-reply')
					.addEventListener('click', function () {
						handleReply()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-edit')
					.addEventListener('click', function () {
						handleEdit()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-pin')
					.addEventListener('click', function () {
						handlePin()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-delete')
					.addEventListener('click', function () {
						handleDelete()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-forward')
					.addEventListener('click', function () {
						handleForward()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-copy')
					.addEventListener('click', function () {
						handleCopy()
						closeMessageContextMenu()
					})

				// –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

				async function handleReply() {
					if (!currentContextMessage) return

					try {
						const messageId = currentContextMessage.dataset.id
						const isMyMessage =
							currentContextMessage.classList.contains('my-message')
						const replyContainer = document.getElementById('reply-container')
						const messageData = await getFullEcdhMessageData(messageId)
						let displayText = '[–°–æ–æ–±—â–µ–Ω–∏–µ]'

						if (messageData) {
							if (messageData.is_encrypted) {
								if (
									messageData.encryption_type === 'ECDH-AES-GCM' &&
									messageData.ciphertext &&
									messageData.nonce
								) {
									try {
										const userId = localStorage.getItem('user_id')
										const password = sessionStorage.getItem('user_password')

										if (password) {
											displayText = await decryptEcdhMessage(
												messageData.ciphertext,
												messageData.nonce,
												userId,
												messageData.sender_id === userId
													? messageData.receiver_id
													: messageData.sender_id,
												password,
												messageData.sender_id === userId
											)
										} else {
											displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
										}
									} catch (decryptError) {
										console.error(
											'–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è ECDH —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ:',
											decryptError
										)
										displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
									}
								} else if (messageData.text) {
									try {
										const userPassword = sessionStorage.getItem('user_password')
										if (userPassword) {
											displayText = await MessageEncryption.decryptMessage(
												messageData.text,
												userPassword
											)
										} else {
											displayText = '[–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
										}
									} catch (error) {
										console.error(
											'–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:',
											error
										)
										displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å]'
									}
								}
							} else {
								displayText = messageData.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
							}
						}
						const saveResult = await eel.save_reply_state(
							localStorage.getItem('user_id'),
							currentChatUserId,
							messageId
						)()

						if (!saveResult.success) {
							console.error(
								'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞:',
								saveResult.message
							)
						}

						replyContainer.dataset.messageId = messageId
						replyContainer.innerHTML = `
            <div class="reply-header">
                <div class="reply-author">${
									isMyMessage
										? '–í—ã'
										: document.getElementById('chat-username').textContent
								}</div>
                <div class="reply-close">√ó</div>
            </div>
            <div class="reply-text">${
							displayText.length > 50
								? displayText.substring(0, 47) + '...'
								: displayText
						}</div>
        `

						replyContainer.classList.remove('hidden')
						document
							.querySelector('.message-input-container')
							.classList.add('expanded')
						replyContainer
							.querySelector('.reply-close')
							.addEventListener('click', async () => {
								await clearReplyState()
							})

						const messageInput = document.getElementById('message-input')
						messageInput.focus()
						messageInput.value = ''

						console.log(
							'–°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è —á–∞—Ç–∞:',
							currentChatUserId
						)
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞:', error)
						alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞')
					}
				}

				// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

				function handleEdit() {
					if (!currentContextMessage) {
						messageContextMenu.classList.add('hidden')
						return
					}

					try {
						const messageId = currentContextMessage.dataset.id
						const messageTextElement =
							currentContextMessage.querySelector('.message-text')
						const originalText = messageTextElement.textContent
						const input = document.createElement('input')
						input.type = 'text'
						input.value = originalText
						input.className = 'edit-message-input'
						messageTextElement.replaceWith(input)
						input.focus()
						const finishEditing = async newText => {
							if (newText && newText !== originalText) {
								const result = await eel.edit_message(messageId, newText)()
								if (!result.success) {
									throw new Error(
										result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'
									)
								}
								return newText
							}
							return originalText
						}
						const handleKeyDown = async e => {
							if (e.key === 'Enter') {
								const newText = input.value.trim()
								try {
									const finalText = await finishEditing(newText)
									messageTextElement.textContent = finalText
								} catch (error) {
									alert(error.message)
									messageTextElement.textContent = originalText
								}
								cleanup()
							} else if (e.key === 'Escape') {
								messageTextElement.textContent = originalText
								cleanup()
							}
						}

						// –ü–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞

						const handleBlur = async () => {
							const newText = input.value.trim()
							try {
								const finalText = await finishEditing(newText)
								messageTextElement.textContent = finalText
							} catch (error) {
								alert(error.message)
								messageTextElement.textContent = originalText
							}
							cleanup()
						}

						// –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

						const cleanup = () => {
							input.replaceWith(messageTextElement)
							input.removeEventListener('keydown', handleKeyDown)
							input.removeEventListener('blur', handleBlur)
							messageContextMenu.classList.add('hidden')
						}

						input.addEventListener('keydown', handleKeyDown)
						input.addEventListener('blur', handleBlur)
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error)
						alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è')
						messageContextMenu.classList.add('hidden')
					}
				}

				// –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

				function handlePin() {
					alert('–§—É–Ω–∫—Ü–∏—è "–ó–∞–∫—Ä–µ–ø–∏—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					messageContextMenu.classList.add('hidden')
				}

				eel.expose(get_current_user_id)

				// ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

				function get_current_user_id() {
					return localStorage.getItem('user_id')
				}

				// –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

				function handleForward() {
					alert('–§—É–Ω–∫—Ü–∏—è "–ü–µ—Ä–µ—Å–ª–∞—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					messageContextMenu.classList.add('hidden')
				}

				// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è

				function handleCopy() {
					if (!currentContextMessage) {
						messageContextMenu.classList.add('hidden')
						return
					}

					try {
						const messageText =
							currentContextMessage.querySelector('.message-text').textContent
						navigator.clipboard
							.writeText(messageText)
							.then(() => {
								console.log('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞')
							})
							.catch(err => {
								console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err)
								alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç')
							})
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', error)
						alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞')
					} finally {
						messageContextMenu.classList.add('hidden')
					}
				}
			}

			// –ü–æ–∫–∞–∑ –º–µ–Ω—é

			function showMessageContextMenu(e) {
				const messageContextMenu = document.getElementById(
					'message-context-menu'
				)
				if (!messageContextMenu) return

				messageContextMenu.classList.add('hidden')

				const menuWidth = messageContextMenu.offsetWidth
				const menuHeight = messageContextMenu.offsetHeight
				const windowWidth = window.innerWidth
				const windowHeight = window.innerHeight

				let left = e.clientX
				let top = e.clientY

				if (left + menuWidth > windowWidth) {
					left = windowWidth - menuWidth - 5
				}

				if (top + menuHeight > windowHeight) {
					top = windowHeight - menuHeight - 5
				}

				messageContextMenu.style.left = `${left}px`
				messageContextMenu.style.top = `${top}px`
				messageContextMenu.style.display = 'block'
				messageContextMenu.classList.remove('hidden')
				messageContextMenu.style.zIndex = '1000'
			}
			window.showMessageContextMenu = showMessageContextMenu
			document.addEventListener('DOMContentLoaded', function () {
				initMessageContextMenu()
			})
			document.getElementById('message-reply').addEventListener('click', () => {
				if (currentContextMessage) {
					const messageText =
						currentContextMessage.querySelector('.message-text').textContent
					const messageInput = document.getElementById('message-input')
					messageInput.value = `–û—Ç–≤–µ—Ç –Ω–∞: "${messageText}" `
					messageInput.focus()
				}
				messageContextMenu.classList.add('hidden')
			})

			document
				.getElementById('message-edit')
				.addEventListener('click', async () => {
					if (currentContextMessage) {
						const messageId = currentContextMessage.dataset.id
						const messageText =
							currentContextMessage.querySelector('.message-text')
						const originalText = messageText.textContent
						const input = document.createElement('input')
						input.type = 'text'
						input.value = originalText
						input.className = 'edit-message-input'
						messageText.replaceWith(input)
						input.focus()
						const handleEdit = async e => {
							if (e.key === 'Enter' || e.type === 'blur') {
								const newText = input.value.trim()
								if (newText && newText !== originalText) {
									try {
										const result = await eel.edit_message(messageId, newText)()
										if (result.success) {
											messageText.textContent = newText
										} else {
											alert(result.message)
											messageText.textContent = originalText
										}
									} catch (error) {
										console.error('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error)
										messageText.textContent = originalText
									}
								} else {
									messageText.textContent = originalText
								}

								input.replaceWith(messageText)
								input.removeEventListener('keydown', handleEdit)
								input.removeEventListener('blur', handleEdit)
							} else if (e.key === 'Escape') {
								messageText.textContent = originalText
								input.replaceWith(messageText)
								input.removeEventListener('keydown', handleEdit)
								input.removeEventListener('blur', handleEdit)
							}
						}

						input.addEventListener('keydown', handleEdit)
						input.addEventListener('blur', handleEdit)
					}
					messageContextMenu.classList.add('hidden')
				})

			document.getElementById('message-pin').addEventListener('click', () => {
				if (currentContextMessage) {
					alert('–§—É–Ω–∫—Ü–∏—è "–ó–∞–∫—Ä–µ–ø–∏—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
				}
				messageContextMenu.classList.add('hidden')
			})

			document
				.getElementById('message-delete')
				.addEventListener('click', async () => {
					if (currentContextMessage) {
						if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
							const messageId = currentContextMessage.dataset.id
							try {
								const result = await eel.delete_message(messageId)()
								if (result.success) {
									currentContextMessage.remove()
								} else {
									alert(result.message)
								}
							} catch (error) {
								console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error)
								alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è')
							}
						}
					}
					messageContextMenu.classList.add('hidden')
				})

			document
				.getElementById('message-forward')
				.addEventListener('click', () => {
					if (currentContextMessage) {
						alert('–§—É–Ω–∫—Ü–∏—è "–ü–µ—Ä–µ—Å–ª–∞—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					}
					messageContextMenu.classList.add('hidden')
				})

			document.getElementById('message-copy').addEventListener('click', () => {
				if (currentContextMessage) {
					const messageText =
						currentContextMessage.querySelector('.message-text').textContent
					navigator.clipboard
						.writeText(messageText)
						.then(() => {
							console.log('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')
						})
						.catch(err => {
							console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err)
						})
				}
				messageContextMenu.classList.add('hidden')
			})
			const style = document.createElement('style')
			style.textContent = `
    .edit-message-input {
        width: 100%;
        padding: 5px;
        border: 1px solid #4CAF50;
        border-radius: 4px;
        font-size: 14px;
    }
`
			document.head.appendChild(style)
			const photoBtn = document.getElementById('photo-message-btn')
			const photoOptionsMenu = document.getElementById('photo-options-menu')
			const fileInput = document.getElementById('file-input')
			const mediaSendModal = document.getElementById('media-send-modal')
			const mediaSendOverlay = document.getElementById('media-send-overlay')
			const mediaSendTitle = document.getElementById('media-send-title')
			const imagePreview = document.getElementById('image-preview')
			const videoPreview = document.getElementById('video-preview')
			const mediaCaptionInput = document.getElementById('media-caption-input')
			const mediaAddButton = document.getElementById('media-add-button')
			const mediaCancelButton = document.getElementById('media-cancel-button')
			const mediaSendButton = document.getElementById('media-send-button')

			let currentMediaType = 'photo'
			let photoMenuTimeout
			photoBtn.addEventListener('mouseenter', () => {
				clearTimeout(photoMenuTimeout)
				positionPhotoMenu()
				photoOptionsMenu.classList.remove('hidden')
				photoOptionsMenu.classList.add('show')
			})
			photoBtn.addEventListener('mouseleave', () => {
				photoMenuTimeout = setTimeout(() => {
					photoOptionsMenu.classList.remove('show')
				}, 200)
			})
			photoOptionsMenu.addEventListener('mouseenter', () => {
				clearTimeout(photoMenuTimeout)
			})
			photoOptionsMenu.addEventListener('mouseleave', () => {
				photoOptionsMenu.classList.remove('show')
			})
			document.querySelectorAll('.photo-option').forEach(option => {
				option.addEventListener('click', function () {
					const type = this.dataset.type
					if (type === 'photo-video') {
						openFileSelector()
					} else {
						alert(`–í—ã–±—Ä–∞–Ω–∞ –æ–ø—Ü–∏—è: ${this.querySelector('span').textContent}`)
					}
					photoOptionsMenu.classList.remove('show')
				})
			})

			// –î–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

			function formatMessageDate(timestamp) {
				const messageDate = new Date(timestamp)
				const today = new Date()
				const yesterday = new Date(today)
				yesterday.setDate(yesterday.getDate() - 1)
				const twoDaysAgo = new Date(today)
				twoDaysAgo.setDate(twoDaysAgo.getDate() - 2)
				const messageDateOnly = new Date(
					messageDate.getFullYear(),
					messageDate.getMonth(),
					messageDate.getDate()
				)
				const todayOnly = new Date(
					today.getFullYear(),
					today.getMonth(),
					today.getDate()
				)
				const yesterdayOnly = new Date(
					yesterday.getFullYear(),
					yesterday.getMonth(),
					yesterday.getDate()
				)
				const twoDaysAgoOnly = new Date(
					twoDaysAgo.getFullYear(),
					twoDaysAgo.getMonth(),
					twoDaysAgo.getDate()
				)

				if (messageDateOnly.getTime() === todayOnly.getTime()) {
					return '–°–µ–≥–æ–¥–Ω—è'
				} else if (messageDateOnly.getTime() === yesterdayOnly.getTime()) {
					return '–í—á–µ—Ä–∞'
				} else if (messageDateOnly.getTime() === twoDaysAgoOnly.getTime()) {
					return '–ü–æ–∑–∞–≤—á–µ—Ä–∞'
				} else {
					const startOfWeek = new Date(today)
					startOfWeek.setDate(today.getDate() - today.getDay())
					startOfWeek.setHours(0, 0, 0, 0)

					if (messageDate >= startOfWeek) {
						const days = [
							'–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ',
							'–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
							'–í—Ç–æ—Ä–Ω–∏–∫',
							'–°—Ä–µ–¥–∞',
							'–ß–µ—Ç–≤–µ—Ä–≥',
							'–ü—è—Ç–Ω–∏—Ü–∞',
							'–°—É–±–±–æ—Ç–∞',
						]
						return days[messageDate.getDay()]
					} else {
						const months = [
							'—è–Ω–≤–∞—Ä—è',
							'—Ñ–µ–≤—Ä–∞–ª—è',
							'–º–∞—Ä—Ç–∞',
							'–∞–ø—Ä–µ–ª—è',
							'–º–∞—è',
							'–∏—é–Ω—è',
							'–∏—é–ª—è',
							'–∞–≤–≥—É—Å—Ç–∞',
							'—Å–µ–Ω—Ç—è–±—Ä—è',
							'–æ–∫—Ç—è–±—Ä—è',
							'–Ω–æ—è–±—Ä—è',
							'–¥–µ–∫–∞–±—Ä—è',
						]
						return `${messageDate.getDate()} ${
							months[messageDate.getMonth()]
						} ${messageDate.getFullYear()}`
					}
				}
			}

			// –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã

			function createDateHeader(dateText, dateKey) {
				const dateHeader = document.createElement('div')
				dateHeader.className = 'date-header'
				dateHeader.dataset.dateKey = dateKey

				const dateContent = document.createElement('div')
				dateContent.className = 'date-header-content'
				dateContent.textContent = dateText

				dateHeader.appendChild(dateContent)
				return dateHeader
			}

			// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã

			function addDateHeaderToMessage(messageElement, timestamp) {
				const dateKey = new Date(timestamp).toDateString()
				const dateText = formatMessageDate(timestamp)

				if (dateHeaders.has(dateKey)) {
					return
				}

				const dateHeader = createDateHeader(dateText, dateKey)
				dateHeaders.set(dateKey, dateHeader)

				const messagesContainer = document.getElementById('chat-messages')
				messagesContainer.insertBefore(dateHeader, messageElement)
			}

			// –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã

			function updateStickyDateHeaders() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				if (!messagesWrapper) return

				const scrollTop = messagesWrapper.scrollTop
				const dateHeaderElements = Array.from(
					document.querySelectorAll('.date-header')
				)

				let newStickyDate = null
				for (let i = dateHeaderElements.length - 1; i >= 0; i--) {
					const header = dateHeaderElements[i]
					const rect = header.getBoundingClientRect()
					const messagesWrapperRect = messagesWrapper.getBoundingClientRect()
					if (
						rect.top <= messagesWrapperRect.top + 60 &&
						rect.bottom > messagesWrapperRect.top
					) {
						newStickyDate = header
						break
					}
				}
				if (!newStickyDate && dateHeaderElements.length > 0) {
					newStickyDate = dateHeaderElements[0]
				}
				dateHeaderElements.forEach(header => {
					header.classList.remove('sticky')
				})
				if (newStickyDate && newStickyDate !== currentStickyDate) {
					newStickyDate.classList.add('sticky')
					currentStickyDate = newStickyDate
				} else if (!newStickyDate) {
					currentStickyDate = null
				}
			}

			// –°–∏—Å—Ç–µ–º–∞ –¥–∞—Ç

			function initDateHeadersSystem() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				if (!messagesWrapper) return
				messagesWrapper.addEventListener('scroll', updateStickyDateHeaders)
				dateHeadersObserver = new IntersectionObserver(
					entries => {
						entries.forEach(entry => {
							if (entry.isIntersecting) {
								if (entry.target.classList.contains('sticky')) {
									entry.target.classList.remove('sticky')
								}
							}
						})
					},
					{
						root: messagesWrapper,
						threshold: 1.0,
					}
				)
				document.querySelectorAll('.date-header').forEach(header => {
					dateHeadersObserver.observe(header)
				})
			}

			// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é

			function positionPhotoMenu() {
				const rect = photoBtn.getBoundingClientRect()
				photoOptionsMenu.style.left = `${rect.left}px`
				photoOptionsMenu.style.bottom = `${
					window.innerHeight - rect.top + 10
				}px`
			}
			window.addEventListener('resize', positionPhotoMenu)
		</script>
		<div class="modal-overlay hidden" id="delete-message-overlay"></div>
		<div class="delete-message-modal hidden" id="delete-message-modal">
			<button class="modal-close-btn" id="delete-message-close-btn">√ó</button>
			<div class="delete-message-text">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
			<div class="delete-message-buttons">
				<button
					class="delete-message-button delete-for-all"
					id="delete-for-all-btn"
				>
					–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö
				</button>
				<button
					class="delete-message-button delete-for-me"
					id="delete-for-me-btn"
				>
					–¢–æ–ª—å–∫–æ —É –º–µ–Ω—è
				</button>
			</div>
			<button class="delete-message-cancel" id="delete-message-cancel-btn">
				–û—Ç–º–µ–Ω–∞
			</button>
		</div>
	</body>
</html>
