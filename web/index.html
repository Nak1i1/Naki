<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мессенджер</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="top-container">
        <div class="top-row">
            <div class="menu-icon">☰</div>
            <div class="avatar-small" id="top-avatar"></div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="поиск">
                <span class="clear-btn">×</span>
            </div>
        </div>
        
        <div class="user-container" id="user-container"></div>
    </div>
    
    <div class="right-container">
        <div class="default-content" id="default-content">
            <img src="https://cdn-icons-png.flaticon.com/512/5757/5757765.png" alt="Выберите чат" class="default-image">
        </div>
        
        <div class="chat-container hidden" id="chat-container">
            <div class="chat-header">
                <div class="chat-username" id="chat-username"></div>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="no-messages">Нет сообщений</div>
            </div>
            <div class="message-input-container">
                <input type="text" class="message-input" placeholder="Напишите сообщение..." id="message-input">
            </div>
        </div>
    </div>

    <!-- Контекстное меню -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item add-friend hidden" id="context-menu-add">Добавить в друзья</div>
        <div class="context-menu-item remove-friend hidden" id="context-menu-remove">Удалить из друзей</div>
    </div>

    <!-- Модальное окно выхода -->
    <div class="modal-overlay hidden" id="logout-overlay"></div>
    <div class="logout-modal hidden" id="logout-modal">
        <button class="modal-close-btn" id="logout-close-btn">×</button>
        <div class="logout-text">Выйти из аккаунта</div>
        <div class="logout-buttons">
            <button class="logout-button logout-cancel" id="logout-cancel-btn">Отмена</button>
            <button class="logout-button logout-confirm" id="logout-confirm-btn">Выйти</button>
        </div>
    </div>

    <script src="eel.js"></script>
    <script>
        let currentUser = null;
        let contextMenu = null;
        let contextMenuTarget = null;
        let currentChatUserId = null;
        let lastMessageId = null;
        let activeChats = {};

        document.addEventListener('DOMContentLoaded', async function() {
            // Проверяем авторизацию
            const user_id = localStorage.getItem('user_id');
            if (!user_id) {
                window.location.href = 'login.html';
                return;
            }

            // Загружаем данные пользователя
            try {
                currentUser = await eel.get_user_data(user_id)();
                if (!currentUser) {
                    localStorage.removeItem('user_id');
                    window.location.href = 'login.html';
                    return;
                }
            } catch (error) {
                localStorage.removeItem('user_id');
                window.location.href = 'login.html';
                return;
            }

            // Устанавливаем аватар текущего пользователя
            document.getElementById('top-avatar').style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)';

            // Инициализация поиска
            const searchInput = document.querySelector('.search-input');
            const clearBtn = document.querySelector('.clear-btn');
            
            searchInput.addEventListener('input', async function() {
                const searchTerm = this.value.trim();
                if (searchTerm.length > 0) {
                    const users = await eel.search_users(searchTerm, user_id)();
                    displaySearchResults(users);
                } else {
                    loadFriends();
                }
            });

            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.focus();
                loadFriends();
            });

            // Инициализация контекстного меню
            contextMenu = document.getElementById('context-menu');
            document.addEventListener('click', closeContextMenu);
            document.getElementById('context-menu-add').addEventListener('click', handleAddFriend);
            document.getElementById('context-menu-remove').addEventListener('click', handleRemoveFriend);

            // Обработчики для меню выхода
            document.querySelector('.menu-icon').addEventListener('click', function() {
                document.getElementById('logout-overlay').classList.remove('hidden');
                document.getElementById('logout-modal').classList.remove('hidden');
            });

            document.getElementById('logout-close-btn').addEventListener('click', closeLogoutModal);
            document.getElementById('logout-cancel-btn').addEventListener('click', closeLogoutModal);
            document.getElementById('logout-overlay').addEventListener('click', closeLogoutModal);
            document.getElementById('logout-confirm-btn').addEventListener('click', function() {
                localStorage.removeItem('user_id');
                window.location.href = 'login.html';
            });

            // Обработчик нажатия ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (!document.getElementById('logout-modal').classList.contains('hidden')) {
                        closeLogoutModal();
                    } else {
                        closeChat();
                    }
                }
            });

            // Обработчик клика по карточке пользователя
            document.addEventListener('click', function(e) {
                let userBar = e.target.closest('.user-bar');
                if (userBar && !userBar.classList.contains('current-user')) {
                    const userId = userBar.dataset.userId;
                    openChat(userId);
                    
                    document.querySelectorAll('.user-bar').forEach(el => {
                        el.classList.remove('active-chat');
                    });
                    userBar.classList.add('active-chat');
                }
            });
            
            // Обработчик отправки сообщения
            document.getElementById('message-input').addEventListener('keypress', async function(e) {
                if (e.key === 'Enter' && this.value.trim()) {
                    await sendMessage(this.value.trim());
                    this.value = '';
                }
            });

            // Проверка новых сообщений каждые 2 секунды
            setInterval(checkForNewMessages, 2000);

            // Первоначальная загрузка друзей
            await loadFriends();
        });

        function closeLogoutModal() {
            document.getElementById('logout-overlay').classList.add('hidden');
            document.getElementById('logout-modal').classList.add('hidden');
        }

        function closeChat() {
            document.getElementById('default-content').classList.remove('hidden');
            document.getElementById('chat-container').classList.add('hidden');
            document.querySelectorAll('.user-bar').forEach(el => {
                el.classList.remove('active-chat');
            });
            currentChatUserId = null;
            lastMessageId = null;
        }

        async function openChat(userId) {
            if (currentChatUserId === userId) {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return;
            }

            currentChatUserId = userId;
            const user = await eel.get_user_data(userId)();
            
            if (user) {
                document.getElementById('default-content').classList.add('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                document.getElementById('chat-username').textContent = user.nickname;
                
                if (activeChats[userId]) {
                    document.getElementById('chat-messages').innerHTML = activeChats[userId].messages;
                    lastMessageId = activeChats[userId].lastMessageId;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else {
                    await loadChatHistory(userId);
                }
            }
        }

        async function loadChatHistory(userId) {
            try {
                const messages = await eel.get_chat_history(localStorage.getItem('user_id'), userId)();
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = '';

                if (messages && messages.length > 0) {
                    // Сортируем сообщения по времени (старые -> новые)
                    messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    messages.forEach(msg => {
                        const isMyMessage = msg.sender_id === localStorage.getItem('user_id');
                        addMessageToChat(msg, isMyMessage, false);
                    });
                    
                    lastMessageId = messages[messages.length - 1].id;
                    
                    activeChats[userId] = {
                        messages: messagesContainer.innerHTML,
                        lastMessageId: lastMessageId
                    };
                    
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } else {
                    messagesContainer.innerHTML = '<div class="no-messages">Нет сообщений</div>';
                    lastMessageId = null;
                    
                    activeChats[userId] = {
                        messages: messagesContainer.innerHTML,
                        lastMessageId: null
                    };
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        async function sendMessage(text) {
            if (!currentChatUserId || !text) return;
            
            try {
                const result = await eel.send_message(
                    localStorage.getItem('user_id'),
                    currentChatUserId,
                    text
                )();
                
                if (result.success) {
                    const message = {
                        id: result.message_id,
                        sender_id: localStorage.getItem('user_id'),
                        receiver_id: currentChatUserId,
                        text: text,
                        timestamp: result.timestamp,
                        read: false
                    };
                    
                    addMessageToChat(message, true, true);
                    lastMessageId = message.id;
                    
                    if (activeChats[currentChatUserId]) {
                        const messagesContainer = document.getElementById('chat-messages');
                        activeChats[currentChatUserId] = {
                            messages: messagesContainer.innerHTML,
                            lastMessageId: lastMessageId
                        };
                    }
                } else {
                    console.error("Ошибка при отправке:", result.message);
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function addMessageToChat(message, isMyMessage, isNewMessage = true) {
            const messagesContainer = document.getElementById('chat-messages');
            
            if (messagesContainer.querySelector('.no-messages')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isMyMessage ? 'my-message' : 'their-message'}`;
            messageElement.dataset.id = message.id;
            
            const date = new Date(message.timestamp);
            const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = date.toLocaleDateString([], { day: 'numeric', month: 'short' });
            
            messageElement.innerHTML = `
                <div class="message-text">${message.text}</div>
                <div class="message-info">
                    <span>${dateString} ${timeString}</span>
                    ${isMyMessage ? (message.read ? '✓✓' : '✓') : ''}
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function checkForNewMessages() {
            if (!currentChatUserId) return;
            
            try {
                const newMessages = await eel.check_new_messages(
                    localStorage.getItem('user_id'),
                    lastMessageId
                )();
                
                if (newMessages && newMessages.length > 0) {
                    newMessages.forEach(msg => {
                        if (msg.sender_id === currentChatUserId) {
                            addMessageToChat(msg, false, true);
                        }
                    });
                    
                    lastMessageId = newMessages[newMessages.length - 1].id;
                    
                    const messagesContainer = document.getElementById('chat-messages');
                    activeChats[currentChatUserId] = {
                        messages: messagesContainer.innerHTML,
                        lastMessageId: lastMessageId
                    };
                }
            } catch (error) {
                console.error('Error checking new messages:', error);
            }
        }
        
        async function loadFriends() {
            const user_id = localStorage.getItem('user_id');
            try {
                currentUser = await eel.get_user_data(user_id)();
                
                const container = document.getElementById('user-container');
                container.innerHTML = '';
                
                // Добавляем карточку текущего пользователя
                const selfCard = createUserCard({
                    user_id: user_id,
                    nickname: "Вы (" + currentUser.nickname + ")",
                    isCurrentUser: true
                });
                container.appendChild(selfCard);
                
                // Добавляем друзей
                if (currentUser.friends && currentUser.friends.length > 0) {
                    for (const friendId of currentUser.friends) {
                        const friend = await eel.get_user_data(friendId)();
                        if (friend) {
                            const friendCard = createUserCard({
                                user_id: friendId,
                                nickname: friend.nickname,
                                isFriend: true
                            });
                            container.appendChild(friendCard);
                        }
                    }
                } else {
                    const noFriends = document.createElement('div');
                    noFriends.className = 'no-friends';
                    noFriends.textContent = 'У вас пока нет друзей. Найдите их через поиск!';
                    container.appendChild(noFriends);
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        function createUserCard(userData) {
            const card = document.createElement('div');
            card.className = 'user-bar' + (userData.isCurrentUser ? ' current-user' : '');
            card.dataset.userId = userData.user_id;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar-medium';
            avatar.style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)';
            
            const username = document.createElement('div');
            username.className = 'username';
            username.textContent = userData.nickname;
            
            card.appendChild(avatar);
            card.appendChild(username);
            
            if (!userData.isCurrentUser) {
                card.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showContextMenu(e, userData);
                });
            }
            
            return card;
        }

        function showContextMenu(e, userData) {
            closeContextMenu();
            
            contextMenuTarget = userData.user_id;
            
            const addBtn = document.getElementById('context-menu-add');
            const removeBtn = document.getElementById('context-menu-remove');
            
            if (currentUser.friends.includes(userData.user_id)) {
                addBtn.classList.add('hidden');
                removeBtn.classList.remove('hidden');
            } else {
                addBtn.classList.remove('hidden');
                removeBtn.classList.add('hidden');
            }
            
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
        }

        function closeContextMenu() {
            if (contextMenu) {
                contextMenu.style.display = 'none';
            }
            contextMenuTarget = null;
        }

        async function handleAddFriend() {
            if (!contextMenuTarget) return;
            
            const user_id = localStorage.getItem('user_id');
            try {
                const response = await eel.add_friend(user_id, contextMenuTarget)();
                
                if (response.success) {
                    await loadFriends();
                }
                alert(response.message);
            } catch (error) {
                alert('Ошибка при добавлении в друзья');
                console.error('Error adding friend:', error);
            }
            
            closeContextMenu();
        }

        async function handleRemoveFriend() {
            if (!contextMenuTarget) return;
            
            const user_id = localStorage.getItem('user_id');
            try {
                const response = await eel.remove_friend(user_id, contextMenuTarget)();
                
                if (response.success) {
                    await loadFriends();
                    if (currentChatUserId === contextMenuTarget) {
                        closeChat();
                    }
                }
                alert(response.message);
            } catch (error) {
                alert('Ошибка при удалении из друзей');
                console.error('Error removing friend:', error);
            }
            
            closeContextMenu();
        }

        async function displaySearchResults(users) {
            const container = document.getElementById('user-container');
            container.innerHTML = '';
            
            if (users.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.textContent = 'Ничего не найдено';
                container.appendChild(noResults);
                return;
            }
            
            for (const user of users) {
                const isFriend = currentUser.friends.includes(user.user_id);
                const userCard = createUserCard({
                    user_id: user.user_id,
                    nickname: user.nickname,
                    isFriend: isFriend
                });
                container.appendChild(userCard);
            }
        }
    </script>
</body>
</html>