
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мессенджер</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="top-container">
        <div class="top-row">
            <div class="menu-icon">☰</div>
            <div class="avatar-small" id="top-avatar"></div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="поиск">
                <span class="clear-btn">×</span>
            </div>
        </div>
        
        <div class="user-container" id="user-container"></div>
    </div>
    
    <div class="right-container">
        <div class="default-content" id="default-content">
            <img src="https://cdn-icons-png.flaticon.com/512/5757/5757765.png" alt="Выберите чат" class="default-image">
        </div>
        
        <div class="chat-container hidden" id="chat-container">
            <div class="chat-header">
                <div class="chat-username" id="chat-username"></div>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" placeholder="Напишите человеку">
            </div>
        </div>
    </div>

    <!-- Контекстное меню -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item add-friend hidden" id="context-menu-add">Добавить в друзья</div>
        <div class="context-menu-item remove-friend hidden" id="context-menu-remove">Удалить из друзей</div>
    </div>

    <script src="eel.js"></script>
    <script>
        let currentUser = null;
        let contextMenu = null;
        let contextMenuTarget = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Проверяем авторизацию
            const user_id = localStorage.getItem('user_id');
            if (!user_id) {
                window.location.href = 'login.html';
                return;
            }

            // Загружаем данные пользователя
            try {
                currentUser = await eel.get_user_data(user_id)();
                if (!currentUser) {
                    localStorage.removeItem('user_id');
                    window.location.href = 'login.html';
                    return;
                }
            } catch (error) {
                localStorage.removeItem('user_id');
                window.location.href = 'login.html';
                return;
            }

            // Устанавливаем аватар текущего пользователя
            document.getElementById('top-avatar').style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)';

            // Инициализация поиска
            const searchInput = document.querySelector('.search-input');
            const clearBtn = document.querySelector('.clear-btn');
            
            searchInput.addEventListener('input', async function() {
                const searchTerm = this.value.trim();
                if (searchTerm.length > 0) {
                    const users = await eel.search_users(searchTerm, user_id)();
                    displaySearchResults(users);
                } else {
                    loadFriends();
                }
            });

            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.focus();
                loadFriends();
            });

            // Инициализация контекстного меню
            contextMenu = document.getElementById('context-menu');
            document.addEventListener('click', closeContextMenu);
            document.getElementById('context-menu-add').addEventListener('click', handleAddFriend);
            document.getElementById('context-menu-remove').addEventListener('click', handleRemoveFriend);

            // Первоначальная загрузка друзей
            await loadFriends();
        });

        async function loadFriends() {
            const user_id = localStorage.getItem('user_id');
            try {
                currentUser = await eel.get_user_data(user_id)();
                
                const container = document.getElementById('user-container');
                container.innerHTML = '';
                
                // Добавляем карточку текущего пользователя
                const selfCard = createUserCard({
                    user_id: user_id,
                    nickname: "Вы (" + currentUser.nickname + ")",
                    isCurrentUser: true
                });
                container.appendChild(selfCard);
                
                // Добавляем друзей
                if (currentUser.friends && currentUser.friends.length > 0) {
                    for (const friendId of currentUser.friends) {
                        const friend = await eel.get_user_data(friendId)();
                        if (friend) {
                            const friendCard = createUserCard({
                                user_id: friendId,
                                nickname: friend.nickname,
                                isFriend: true
                            });
                            container.appendChild(friendCard);
                        }
                    }
                } else {
                    const noFriends = document.createElement('div');
                    noFriends.className = 'no-friends';
                    noFriends.textContent = 'У вас пока нет друзей. Найдите их через поиск!';
                    container.appendChild(noFriends);
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        function createUserCard(userData) {
            const card = document.createElement('div');
            card.className = 'user-bar';
            card.dataset.userId = userData.user_id;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar-medium';
            avatar.style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)';
            
            const username = document.createElement('div');
            username.className = 'username';
            username.textContent = userData.nickname;
            
            card.appendChild(avatar);
            card.appendChild(username);
            
            if (!userData.isCurrentUser) {
                card.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showContextMenu(e, userData);
                });
            } else {
                card.classList.add('current-user');
            }
            
            return card;
        }

        function showContextMenu(e, userData) {
            closeContextMenu();
            
            contextMenuTarget = userData.user_id;
            
            const addBtn = document.getElementById('context-menu-add');
            const removeBtn = document.getElementById('context-menu-remove');
            
            if (currentUser.friends.includes(userData.user_id)) {
                addBtn.classList.add('hidden');
                removeBtn.classList.remove('hidden');
            } else {
                addBtn.classList.remove('hidden');
                removeBtn.classList.add('hidden');
            }
            
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
        }

        function closeContextMenu() {
            if (contextMenu) {
                contextMenu.style.display = 'none';
            }
            contextMenuTarget = null;
        }

        async function handleAddFriend() {
            if (!contextMenuTarget) return;
            
            const user_id = localStorage.getItem('user_id');
            try {
                const response = await eel.add_friend(user_id, contextMenuTarget)();
                
                if (response.success) {
                    await loadFriends();
                }
                alert(response.message);
            } catch (error) {
                alert('Ошибка при добавлении в друзья');
                console.error('Error adding friend:', error);
            }
            
            closeContextMenu();
        }

        async function handleRemoveFriend() {
            if (!contextMenuTarget) return;
            
            const user_id = localStorage.getItem('user_id');
            try {
                const response = await eel.remove_friend(user_id, contextMenuTarget)();
                
                if (response.success) {
                    await loadFriends();
                }
                alert(response.message);
            } catch (error) {
                alert('Ошибка при удалении из друзей');
                console.error('Error removing friend:', error);
            }
            
            closeContextMenu();
        }

        async function displaySearchResults(users) {
            const container = document.getElementById('user-container');
            container.innerHTML = '';
            
            if (users.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.textContent = 'Ничего не найдено';
                container.appendChild(noResults);
                return;
            }
            
            for (const user of users) {
                const isFriend = currentUser.friends.includes(user.user_id);
                const userCard = createUserCard({
                    user_id: user.user_id,
                    nickname: user.nickname,
                    isFriend: isFriend
                });
                container.appendChild(userCard);
            }
        }
    </script>
</body>
</html>