<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–¥–∏–∞ -->
		<div class="media-send-overlay hidden" id="media-send-overlay"></div>
		<div class="media-send-modal hidden" id="media-send-modal">
			<div class="media-send-title" id="media-send-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–¥–∏–∞</div>

			<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–≤—å—é –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤ -->
			<div class="media-preview-grid" id="media-preview-grid">
				<!-- –ü—Ä–µ–≤—å—é –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
			</div>

			<input
				type="text"
				class="media-caption-input"
				id="media-caption-input"
				placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç"
			/>

			<div class="media-send-buttons">
				<button class="media-send-button add" id="media-add-button">
					–î–æ–±–∞–≤–∏—Ç—å
				</button>
				<button class="media-send-button cancel" id="media-cancel-button">
					–û—Ç–º–µ–Ω–∞
				</button>
				<button class="media-send-button send" id="media-send-button">
					–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ
				</button>
			</div>
		</div>

		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
		<div class="image-modal-overlay hidden" id="image-modal-overlay">
			<div class="image-modal-content">
				<button class="image-modal-close" id="image-modal-close">√ó</button>
				<img
					src=""
					alt="Full screen image"
					class="image-modal-img"
					id="image-modal-img"
				/>
			</div>
		</div>

		<!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ -->
		<input
			type="file"
			id="file-input"
			class="file-input"
			accept="image/*,video/*"
			onchange="handleFileSelect(event)"
		/>

		<div class="top-container">
			<div class="top-row">
				<div class="menu-icon">‚ò∞</div>
				<div class="avatar-small" id="top-avatar"></div>
				<div class="search-container">
					<input type="text" class="search-input" placeholder="–ø–æ–∏—Å–∫" />
					<span class="clear-btn">√ó</span>
				</div>
			</div>

			<div class="user-container" id="user-container"></div>
		</div>

		<div class="right-container">
			<div class="default-content" id="default-content">
				<img
					src="https://cdn-icons-png.flaticon.com/512/5757/5757765.png"
					alt="–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç"
					class="default-image"
				/>
			</div>

			<div class="chat-container hidden" id="chat-container">
				<div class="chat-header">
					<div class="chat-username" id="chat-username"></div>
					<div class="chat-header-info">
						<div class="chat-status" id="chat-status"></div>
					</div>
				</div>
				<div class="chat-scroll-container">
					<div class="chat-messages-wrapper" id="chat-messages-wrapper">
						<div class="chat-messages" id="chat-messages">
							<!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–∞—Ç –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
						</div>
					</div>
					<div class="custom-scrollbar" id="custom-scrollbar">
						<div
							class="custom-scrollbar-thumb"
							id="custom-scrollbar-thumb"
						></div>
					</div>
				</div>
				<div class="message-input-container">
					<div class="reply-container hidden" id="reply-container"></div>
					<div class="input-row">
						<button class="photo-message-btn" id="photo-message-btn">
							<img
								src="https://cdn-icons-png.flaticon.com/512/266/266074.png"
								alt="–§–æ—Ç–æ"
							/>
						</button>
						<div class="message-input-wrapper">
							<input
								type="text"
								class="message-input"
								placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
								id="message-input"
							/>
							<div class="recording-container hidden" id="recording-container">
								–ó–∞–ø–∏—Å—å: <span id="recording-time">0</span> —Å–µ–∫.
							</div>
						</div>
						<button class="voice-message-btn" id="voice-message-btn">
							<img
								src="https://images.icon-icons.com/2066/PNG/512/mic_icon_125214.png"
								alt="–ó–∞–ø–∏—Å—å"
							/>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –º–µ–Ω—é –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–æ—Ç–æ -->
		<div class="photo-options-menu hidden" id="photo-options-menu">
			<button class="photo-option" data-type="photo-video">
				<img
					src="https://cdn-icons-png.flaticon.com/512/266/266074.png"
					alt="–§–æ—Ç–æ/–í–∏–¥–µ–æ"
				/>
				<span>–§–æ—Ç–æ –∏ –≤–∏–¥–µ–æ</span>
			</button>
			<button class="photo-option" data-type="documents">
				<img
					src="https://cdn-icons-png.flaticon.com/512/2991/2991112.png"
					alt="–î–æ–∫—É–º–µ–Ω—Ç—ã"
				/>
				<span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
			</button>
			<button class="photo-option" data-type="poll">
				<img
					src="https://cdn-icons-png.flaticon.com/512/3034/3034626.png"
					alt="–û–ø—Ä–æ—Å"
				/>
				<span>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</span>
			</button>
			<button class="photo-option" data-type="location">
				<img
					src="https://cdn-icons-png.flaticon.com/512/535/535137.png"
					alt="–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è"
				/>
				<span>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</span>
			</button>
		</div>

		<!-- Add this to your HTML -->
		<div class="video-message-container hidden" id="video-loading-overlay">
			<div class="video-loading-content">
				<div class="video-loading-spinner"></div>
				<div class="video-loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>
				<div class="video-loading-progress">0 MB / 0 MB</div>
				<button class="video-loading-cancel">–û—Ç–º–µ–Ω–∞</button>
			</div>
		</div>

		<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
		<div class="context-menu" id="context-menu">
			<div class="context-menu-item add-friend hidden" id="context-menu-add">
				–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
			</div>
			<div
				class="context-menu-item remove-friend hidden"
				id="context-menu-remove"
			>
				–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π
			</div>
		</div>

		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã—Ö–æ–¥–∞ -->
		<div class="modal-overlay hidden" id="logout-overlay"></div>
		<div class="logout-modal hidden" id="logout-modal">
			<button class="modal-close-btn" id="logout-close-btn">√ó</button>
			<div class="logout-text">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
			<div class="logout-buttons">
				<button class="logout-button logout-cancel" id="logout-cancel-btn">
					–û—Ç–º–µ–Ω–∞
				</button>
				<button class="logout-button logout-confirm" id="logout-confirm-btn">
					–í—ã–π—Ç–∏
				</button>
			</div>
		</div>

		<div class="message-context-menu hidden" id="message-context-menu">
			<div class="message-context-item" id="message-reply">–û—Ç–≤–µ—Ç–∏—Ç—å</div>
			<div class="message-context-item" id="message-edit">–ò–∑–º–µ–Ω–∏—Ç—å</div>
			<div class="message-context-item" id="message-pin">–ó–∞–∫—Ä–µ–ø–∏—Ç—å</div>
			<div class="message-context-item" id="message-delete">–£–¥–∞–ª–∏—Ç—å</div>
			<div
				class="message-context-item"
				id="message-delete-for-me"
				style="display: none"
			>
				–£–¥–∞–ª–∏—Ç—å —É –º–µ–Ω—è
			</div>
			<div class="message-context-item" id="message-forward">–ü–µ—Ä–µ—Å–ª–∞—Ç—å</div>
			<div class="message-context-item" id="message-copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
		</div>

		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
		<div class="modal-overlay hidden" id="delete-message-overlay"></div>
		<div class="delete-message-modal hidden" id="delete-message-modal">
			<button class="modal-close-btn" id="delete-message-close-btn">√ó</button>
			<div class="delete-message-text">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
			<div class="delete-message-buttons">
				<button
					class="delete-message-button delete-for-all"
					id="delete-for-all-btn"
				>
					–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö
				</button>
				<button
					class="delete-message-button delete-for-me"
					id="delete-for-me-btn"
				>
					–¢–æ–ª—å–∫–æ —É –º–µ–Ω—è
				</button>
			</div>
			<button class="delete-message-cancel" id="delete-message-cancel-btn">
				–û—Ç–º–µ–Ω–∞
			</button>
		</div>

		<script src="eel.js"></script>
		<script>
			let currentUser = null
			let contextMenu = null
			let contextMenuTarget = null
			let currentChatUserId = null
			let lastMessageId = null
			let activeChats = {}
			let readStatusInterval = null
			let statusUpdateInterval = null
			let onlineStatusInterval = null
			let currentPlayingAudio = null
			let voiceMessagePlaying = false
			let currentPlayingVoiceElement = null
			let ecdhInitialized = false
			let currentContextMessage = null
			let chatInputs = {}
			let scrollPositions = {}
			let isDraggingScroll = false
			let scrollDragStartY = 0
			let scrollThumbStartY = 0

			let dateHeaders = new Map()
			let currentStickyDate = null
			let dateHeadersObserver = null
let encryptionEnabled = false;
let currentPeerKey = null;
			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è ESC
			document.addEventListener('keydown', function (e) {
				if (e.key === 'Escape') {
					// –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ
					if (
						!document
							.getElementById('image-modal-overlay')
							.classList.contains('hidden')
					) {
						closeImageModal()
						return
					}

					// –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è - –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
					if (
						!document
							.getElementById('delete-message-modal')
							.classList.contains('hidden')
					) {
						document
							.getElementById('delete-message-overlay')
							.classList.add('hidden')
						document
							.getElementById('delete-message-modal')
							.classList.add('hidden')
						return
					}

					// –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã—Ö–æ–¥–∞ - –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
					if (
						!document
							.getElementById('logout-modal')
							.classList.contains('hidden')
					) {
						closeLogoutModal()
						return
					}

					// –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
					if (
						!document
							.getElementById('chat-container')
							.classList.contains('hidden')
					) {
						closeChatAndReset()
					}
				}
			})

			// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ –∏ —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
			function closeChatAndReset() {
				// –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —ç–∫—Ä–∞–Ω
				document.getElementById('default-content').classList.remove('hidden')
				document.getElementById('chat-container').classList.add('hidden')

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º currentChatUserId
				currentChatUserId = null

				// –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ —É –í–°–ï–• –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
				document.querySelectorAll('.user-bar').forEach(el => {
					el.classList.remove('active-chat')
				})

				// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
				stopVoiceMessage()
				currentPlayingAudio = null
				voiceMessagePlaying = false
				currentPlayingVoiceElement = null

				// –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
				const messageInput = document.getElementById('message-input')
				if (messageInput) {
					messageInput.value = ''
				}

				// –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Ç–≤–µ—Ç–∞
				const replyContainer = document.getElementById('reply-container')
				if (replyContainer) {
					replyContainer.classList.add('hidden')
					document
						.querySelector('.message-input-container')
						.classList.remove('expanded')
				}

				// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
				if (readStatusInterval) {
					clearInterval(readStatusInterval)
					readStatusInterval = null
				}
				if (statusUpdateInterval) {
					clearInterval(statusUpdateInterval)
					statusUpdateInterval = null
				}

				console.log('–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç –ø–æ ESC, –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω')
			}

			function initImageModal() {
				const imageModalOverlay = document.getElementById('image-modal-overlay')
				const imageModalImg = document.getElementById('image-modal-img')
				const imageModalClose = document.getElementById('image-modal-close')

				if (!imageModalOverlay || !imageModalImg || !imageModalClose) {
					console.error('Image modal elements not found')
					return
				}

				// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
				window.openImageModal = function (imageSrc) {
					imageModalImg.src = imageSrc
					imageModalOverlay.classList.remove('hidden')
					document.body.style.overflow = 'hidden' // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
				}

				// –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
				window.closeImageModal = function () {
					imageModalOverlay.classList.add('hidden')
					imageModalImg.src = ''
					document.body.style.overflow = '' // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
				imageModalClose.addEventListener('click', closeImageModal)
				imageModalOverlay.addEventListener('click', function (e) {
					if (e.target === imageModalOverlay) {
						closeImageModal()
					}
				})

				// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
				document.addEventListener('keydown', function (e) {
					if (
						e.key === 'Escape' &&
						!imageModalOverlay.classList.contains('hidden')
					) {
						closeImageModal()
					}
				})

				console.log('Image modal initialized')
			}

			function stopVoiceMessage() {
				if (currentPlayingAudio) {
					currentPlayingAudio.pause()
					currentPlayingAudio = null
				}
				voiceMessagePlaying = false

				if (currentPlayingVoiceElement) {
					currentPlayingVoiceElement.classList.remove('playing')
					const playIcon =
						currentPlayingVoiceElement.querySelector('.voice-play-icon')
					if (playIcon) {
						playIcon.textContent = '‚ñ∂'
					}
					currentPlayingVoiceElement = null
				}
			}

			function setupVoiceMessageHandlers() {
				// –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
				// –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ–π, —Ç–∞–∫ –∫–∞–∫ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
			}

			function updateListenIndicators() {
				// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
				// –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ–π
				return Promise.resolve()
			}



class MessageEncryption {
    static async deriveKey(password, salt) {
        const encoder = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
            'raw',
            encoder.encode(password),
            'PBKDF2',
            false,
            ['deriveKey']
        );
        
        return await crypto.subtle.deriveKey(
            {
                name: 'PBKDF2',
                salt: salt,
                iterations: 100000,
                hash: 'SHA-256'
            },
            keyMaterial,
            {
                name: 'AES-GCM',
                length: 256
            },
            false,
            ['encrypt', 'decrypt']
        );
    }

    static async encryptMessage(text, password) {
        try {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–ª—å –∏ IV
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            
            // –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º –∫–ª—é—á –∏–∑ –ø–∞—Ä–æ–ª—è
            const key = await this.deriveKey(password, salt);
            
            // –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const encoder = new TextEncoder();
            const encodedText = encoder.encode(text);
            
            const encryptedContent = await crypto.subtle.encrypt(
                {
                    name: 'AES-GCM',
                    iv: iv
                },
                key,
                encodedText
            );
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–æ–ª—å, IV –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const result = new Uint8Array(salt.length + iv.length + encryptedContent.byteLength);
            result.set(salt, 0);
            result.set(iv, salt.length);
            result.set(new Uint8Array(encryptedContent), salt.length + iv.length);
            
            return btoa(String.fromCharCode(...result));
            
        } catch (error) {
            console.error('Encryption error:', error);
            throw error;
        }
    }

    static async decryptMessage(encryptedData, password) {
        try {
            // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏–∑ base64
            const encryptedArray = new Uint8Array(atob(encryptedData).split('').map(char => char.charCodeAt(0)));
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–ª—å, IV –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const salt = encryptedArray.slice(0, 16);
            const iv = encryptedArray.slice(16, 28);
            const encryptedContent = encryptedArray.slice(28);
            
            // –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º –∫–ª—é—á –∏–∑ –ø–∞—Ä–æ–ª—è
            const key = await this.deriveKey(password, salt);
            
            // –î–µ—à–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            const decryptedContent = await crypto.subtle.decrypt(
                {
                    name: 'AES-GCM',
                    iv: iv
                },
                key,
                encryptedContent
            );
            
            const decoder = new TextDecoder();
            return decoder.decode(decryptedContent);
            
        } catch (error) {
            console.error('Decryption error:', error);
            throw error;
        }
    }
}


async function sendSecureMessage(text) {
    if (!currentChatUserId || !text.trim()) {
        return false;
    }

    try {
        const user_id = localStorage.getItem('user_id');
        const userPassword = sessionStorage.getItem('user_password');
        
        if (!userPassword) {
            throw new Error('–ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è');
        }

        // –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        const encryptedText = await MessageEncryption.encryptMessage(text, userPassword);
        
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const result = await eel.send_encrypted_message(user_id, currentChatUserId, encryptedText)();

        if (result.success) {
            // –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –∑–¥–µ—Å—å - –æ–Ω–æ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏
            // –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            updateLastMessageOnUserCard(currentChatUserId, text, true);
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('message-input').value = '';
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            await loadSecureChatHistory(currentChatUserId);
            
            console.log('–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            return true;
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + result.message);
            return false;
        }
    } catch (error) {
        console.error('Error sending secure message:', error);
        alert('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
        return false;
    }
}




function formatMessageTime(timestamp) {
    try {
        // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –∏–∑ timestamp
        const date = new Date(timestamp);
        
        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
        
        return userTime.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', error);
        return '--:--';
    }
}

			async function updateLastMessageAfterDelete(chatUserId) {
				try {
					const lastMessage = await eel.get_last_message(
						localStorage.getItem('user_id'),
						chatUserId
					)()
					const userCard = document.querySelector(
						`.user-bar[data-user-id="${chatUserId}"]`
					)

					if (!userCard) return

					const lastMsgDiv = userCard.querySelector('.last-message')
					const contentWrapper = userCard.querySelector('.user-content-wrapper')

					if (lastMessage) {
						let displayText = lastMessage.text
						if (displayText.length > 25) {
							displayText = displayText.substring(0, 22) + '...'
						}

						if (lastMessage.sender_id === localStorage.getItem('user_id')) {
							if (lastMsgDiv) {
								lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
							} else if (contentWrapper) {
								const newLastMsgDiv = document.createElement('div')
								newLastMsgDiv.className = 'last-message'
								newLastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`
								contentWrapper.appendChild(newLastMsgDiv)
							}
						} else {
							if (lastMsgDiv) {
								lastMsgDiv.textContent = displayText
							} else if (contentWrapper) {
								const newLastMsgDiv = document.createElement('div')
								newLastMsgDiv.className = 'last-message'
								newLastMsgDiv.textContent = displayText
								contentWrapper.appendChild(newLastMsgDiv)
							}
						}
					} else {
						// –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç, —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ last-message
						if (lastMsgDiv) {
							lastMsgDiv.remove()
						}
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error)
				}
			}


			async function checkEncryptionKeys() {
				try {
					const user_id = localStorage.getItem('user_id')
					if (!user_id) {
						console.error('No user ID found')
						return false
					}

					// –ü–æ–ª—É—á–∞–µ–º —Å–æ–ª—å —Å —Å–µ—Ä–≤–µ—Ä–∞
					const saltResponse = await eel.get_user_salt(user_id)()
					if (!saltResponse.success) {
						console.error('Failed to get salt from server')
						return false
					}

					// –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ sessionStorage
					const userPassword = sessionStorage.getItem('user_password')
					if (!userPassword) {
						console.error('No password in sessionStorage')
						return false
					}

					// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–ª—å
					const saltBytes = Uint8Array.from(atob(saltResponse.salt), c =>
						c.charCodeAt(0)
					)

					// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
					const newKey = await zkCrypto.deriveKey(userPassword, saltBytes)

					// –í–º–µ—Å—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–ª—é—á–µ–π, —Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏—Ö —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

					console.log('Keys check result:', testResult)

					if (testResult) {
						// –ï—Å–ª–∏ –Ω–æ–≤—ã–π –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á
						userEncryptionKey = newKey
						return true
					}

					return false
				} catch (error) {
					console.error('Error checking encryption keys:', error)
					return false
				}
			}
			function sendAllMedia() {
				alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
				closeMediaModal()
			}

			function openFileSelector() {
				alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
			}

			function closeMediaModal() {
				// –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
			}

			function handleFileSelect(event) {
				alert('–û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏')
				event.target.value = ''
			}

			function showMediaUploadProgress() {}
			function hideMediaUploadProgress() {}
			function updateMediaUploadProgress() {}

			document.addEventListener('click', function (e) {
				let userBar = e.target.closest('.user-bar')
				if (userBar) {
					const userId = userBar.dataset.userId

					// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ—Ç —á–∞—Ç
					if (
						currentChatUserId === userId &&
						!document
							.getElementById('chat-container')
							.classList.contains('hidden')
					) {
						return // –ß–∞—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
					}

					openChat(userId)

					document.querySelectorAll('.user-bar').forEach(el => {
						el.classList.remove('active-chat')
					})
					userBar.classList.add('active-chat')
				}
			})

			async function initializeZKChat(
				userId,
				peerUserId,
				myPassword,
				peerPassword
			) {
				try {
					// –ü–æ–ª—É—á–∞–µ–º —Å–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
					const myUserData = await eel.get_user_data(userId)()
					const peerUserData = await eel.get_user_data(peerUserId)()

					if (!myUserData || !peerUserData) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π')
					}

					const mySalt = Uint8Array.from(atob(myUserData.salt), c =>
						c.charCodeAt(0)
					)
					const peerSalt = Uint8Array.from(atob(peerUserData.salt), c =>
						c.charCodeAt(0)
					)

					// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º —Å–æ–ª–∏
					const combinedSalt = new Uint8Array([...mySalt, ...peerSalt])

					// –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á
					const masterKey = await ZKEncryptionSystem.deriveMasterKey(
						myPassword,
						peerPassword,
						combinedSalt
					)

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á –≤ –ø–∞–º—è—Ç–∏
					const chatKey = `${userId}-${peerUserId}`
					zkMasterKeys.set(chatKey, masterKey)

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è persistence
					await eel.compute_shared_master_key(
						userId,
						peerUserId,
						myPassword,
						peerPassword
					)()

					return masterKey
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ZK —á–∞—Ç–∞:', error)
					throw error
				}
			}

document.addEventListener('DOMContentLoaded', async function() {
    console.log('=== DOMContentLoaded –Ω–∞—á–∞—Ç ===');
    const user_id = localStorage.getItem('user_id');
    console.log('User ID –∏–∑ localStorage:', user_id);

    if (!user_id) {
        console.log('User ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ login');
        window.location.href = 'login.html';
        return;
    }

    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        currentUser = await eel.get_user_data(user_id)();
        console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', currentUser);

        if (!currentUser) {
            console.error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
            localStorage.removeItem('user_id');
            window.location.href = 'login.html';
            return;
        }

        // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú –°–ò–°–¢–ï–ú–£ –®–ò–§–†–û–í–ê–ù–ò–Ø –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...');
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ sessionStorage
        const userPassword = sessionStorage.getItem('user_password');
        if (!userPassword) {
            console.error('–ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ sessionStorage. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≤—Ö–æ–¥.');
            localStorage.removeItem('user_id');
            window.location.href = 'login.html';
            return;
        }
        
        const encryptionInit = await eel.initialize_user_encryption(user_id, userPassword)();
        if (encryptionInit.success) {
            console.log('–°–∏—Å—Ç–µ–º–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        } else {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:', encryptionInit.message);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –µ—Å–ª–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
        }

        // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...');
        initCustomScroll();
        initImageModal();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('top-avatar').style.backgroundImage = 
            'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
        const searchInput = document.querySelector('.search-input');
        const clearBtn = document.querySelector('.clear-btn');

        if (searchInput && clearBtn) {
            searchInput.addEventListener('input', async function() {
                const searchTerm = this.value.trim();
                if (searchTerm.length > 0) {
                    const users = await eel.search_users(searchTerm, user_id)();
                    displaySearchResults(users);
                } else {
                    loadFriends();
                }
            });

            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                searchInput.focus();
                loadFriends();
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        contextMenu = document.getElementById('context-menu');
        if (contextMenu) {
            document.addEventListener('click', closeContextMenu);
            document.getElementById('context-menu-add').addEventListener('click', handleAddFriend);
            document.getElementById('context-menu-remove').addEventListener('click', handleRemoveFriend);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω—é –≤—ã—Ö–æ–¥–∞
        const menuIcon = document.querySelector('.menu-icon');
        if (menuIcon) {
            menuIcon.addEventListener('click', function() {
                document.getElementById('logout-overlay').classList.remove('hidden');
                document.getElementById('logout-modal').classList.remove('hidden');
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–µ–Ω—é –≤—ã—Ö–æ–¥–∞
        document.getElementById('logout-close-btn')?.addEventListener('click', closeLogoutModal);
        document.getElementById('logout-cancel-btn')?.addEventListener('click', closeLogoutModal);
        document.getElementById('logout-overlay')?.addEventListener('click', closeLogoutModal);
        document.getElementById('logout-confirm-btn')?.addEventListener('click', function() {
            localStorage.removeItem('user_id');
            sessionStorage.removeItem('user_password'); // –û—á–∏—â–∞–µ–º –ø–∞—Ä–æ–ª—å
            window.location.href = 'login.html';
        });

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω
        startOnlineStatusUpdates();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥—Ä—É–∑–µ–π
        console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π...');
        await loadFriends();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏–π
        initMessageContextMenu();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
        setTimeout(initButtonHandlers, 1000);



        console.log('=== –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ ===');
        console.log('–°–∏—Å—Ç–µ–º–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', error);
        localStorage.removeItem('user_id');
        sessionStorage.removeItem('user_password');
        window.location.href = 'login.html';
    }
});
			document
				.getElementById('message-input')
				.addEventListener('keypress', async function (e) {
					if (e.key === 'Enter' && this.value.trim()) {
						const text = this.value.trim()
						if (!text) return

						// –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
						if (this.disabled) return
						this.disabled = true

						try {
							await sendSecureMessage(text)
						} catch (error) {
							console.error('Error sending message:', error)
							alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message)
						} finally {
							// –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
							this.disabled = false
						}
					}
				})

			// –í—ã–∑–æ–≤ –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ

			function initCustomScroll() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				const scrollbar = document.getElementById('custom-scrollbar')
				const scrollThumb = document.getElementById('custom-scrollbar-thumb')
				const rightContainer = document.querySelector('.right-container')

				let isDraggingScroll = false
				let scrollDragStartY = 0
				let scrollThumbStartY = 0

				// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–ª–∑—É–Ω–∫–∞
				function updateScrollThumb() {
					if (!messagesWrapper) return

					const { scrollHeight, clientHeight, scrollTop } = messagesWrapper

					// –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–º–µ—â–∞–µ—Ç—Å—è
					if (scrollHeight <= clientHeight) {
						scrollbar.style.display = 'none'
						return
					}

					scrollbar.style.display = 'block'
					const thumbHeight = Math.max(
						20,
						(clientHeight / scrollHeight) * clientHeight
					)
					const thumbPosition =
						(scrollTop / (scrollHeight - clientHeight)) *
						(clientHeight - thumbHeight)

					scrollThumb.style.height = `${thumbHeight}px`
					scrollThumb.style.top = `${thumbPosition}px`
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –ø–æ–ª–∑—É–Ω–∫–∞
				scrollThumb.addEventListener('mousedown', e => {
					isDraggingScroll = true
					scrollThumb.classList.add('dragging') // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
					scrollDragStartY = e.clientY
					scrollThumbStartY = parseInt(scrollThumb.style.top || '0')
					e.preventDefault()

					document.addEventListener('mousemove', handleScrollMove)
					document.addEventListener('mouseup', handleScrollEnd)
				})

				const handleScrollMove = e => {
					if (!isDraggingScroll) return

					const deltaY = e.clientY - scrollDragStartY
					let newThumbPosition = scrollThumbStartY + deltaY

					// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª–∑—É–Ω–∫–∞
					const maxPosition =
						messagesWrapper.clientHeight - scrollThumb.offsetHeight
					newThumbPosition = Math.max(
						0,
						Math.min(maxPosition, newThumbPosition)
					)

					// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª–∑—É–Ω–∫–∞
					scrollThumb.style.top = `${newThumbPosition}px`

					// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
					const scrollRatio = newThumbPosition / maxPosition
					messagesWrapper.scrollTop =
						scrollRatio *
						(messagesWrapper.scrollHeight - messagesWrapper.clientHeight)
				}

				const handleScrollEnd = () => {
					isDraggingScroll = false
					scrollThumb.classList.remove('dragging') // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
					document.removeEventListener('mousemove', handleScrollMove)
					document.removeEventListener('mouseup', handleScrollEnd)
				}

				// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –æ–±–ª–∞—Å—Ç—å —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞
				scrollbar.addEventListener('click', e => {
					if (e.target === scrollbar) {
						const rect = scrollbar.getBoundingClientRect()
						const clickPosition = e.clientY - rect.top
						const thumbHeight = scrollThumb.offsetHeight

						// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É –∫–ª–∏–∫–∞
						let newThumbPosition = clickPosition - thumbHeight / 2
						newThumbPosition = Math.max(
							0,
							Math.min(rect.height - thumbHeight, newThumbPosition)
						)
						scrollThumb.style.top = `${newThumbPosition}px`

						// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
						const scrollRatio = newThumbPosition / (rect.height - thumbHeight)
						messagesWrapper.scrollTop =
							scrollRatio *
							(messagesWrapper.scrollHeight - messagesWrapper.clientHeight)
					}
				})

				// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –∫–æ–ª–µ—Å–æ–º
				messagesWrapper.addEventListener('scroll', updateScrollThumb)

				// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª–∑—É–Ω–æ–∫
				updateScrollThumb()

				// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
				window.addEventListener('resize', updateScrollThumb)

				// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
				const observer = new MutationObserver(updateScrollThumb)
				observer.observe(messagesWrapper, { childList: true, subtree: true })
			}
			function startOnlineStatusUpdates() {
				updateOnlineStatus()
				onlineStatusInterval = setInterval(updateOnlineStatus, 30000)
				window.addEventListener('beforeunload', updateOnlineStatus)
			}

			async function updateOnlineStatus() {
				try {
					await eel.update_last_online(localStorage.getItem('user_id'))()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω:', error)
				}
			}

			function closeLogoutModal() {
				document.getElementById('logout-overlay').classList.add('hidden')
				document.getElementById('logout-modal').classList.add('hidden')
			}
			function closeChat(softClose = false) {
				document.getElementById('default-content').classList.remove('hidden')
				document.getElementById('chat-container').classList.add('hidden')

				// –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ —É –í–°–ï–• –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
				document.querySelectorAll('.user-bar').forEach(el => {
					el.classList.remove('active-chat')
				})

				stopVoiceMessage()
				currentPlayingAudio = null
				voiceMessagePlaying = false
				currentPlayingVoiceElement = null

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º currentChatUserId —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ softClose
				if (!softClose) {
					currentChatUserId = null
				}

				lastMessageId = null

				if (readStatusInterval) {
					clearInterval(readStatusInterval)
					readStatusInterval = null
				}
				if (statusUpdateInterval) {
					clearInterval(statusUpdateInterval)
					statusUpdateInterval = null
				}
			}

			async function checkAndRestoreReplyState() {
				if (!currentChatUserId) return

				try {
					const replyState = await eel.get_reply_state(
						localStorage.getItem('user_id'),
						currentChatUserId
					)()
					if (replyState.success) {
						const message = await eel.get_message_data(replyState.message_id)()
						if (message) {
							const replyContainer = document.getElementById('reply-container')
							const isMyMessage =
								message.sender_id === localStorage.getItem('user_id')

							replyContainer.dataset.messageId = message.id
							replyContainer.innerHTML = `
                    <div class="reply-header">
                        <div class="reply-author">${
													isMyMessage
														? '–í—ã'
														: document.getElementById('chat-username')
																.textContent
												}</div>
                        <div class="reply-close">√ó</div>
                    </div>
                    <div class="reply-text">${
											message.text.length > 50
												? message.text.substring(0, 47) + '...'
												: message.text
										}</div>
                `

							replyContainer.classList.remove('hidden')
							document
								.querySelector('.message-input-container')
								.classList.add('expanded')

							// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Ç–≤–µ—Ç–∞
							replyContainer
								.querySelector('.reply-close')
								.addEventListener('click', async () => {
									replyContainer.classList.add('hidden')
									document
										.querySelector('.message-input-container')
										.classList.remove('expanded')
									await eel.clear_reply_state(
										localStorage.getItem('user_id'),
										currentChatUserId
									)()
								})
						}
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:', error)
				}
			}
function showEncryptionIndicator() {
    const chatHeader = document.querySelector('.chat-header');
    if (chatHeader && !chatHeader.querySelector('.encryption-indicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'encryption-indicator';
        indicator.innerHTML = 'üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ';
        indicator.style.color = '#4CAF50';
        indicator.style.fontSize = '12px';
        indicator.style.marginLeft = '10px';
        chatHeader.appendChild(indicator);
    }
}

function hideEncryptionIndicator() {
    const indicator = document.querySelector('.encryption-indicator');
    if (indicator) {
        indicator.remove();
    }
}

async function setupChatEncryption(userId, password) {
    try {
        const user_id = localStorage.getItem('user_id');
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
        const currentStatus = await checkEncryptionStatus(userId);
        if (currentStatus) {
            console.log('–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –¥–ª—è —á–∞—Ç–∞');
            showEncryptionIndicator();
            return true;
        }
        
        // –ï—Å–ª–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –µ–≥–æ —Å –ø–∞—Ä–æ–ª–µ–º
        const result = await eel.setup_chat_encryption(user_id, userId, password)();
        
        if (result.success) {
            console.log('–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –¥–ª—è —á–∞—Ç–∞');
            showEncryptionIndicator();
            return true;
        } else {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:', result.message);
            hideEncryptionIndicator();
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error);
        hideEncryptionIndicator();
        return false;
    }
}

async function openChat(userId) {
    console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:', userId);

    // –ï—Å–ª–∏ —á–∞—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    if (currentChatUserId === userId && 
        !document.getElementById('chat-container').classList.contains('hidden')) {
        const messagesWrapper = document.getElementById('chat-messages-wrapper');
        if (messagesWrapper) {
            messagesWrapper.scrollTop = scrollPositions[userId] || messagesWrapper.scrollHeight;
        }
        return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —á–∞—Ç–∞
    if (currentChatUserId) {
        const messagesWrapper = document.getElementById('chat-messages-wrapper');
        if (messagesWrapper) {
            scrollPositions[currentChatUserId] = messagesWrapper.scrollTop;
        }

        const currentText = document.getElementById('message-input').value;
        if (currentText.trim()) {
            await eel.save_draft_message(localStorage.getItem('user_id'), currentChatUserId, currentText)();
        }
        chatInputs[currentChatUserId] = currentText;
    }

    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    stopVoiceMessage();
    currentPlayingAudio = null;
    voiceMessagePlaying = false;
    currentPlayingVoiceElement = null;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –¥—Ä—É–≥–æ–π —á–∞—Ç
    const replyContainer = document.getElementById('reply-container');
    if (replyContainer && !replyContainer.classList.contains('hidden')) {
        replyContainer.classList.add('hidden');
        document.querySelector('.message-input-container').classList.remove('expanded');
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É –¥–∞—Ç
    dateHeaders.clear();
    currentStickyDate = null;
    if (dateHeadersObserver) {
        dateHeadersObserver.disconnect();
        dateHeadersObserver = null;
    }

    if (readStatusInterval) clearInterval(readStatusInterval);
    if (statusUpdateInterval) clearInterval(statusUpdateInterval);

    currentChatUserId = userId;
    const user = await eel.get_user_data(userId)();

    if (user) {
        document.getElementById('default-content').classList.add('hidden');
        document.getElementById('chat-container').classList.remove('hidden');
        document.getElementById('chat-username').textContent = 
            userId === localStorage.getItem('user_id') ? '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ' : user.nickname;
        
        await updateUserStatus();

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Ç–∞ (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —á–∞—Ç —Å —Å–∞–º–∏–º —Å–æ–±–æ–π)
        if (userId !== localStorage.getItem('user_id')) {
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å –∏–∑ sessionStorage
            const userPassword = sessionStorage.getItem('user_password');
            if (userPassword) {
                await setupChatEncryption(userId, userPassword);
            } else {
                console.warn('–ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ sessionStorage, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ');
                hideEncryptionIndicator();
            }
            
            // –ü–û–ú–ï–ß–ê–ï–ú –°–û–û–ë–©–ï–ù–ò–Ø –ö–ê–ö –ü–†–û–ß–ò–¢–ê–ù–ù–´–ï –ü–†–ò –û–¢–ö–†–´–¢–ò–ò –ß–ê–¢–ê
            try {
                await eel.mark_chat_messages_as_read(localStorage.getItem('user_id'), userId)();
                console.log('–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:', error);
            }
        } else {
            hideEncryptionIndicator();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä
        initCustomScroll();

        // –ó–ê–ì–†–£–ñ–ê–ï–ú –ë–ï–ó–û–ü–ê–°–ù–£–Æ –ò–°–¢–û–†–ò–Æ –ß–ê–¢–ê –° –®–ò–§–†–û–í–ê–ù–ò–ï–ú
        await loadSecureChatHistory(userId);

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
        const draftText = await eel.get_draft_message(localStorage.getItem('user_id'), userId)();
        document.getElementById('message-input').value = draftText || chatInputs[userId] || '';

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        await checkAndRestoreReplyState();

        readStatusInterval = setInterval(updateReadStatus, 2000);
        updateReadStatus();

        statusUpdateInterval = setInterval(updateUserStatus, 5000);

        // –ü–æ–º–µ—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
        document.querySelectorAll('.user-bar').forEach(el => {
            el.classList.remove('active-chat');
        });
        const userCard = document.querySelector(`.user-bar[data-user-id="${userId}"]`);
        if (userCard) {
            userCard.classList.add('active-chat');
        }

        console.log('–ß–∞—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º');
    } else {
        console.error('User data not found for ID:', userId);
        document.getElementById('chat-messages').innerHTML = 
            '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
    }
}
async function loadSecureChatHistory(userId) {
    try {
        const user_id = localStorage.getItem('user_id');
        const messages = await eel.get_encrypted_chat_history(user_id, userId)();
        
        console.log('–ü–æ–ª—É—á–µ–Ω–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', messages.success ? messages.messages.length : 0);

        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = ''; // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

        dateHeaders.clear();
        currentStickyDate = null;

        if (messages.success && messages.messages.length > 0) {
            const userPassword = sessionStorage.getItem('user_password');
            if (!userPassword) {
                throw new Error('–ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è');
            }

            let currentDateKey = null;

            for (const msg of messages.messages) {
                const isMyMessage = msg.sender_id === user_id;
                let displayText = msg.text;

                // –î–µ—à–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ
                if (msg.is_encrypted && msg.text) {
                    try {
                        displayText = await MessageEncryption.decryptMessage(msg.text, userPassword);
                        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ');
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                        displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ]';
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã
                const messageDate = new Date(msg.timestamp);
                const messageDateKey = messageDate.toDateString();

                if (messageDateKey !== currentDateKey) {
                    const dateText = formatMessageDate(msg.timestamp);
                    const dateHeader = createDateHeader(dateText, messageDateKey);
                    messagesContainer.appendChild(dateHeader);
                    dateHeaders.set(messageDateKey, dateHeader);
                    currentDateKey = messageDateKey;
                }

                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
                const messageObj = {
                    ...msg,
                    text: displayText
                };

                await addMessageToChat(messageObj, isMyMessage, false);
            }

            lastMessageId = messages.messages[messages.messages.length - 1].id;

            setTimeout(() => {
                initDateHeadersSystem();
                updateStickyDateHeaders();

                const messagesWrapper = document.getElementById('chat-messages-wrapper');
                if (messagesWrapper) {
                    messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
                }
            }, 0);
        } else {
            messagesContainer.innerHTML = '<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            lastMessageId = null;
        }
    } catch (error) {
        console.error('Error loading secure chat history:', error);
        document.getElementById('chat-messages').innerHTML = 
            '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    }
}

			async function preloadMediaForChat(userId) {
				if (!activeChats[userId]?.messagesData) return

				for (const message of activeChats[userId].messagesData) {
					if (message.isMedia && !message.mediaData) {
						try {
							const response = await eel.get_media_message(message.id)()
							if (response.success) {
								message.mediaData = response.media_data
							}
						} catch (error) {
							console.error('Error preloading media:', error)
						}
					}
				}
			}

			async function updateUserStatus() {
				if (!currentChatUserId) return

				try {
					const user = await eel.get_user_data(currentChatUserId)()
					if (!user) return

					const statusElement = document.getElementById('chat-status')
					const now = new Date()
					const lastOnline = new Date(user.last_online + ' UTC')

					const diffMinutes = Math.floor((now - lastOnline) / (1000 * 60))

					if (currentChatUserId === localStorage.getItem('user_id')) {
						statusElement.textContent = ''
						statusElement.classList.remove('online')
					} else if (diffMinutes < 5) {
						statusElement.textContent = '–í —Å–µ—Ç–∏'
						statusElement.classList.add('online')
					} else {
						statusElement.textContent = `–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏ ${formatTimeAgo(
							lastOnline
						)}`
						statusElement.classList.remove('online')
					}

					updateOnlineStatusInContacts()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error)
				}
			}

			function updateOnlineStatusInContacts() {
				const userBars = document.querySelectorAll(
					'.user-bar:not(.current-user)'
				)
				userBars.forEach(async bar => {
					const userId = bar.dataset.userId
					try {
						const user = await eel.get_user_data(userId)()
						if (user) {
							const now = new Date()
							const lastOnline = new Date(user.last_online + ' UTC')
							const diffMinutes = Math.floor((now - lastOnline) / (1000 * 60))

							const avatar = bar.querySelector('.avatar-medium')
							if (diffMinutes < 5) {
								avatar.classList.add('online')
							} else {
								avatar.classList.remove('online')
							}
						}
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞:', error)
					}
				})
			}

			function formatTimeAgo(date) {
				const now = new Date()
				const diff = Math.floor((now - date) / 1000)

				if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ'
				if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω. –Ω–∞–∑–∞–¥`
				if (diff < 86400) return `${Math.floor(diff / 3600)} —á. –Ω–∞–∑–∞–¥`

				const days = Math.floor(diff / 86400)
				if (days === 1) return '–≤—á–µ—Ä–∞'
				if (days < 7) return `${days} –¥–Ω. –Ω–∞–∑–∞–¥`

				return date.toLocaleDateString('ru-RU', {
					day: 'numeric',
					month: 'long',
					year: 'numeric',
				})
			}

			async function updateReadStatus() {
    if (!currentChatUserId) return;

    try {
        const myMessages = Array.from(document.querySelectorAll('.my-message'))
            .map(el => el.dataset.id)
            .filter(id => id);

        if (myMessages.length === 0) return;

        const readStatus = await eel.check_message_read_status(myMessages)();

        for (const [messageId, isRead] of Object.entries(readStatus)) {
            const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
            if (messageElement) {
                const infoElement = messageElement.querySelector('.message-info');
                if (infoElement) {
                    const timeElement = infoElement.querySelector('span');
                    const existingStatus = infoElement.querySelector('.read-status');
                    
                    if (existingStatus) {
                        existingStatus.textContent = isRead ? '‚úì‚úì' : '‚úì';
                        existingStatus.style.color = isRead ? '#4CAF50' : '#999';
                    } else if (timeElement) {
                        const readStatusElement = document.createElement('span');
                        readStatusElement.className = 'read-status';
                        readStatusElement.textContent = isRead ? '‚úì‚úì' : '‚úì';
                        readStatusElement.style.color = isRead ? '#4CAF50' : '#999';
                        readStatusElement.style.marginLeft = '5px';
                        infoElement.appendChild(readStatusElement);
                    }
                }
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è:', error);
    }
}

			async function loadChatHistory() {
				if (!currentChatUserId) return

				try {
					const messages = await eel.get_chat_history(
						localStorage.getItem('user_id'),
						currentChatUserId
					)()

					const chatMessages = document.getElementById('chatMessages')
					chatMessages.innerHTML = ''

					for (const msg of messages) {
						let displayText = msg.text

						// –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
						if (
							msg.is_encrypted &&
							msg.sender_id !== localStorage.getItem('user_id')
						) {
							displayText = await decryptMessageContent(msg.id)
						}

						displayMessage({
							...msg,
							text: displayText,
						})
					}

					scrollChatToBottom()
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:', error)
				}
			}
async function loadSecureChatHistory(userId) {
    try {
        const messages = await eel.get_encrypted_chat_history(
            localStorage.getItem('user_id'),
            userId
        )();
        
        const userPassword = sessionStorage.getItem('user_password');
        if (!userPassword) {
            throw new Error('–ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }

        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.innerHTML = '';

        if (messages.success && messages.messages.length > 0) {
            let currentDateKey = null;

            for (const msg of messages.messages) {
                const isMyMessage = msg.sender_id === localStorage.getItem('user_id');
                let displayText = msg.text;

                // –î–µ—à–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ
                if (msg.is_encrypted && msg.text) {
                    try {
                        displayText = await MessageEncryption.decryptMessage(msg.text, userPassword);
                    } catch (error) {
                        console.error('Decryption failed:', error);
                        displayText = '[–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ]';
                    }
                }

                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
                const messageObj = {
                    ...msg,
                    text: displayText
                };

                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                const messageDate = new Date(msg.timestamp);
                const messageDateKey = messageDate.toDateString();

                if (messageDateKey !== currentDateKey) {
                    const dateText = formatMessageDate(msg.timestamp);
                    const dateHeader = createDateHeader(dateText, messageDateKey);
                    messagesContainer.appendChild(dateHeader);
                    dateHeaders.set(messageDateKey, dateHeader);
                    currentDateKey = messageDateKey;
                }

                await addMessageToChat(messageObj, isMyMessage, false);
            }

            setTimeout(() => {
                const messagesWrapper = document.getElementById('chat-messages-wrapper');
                if (messagesWrapper) {
                    messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
                }
            }, 0);
        } else {
            messagesContainer.innerHTML = '<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
    } catch (error) {
        console.error('Error loading secure chat history:', error);
        document.getElementById('chat-messages').innerHTML = 
            '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    }
}

			async function updateLastMessageOnUserCard(userId, messageText, isMyMessage) {
    const userCard = document.querySelector(`.user-bar[data-user-id="${userId}"]`);
    if (!userCard) return;

    const lastMsgDiv = userCard.querySelector('.last-message');
    let displayText = messageText || "[–°–æ–æ–±—â–µ–Ω–∏–µ]";

    if (displayText.length > 25) {
        displayText = displayText.substring(0, 22) + '...';
    }

    if (isMyMessage) {
        if (lastMsgDiv) {
            lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`;
        } else {
            const contentWrapper = userCard.querySelector('.user-content-wrapper');
            if (contentWrapper) {
                const newLastMsgDiv = document.createElement('div');
                newLastMsgDiv.className = 'last-message';
                newLastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${displayText}`;
                contentWrapper.appendChild(newLastMsgDiv);
            }
        }
    } else {
        if (lastMsgDiv) {
            lastMsgDiv.textContent = displayText;
        } else {
            const contentWrapper = userCard.querySelector('.user-content-wrapper');
            if (contentWrapper) {
                const newLastMsgDiv = document.createElement('div');
                newLastMsgDiv.className = 'last-message';
                newLastMsgDiv.textContent = displayText;
                contentWrapper.appendChild(newLastMsgDiv);
            }
        }
    }
}

async function addMessageToChat(
    message,
    isMyMessage,
    scrollToBottom = true
) {
    const messagesContainer = document.getElementById('chat-messages');

    if (!messagesContainer) {
        console.error('Messages container not found');
        return null;
    }

    // –ü–†–û–í–ï–†–Ø–ï–ú, –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢ –õ–ò –£–ñ–ï –¢–ê–ö–û–ï –°–û–û–ë–©–ï–ù–ò–ï
    if (message.id) {
        const existingMessage = document.querySelector(`.message[data-id="${message.id}"]`);
        if (existingMessage) {
            console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', message.id);
            return existingMessage;
        }
    }

    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    const noMessagesDiv = messagesContainer.querySelector('.no-messages');
    if (noMessagesDiv) {
        noMessagesDiv.remove();
    }

    if (!message) {
        console.error('Message is null or undefined');
        return null;
    }

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageElement = document.createElement('div');
    messageElement.className = `message ${
        isMyMessage ? 'my-message' : 'their-message'
    }`;
    messageElement.dataset.id = message.id || '';
    messageElement.dataset.sender_id = message.sender_id || '';
    messageElement.dataset.timestamp =
        message.timestamp || new Date().toISOString();

    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    const messageTimestamp = message.timestamp || new Date().toISOString();
    const dateKey = new Date(messageTimestamp).toDateString();
    const dateText = formatMessageDate(messageTimestamp);

    // –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã —É–∂–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
    if (!dateHeaders.has(dateKey)) {
        const dateHeader = createDateHeader(dateText, dateKey);

        try {
            messagesContainer.appendChild(dateHeader);
            dateHeaders.set(dateKey, dateHeader);
        } catch (error) {
            console.error('Error adding date header:', error);
        }
    }

    // –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ –°–û–û–ë–©–ï–ù–ò–Ø
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';

    const textElement = document.createElement('div');
    textElement.className = 'message-text';

    // –û–ë–†–ê–ë–û–¢–ö–ê –†–ê–ó–ù–´–• –¢–ò–ü–û–í –°–û–û–ë–©–ï–ù–ò–ô
    let displayText = message.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]';

    // 1. –ú–µ–¥–∏–∞-—Å–æ–æ–±—â–µ–Ω–∏—è
    if (message.isMedia || message.is_media) {
        if (message.mediaType === 'video') {
            displayText = 'üé• [–í–∏–¥–µ–æ]';
        } else {
            displayText = 'üñºÔ∏è [–§–æ—Ç–æ]';
        }
        textElement.textContent = displayText;
    }
    // 2. –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    else if (message.isVoiceMessage || message.is_voice) {
        displayText = 'üé§ [–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]';
        textElement.textContent = displayText;
    }
    // 3. –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    else {
        textElement.textContent = displayText;
    }

    messageContent.appendChild(textElement);

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ–±—â–µ–Ω–∏–∏ (–≤—Ä–µ–º—è –∏ —Å—Ç–∞—Ç—É—Å)
    const infoElement = document.createElement('div');
    infoElement.className = 'message-info';

    const timeElement = document.createElement('span');
    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –í–†–ï–ú–Ø - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    timeElement.textContent = formatMessageTime(
        message.timestamp || new Date().toISOString()
    );
    infoElement.appendChild(timeElement);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if (isMyMessage) {
        const readStatus = document.createElement('span');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
        readStatus.textContent = message.read ? '‚úì‚úì' : '‚úì';
        readStatus.className = 'read-status';
        readStatus.style.color = message.read ? '#4CAF50' : '#999';
        readStatus.style.marginLeft = '5px';
        infoElement.appendChild(readStatus);
    }

    messageContent.appendChild(infoElement);
    messageElement.appendChild(messageContent);

    // –î–û–ë–ê–í–õ–Ø–ï–ú –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ –î–õ–Ø –°–û–û–ë–©–ï–ù–ò–Ø
    messageElement.addEventListener('contextmenu', e => {
        e.preventDefault();
        currentContextMessage = messageElement;

        const isMyMessage =
            message.sender_id === localStorage.getItem('user_id');
        const isMediaMessage = message.isMedia || message.is_media;
        const isVoiceMessage = message.isVoiceMessage || message.is_voice;

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
        const contextMenu = document.getElementById('message-context-menu');
        if (contextMenu) {
            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            document
                .getElementById('message-edit')
                .classList.toggle(
                    'hidden',
                    !isMyMessage || isMediaMessage || isVoiceMessage
                );

            // –£–¥–∞–ª–µ–Ω–∏–µ - —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è —Å–≤–æ–∏—Ö –∏ —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            document
                .getElementById('message-delete')
                .classList.toggle('hidden', !isMyMessage);
            document
                .getElementById('message-delete-for-me')
                .classList.toggle('hidden', isMyMessage);

            // –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            document
                .getElementById('message-pin')
                .classList.toggle('hidden', !isMyMessage || isVoiceMessage);

            // –û—Ç–≤–µ—Ç, –ø–µ—Ä–µ—Å—ã–ª–∫–∞, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ - –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            document
                .getElementById('message-reply')
                .classList.toggle('hidden', false);
            document
                .getElementById('message-forward')
                .classList.toggle('hidden', false);
            document
                .getElementById('message-copy')
                .classList.toggle('hidden', false);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
            showMessageContextMenu(e);
        }
    });

    // –î–û–ë–ê–í–õ–Ø–ï–ú –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–í–û–ô–ù–û–ì–û –ö–õ–ò–ö–ê –î–õ–Ø –ë–´–°–¢–†–û–ì–û –û–¢–í–ï–¢–ê
    messageElement.addEventListener('dblclick', () => {
        if (message.sender_id !== localStorage.getItem('user_id')) {
            handleQuickReply(message);
        }
    });

    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    try {
        messagesContainer.appendChild(messageElement);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        if (message.id) {
            if (!window.messageElements) {
                window.messageElements = new Map();
            }
            window.messageElements.set(message.id, messageElement);
        }
    } catch (error) {
        console.error('Error adding message to container:', error);
        return null;
    }

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (scrollToBottom) {
        setTimeout(() => {
            const messagesWrapper = document.getElementById(
                'chat-messages-wrapper'
            );
            if (messagesWrapper) {
                messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
                setTimeout(updateStickyDateHeaders, 100);
            }
        }, 0);
    }

    if (message.isVoiceMessage || message.is_voice) {
        await updateVoiceMessageStatus(messageElement, message);
    }

    return messageElement;
}

			function handleQuickReply(message) {
				const messageText = message.text || '[–°–æ–æ–±—â–µ–Ω–∏–µ]'
				const messageInput = document.getElementById('message-input')
				messageInput.value = `> ${messageText}\n`
				messageInput.focus()

				// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∞
				const replyContainer = document.getElementById('reply-container')
				if (replyContainer) {
					const isMyMessage =
						message.sender_id === localStorage.getItem('user_id')

					replyContainer.innerHTML = `
            <div class="reply-header">
                <div class="reply-author">${
									isMyMessage ? '–í—ã' : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'
								}</div>
                <div class="reply-close">√ó</div>
            </div>
            <div class="reply-text">${
							messageText.length > 50
								? messageText.substring(0, 47) + '...'
								: messageText
						}</div>
        `

					replyContainer.classList.remove('hidden')
					document
						.querySelector('.message-input-container')
						.classList.add('expanded')

					// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Ç–≤–µ—Ç–∞
					replyContainer
						.querySelector('.reply-close')
						.addEventListener('click', () => {
							replyContainer.classList.add('hidden')
							document
								.querySelector('.message-input-container')
								.classList.remove('expanded')
							messageInput.value = ''
						})
				}
			}

			async function updateVoiceMessageStatus(messageElement, message) {
				// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
				const voiceElement = messageElement.querySelector('.voice-message')
				if (voiceElement) {
					const indicator = voiceElement.querySelector('.listen-indicator')
					if (indicator) {
						// –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
						// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ—Å–ª—É—à–∞–Ω–æ
						indicator.style.opacity = message.listened ? '0' : '0.7'
					}
				}
			}

			function updateMessageReadStatus(messageId, isRead) {
				if (window.messageElements && window.messageElements.has(messageId)) {
					const messageElement = window.messageElements.get(messageId)
					const readStatus = messageElement.querySelector('.read-status')
					if (readStatus) {
						readStatus.textContent = isRead ? '‚úì‚úì' : '‚úì'
						readStatus.style.color = isRead ? '#4CAF50' : '#999'
					}
				}
			}

			function updateMessageText(messageId, newText) {
				if (window.messageElements && window.messageElements.has(messageId)) {
					const messageElement = window.messageElements.get(messageId)
					const textElement = messageElement.querySelector('.message-text')
					if (textElement) {
						textElement.textContent = newText

						// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const editBadge = document.createElement('span')
						editBadge.className = 'edit-badge'
						editBadge.textContent = ' (—Ä–µ–¥.)'
						editBadge.style.color = '#999'
						editBadge.style.fontSize = '0.8em'
						textElement.appendChild(editBadge)
					}
				}
			}

			async function checkForNewMessages() {
				if (!currentChatUserId) return

				try {
					const newMessages = await eel.check_new_messages(
						localStorage.getItem('user_id'),
						lastMessageId
					)()

					if (newMessages && newMessages.length > 0) {
						for (const msg of newMessages) {
							// –í–ê–ñ–ù–û: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏–∏
							// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏
							const existingMessage = document.querySelector(
								`.message[data-id="${msg.id}"]`
							)
							if (existingMessage) {
								console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', msg.id)
								continue
							}

							// –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ù–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è
							if (
								msg.sender_id === currentChatUserId &&
								msg.sender_id !== localStorage.getItem('user_id')
							) {
								await addMessageToChat(msg, false, true)
								// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ
								updateLastMessageOnUserCard(currentChatUserId, msg.text, false)
							}
						}

						if (newMessages.length > 0) {
							lastMessageId = newMessages[newMessages.length - 1].id
						}

						const messagesContainer = document.getElementById('chat-messages')
						activeChats[currentChatUserId] = {
							messages: messagesContainer.innerHTML,
							lastMessageId: lastMessageId,
						}

						updateOnlineStatusInContacts()

						// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
						setupVoiceMessageHandlers()
					}
				} catch (error) {
					console.error('Error checking new messages:', error)
				}
			}

async function sendSecureMessage(text) {
    if (!currentChatUserId || !text.trim()) {
        return false;
    }

    try {
        const user_id = localStorage.getItem('user_id');
        const userPassword = sessionStorage.getItem('user_password');
        
        if (!userPassword) {
            throw new Error('–ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è');
        }

        // –®–∏—Ñ—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        const encryptedText = await MessageEncryption.encryptMessage(text, userPassword);
        
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const result = await eel.send_encrypted_message(user_id, currentChatUserId, encryptedText)();

        if (result.success) {
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Å –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º)
            const messageData = {
                id: result.message_id,
                sender_id: user_id,
                receiver_id: currentChatUserId,
                text: text, // –õ–æ–∫–∞–ª—å–Ω–æ —Ö—Ä–∞–Ω–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
                timestamp: result.timestamp,
                read: result.read,
                is_encrypted: true
            };

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            await addMessageToChat(messageData, true, true);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            updateLastMessageOnUserCard(currentChatUserId, text, true);
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('message-input').value = '';
            
            console.log('–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            return true;
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + result.message);
            return false;
        }
    } catch (error) {
        console.error('Error sending secure message:', error);
        alert('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
        return false;
    }
}

async function checkEncryptionStatus(userId) {
    try {
        const user_id = localStorage.getItem('user_id');
        const status = await eel.check_chat_encryption_status(user_id, userId)();
        console.log('–°—Ç–∞—Ç—É—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞:', status);
        return status.encrypted;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error);
        return false;
    }
}

			async function loadFriends() {
    console.log('=== –ù–ê–ß–ê–õ–û loadFriends ===');
    const user_id = localStorage.getItem('user_id');
    
    if (!user_id) {
        console.error('User ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
        return;
    }

    try {
        currentUser = await eel.get_user_data(user_id)();
        const container = document.getElementById('user-container');
        container.innerHTML = '';

        // –ö–∞—Ä—Ç–æ—á–∫–∞ —á–∞—Ç–∞ —Å —Å–∞–º–∏–º —Å–æ–±–æ–π
        const selfCard = createUserCard({
            user_id: user_id,
            nickname: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ',
            isCurrentUser: true,
            isSelfChat: true,
        });
        container.appendChild(selfCard);

        // –î–æ–±–∞–≤–ª—è–µ–º –¥—Ä—É–∑–µ–π
        if (currentUser.friends && currentUser.friends.length > 0) {
            for (const friendId of currentUser.friends) {
                try {
                    const friend = await eel.get_user_data(friendId)();
                    if (friend) {
                        const lastMessage = await eel.get_last_message(user_id, friendId)();
                        const friendCard = createUserCard({
                            user_id: friendId,
                            nickname: friend.nickname,
                            isFriend: true,
                            lastMessage: lastMessage,
                        });
                        container.appendChild(friendCard);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–≥–∞:', friendId, error);
                }
            }
            updateOnlineStatusInContacts();
        } else {
            const noFriends = document.createElement('div');
            noFriends.className = 'no-friends';
            noFriends.textContent = '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π. –ù–∞–π–¥–∏—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫!';
            container.appendChild(noFriends);
        }
    } catch (error) {
        console.error('Error loading friends:', error);
    }
}

			function createUserCard(userData) {
    console.log('–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userData);

    const card = document.createElement('div');
    card.className = 'user-bar' + (userData.isCurrentUser ? ' current-user' : '');
    card.dataset.userId = userData.user_id;

    const avatar = document.createElement('div');
    avatar.className = 'avatar-medium';

    if (userData.isSelfChat) {
        avatar.style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/512/1077/1077114.png)';
        avatar.style.backgroundColor = '#4CAF50';
    } else {
        avatar.style.backgroundImage = 'url(https://cdn-icons-png.flaticon.com/512/3135/3135715.png)';
    }

    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'user-content-wrapper';

    const username = document.createElement('div');
    username.className = 'username';

    if (userData.isSelfChat) {
        username.textContent = '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ';
        username.style.fontWeight = 'bold';
        username.style.color = '#4CAF50';
    } else if (userData.isCurrentUser) {
        username.textContent = '–í—ã';
    } else {
        username.textContent = userData.nickname;
    }

    contentWrapper.appendChild(username);

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    if (userData.lastMessage && !userData.isCurrentUser && !userData.isSelfChat) {
        const lastMsgDiv = document.createElement('div');
        lastMsgDiv.className = 'last-message';

        let messageText = userData.lastMessage.text || "[–°–æ–æ–±—â–µ–Ω–∏–µ]";
        if (messageText.length > 25) {
            messageText = messageText.substring(0, 22) + '...';
        }

        if (userData.lastMessage.sender_id === localStorage.getItem('user_id')) {
            lastMsgDiv.innerHTML = `<span class="you-indicator">–í—ã:</span> ${messageText}`;
        } else {
            lastMsgDiv.textContent = messageText;
        }

        contentWrapper.appendChild(lastMsgDiv);
    }

    card.appendChild(avatar);
    card.appendChild(contentWrapper);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
    card.addEventListener('click', function () {
        console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç —Å:', userData.user_id);
        openChat(userData.user_id);

        document.querySelectorAll('.user-bar').forEach(el => {
            el.classList.remove('active-chat');
        });
        card.classList.add('active-chat');
    });

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Ç–æ–ª—å–∫–æ –¥–ª—è –¥—Ä—É–∑–µ–π
    if (!userData.isSelfChat && !userData.isCurrentUser) {
        card.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            showContextMenu(e, userData);
        });
    }

    return card;
}

			function showContextMenu(e, userData) {
				closeContextMenu()

				contextMenuTarget = userData.user_id

				const addBtn = document.getElementById('context-menu-add')
				const removeBtn = document.getElementById('context-menu-remove')

				if (currentUser.friends.includes(userData.user_id)) {
					addBtn.classList.add('hidden')
					removeBtn.classList.remove('hidden')
				} else {
					addBtn.classList.remove('hidden')
					removeBtn.classList.add('hidden')
				}

				contextMenu.style.display = 'block'
				contextMenu.style.left = `${e.pageX}px`
				contextMenu.style.top = `${e.pageY}px`
			}

			function closeContextMenu() {
				if (contextMenu) {
					contextMenu.style.display = 'none'
				}
				contextMenuTarget = null
			}

			async function handleAddFriend() {
				if (!contextMenuTarget) return

				const user_id = localStorage.getItem('user_id')
				try {
					const response = await eel.add_friend(user_id, contextMenuTarget)()

					if (response.success) {
						await loadFriends()
					}
					alert(response.message)
				} catch (error) {
					alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –¥—Ä—É–∑—å—è')
					console.error('Error adding friend:', error)
				}

				closeContextMenu()
			}

			async function handleRemoveFriend() {
				if (!contextMenuTarget) return

				const user_id = localStorage.getItem('user_id')
				try {
					const response = await eel.remove_friend(user_id, contextMenuTarget)()

					if (response.success) {
						await loadFriends()
						if (currentChatUserId === contextMenuTarget) {
							closeChat()
						}
					}
					alert(response.message)
				} catch (error) {
					alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –¥—Ä—É–∑–µ–π')
					console.error('Error removing friend:', error)
				}

				closeContextMenu()
			}

			async function displaySearchResults(users) {
				const container = document.getElementById('user-container')
				container.innerHTML = ''

				if (users.length === 0) {
					const noResults = document.createElement('div')
					noResults.className = 'no-results'
					noResults.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
					container.appendChild(noResults)
					return
				}

				for (const user of users) {
					const isFriend = currentUser.friends.includes(user.user_id)
					// –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
					const lastMessage = await eel.get_last_message(
						localStorage.getItem('user_id'),
						user.user_id
					)()
					const userCard = createUserCard({
						user_id: user.user_id,
						nickname: user.nickname, // –û—Ç–∫—Ä—ã—Ç—ã–π –Ω–∏–∫–Ω–µ–π–º
						isFriend: isFriend,
						lastMessage: lastMessage,
					})
					container.appendChild(userCard)
				}

				updateOnlineStatusInContacts()
			}

function initButtonHandlers() {
    const messageInput = document.getElementById('message-input');


    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
    const menuIcon = document.querySelector('.menu-icon');
    if (menuIcon) {
        menuIcon.addEventListener('click', function() {
            document.getElementById('logout-overlay').classList.remove('hidden');
            document.getElementById('logout-modal').classList.remove('hidden');
        });
    }

    console.log('Button handlers initialized');
}

			// –í—ã–∑–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
			setTimeout(initButtonHandlers, 1000)

			function initMessageContextMenu() {
				console.log('initMessageContextMenu –≤—ã–∑–≤–∞–Ω–∞')
				const messageContextMenu = document.getElementById(
					'message-context-menu'
				)
				window.messageContextMenu = messageContextMenu // –î–µ–ª–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π

				// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
				document.addEventListener('click', function (e) {
					if (messageContextMenu && !messageContextMenu.contains(e.target)) {
						messageContextMenu.classList.add('hidden')
					}
				})

				// –í —Ñ—É–Ω–∫—Ü–∏–∏ initMessageContextMenu –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞:
				document.addEventListener('contextmenu', function (e) {
					const messageElement = e.target.closest('.message')
					if (messageElement) {
						e.preventDefault()
						currentContextMessage = messageElement

						const isVideoMessage =
							messageElement.querySelector('.video-preview') !== null
						const isVoiceMessage =
							messageElement.querySelector('.voice-message') !== null
						const isMyMessage = messageElement.classList.contains('my-message')

						// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
						document
							.getElementById('message-edit')
							.classList.toggle(
								'hidden',
								!isMyMessage || isVideoMessage || isVoiceMessage
							)
						document
							.getElementById('message-delete')
							.classList.toggle('hidden', !isMyMessage)
						document
							.getElementById('message-delete-for-me')
							.classList.toggle('hidden', isMyMessage)
						document
							.getElementById('message-pin')
							.classList.toggle('hidden', !isMyMessage || isVoiceMessage)
						document
							.getElementById('message-reply')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-forward')
							.classList.toggle('hidden', false)
						document
							.getElementById('message-copy')
							.classList.toggle('hidden', false)

						// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é
						const menuWidth = messageContextMenu.offsetWidth
						const menuHeight = messageContextMenu.offsetHeight
						const windowWidth = window.innerWidth
						const windowHeight = window.innerHeight

						let left = e.clientX
						let top = e.clientY

						// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã –º–µ–Ω—é –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
						if (left + menuWidth > windowWidth) {
							left = windowWidth - menuWidth - 5
						}

						if (top + menuHeight > windowHeight) {
							top = windowHeight - menuHeight - 5
						}

						messageContextMenu.style.left = `${left}px`
						messageContextMenu.style.top = `${top}px`
						messageContextMenu.style.display = 'block'
						messageContextMenu.classList.remove('hidden')

						// –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–µ–Ω—é –ø–æ–≤–µ—Ä—Ö –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
						messageContextMenu.style.zIndex = '1000'
					}
				})

				// –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
				function closeMessageContextMenu() {
					if (messageContextMenu) {
						messageContextMenu.classList.add('hidden')
					}
				}

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
				document
					.getElementById('message-reply')
					.addEventListener('click', function () {
						handleReply()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-edit')
					.addEventListener('click', function () {
						handleEdit()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-pin')
					.addEventListener('click', function () {
						handlePin()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-delete')
					.addEventListener('click', function () {
						handleDelete()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-forward')
					.addEventListener('click', function () {
						handleForward()
						closeMessageContextMenu()
					})

				document
					.getElementById('message-copy')
					.addEventListener('click', function () {
						handleCopy()
						closeMessageContextMenu()
					})





async function initializeEncryption() {
    try {
        const user_id = localStorage.getItem('user_id');
        if (!user_id) return false;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ECDH –∫–ª—é—á–µ–≤—É—é –ø–∞—Ä—É
        const keyResult = await eel.generate_ecdh_keypair(user_id)();
        if (!keyResult.success) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—É—é –ø–∞—Ä—É:', keyResult.message);
            return false;
        }

        console.log('–ö–ª—é—á–µ–≤–∞—è –ø–∞—Ä–∞ ECDH —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞');
        return true;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error);
        return false;
    }
}

async function establishSecureConnection(peer_id) {
    try {
        const user_id = localStorage.getItem('user_id');
        const result = await eel.establish_secure_connection(user_id, peer_id)();
        
        if (result.success) {
            console.log('–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            encryptionEnabled = true;
            return true;
        } else {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:', result.message);
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
        return false;
    }
}

async function debugEncryption() {
    const user_id = localStorage.getItem('user_id');
    const peer_id = currentChatUserId;
    
    if (!peer_id) {
        console.error('–ß–∞—Ç –Ω–µ –æ—Ç–∫—Ä—ã—Ç');
        return;
    }
    
    console.log('=== –û–¢–õ–ê–î–ö–ê –®–ò–§–†–û–í–ê–ù–ò–Ø ===');
    const status = await eel.debug_encryption_status(user_id, peer_id)();
    console.log('–°—Ç–∞—Ç—É—Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', status);
    
    // –ü—Ä–æ–≤–µ—Ä–∏–º, –∫–∞–∫–æ–π –ø—É—Ç—å –≤—ã–±–∏—Ä–∞–µ—Ç send_zk_message
    const key_data = await eel.get_shared_key(user_id, peer_id)();
    console.log('–û–±—â–∏–π –∫–ª—é—á:', key_data);
}

// –í—ã–∑–æ–≤–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞



async function sendEncryptedMessage(text) {
    if (!currentChatUserId || !encryptionEnabled) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
        return await sendRegularMessage(text);
    }

    try {
        const user_id = localStorage.getItem('user_id');
        const result = await eel.send_encrypted_message(user_id, currentChatUserId, text)();
        
        if (result.success) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            const messageData = {
                id: result.message_id,
                sender_id: user_id,
                receiver_id: currentChatUserId,
                text: text,
                timestamp: result.timestamp,
                read: true,
                is_encrypted: true
            };
            
            await addMessageToChat(messageData, true, true);
            updateLastMessageOnUserCard(currentChatUserId, text, true);
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('message-input').value = '';
            
            return true;
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + result.message);
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        return false;
    }
}

async function sendRegularMessage(text) {
    try {
        const user_id = localStorage.getItem('user_id');
        const result = await eel.send_message(user_id, currentChatUserId, text)();
        
        if (result.success) {
            const messageData = {
                id: result.message_id,
                sender_id: user_id,
                receiver_id: currentChatUserId,
                text: text,
                timestamp: result.timestamp,
                read: result.read
            };
            
            await addMessageToChat(messageData, true, true);
            updateLastMessageOnUserCard(currentChatUserId, text, true);
            
            document.getElementById('message-input').value = '';
            return true;
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + result.message);
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        return false;
    }
}

async function loadZKChatHistory(userId) {
    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);

    // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —á–∞—Ç
    if (window.isLoadingChat === userId) {
        console.log('–ß–∞—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', userId);
        return;
    }

    try {
        window.isLoadingChat = userId; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏

        const user_id = localStorage.getItem('user_id');
        console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥–ª—è:', user_id, '—Å:', userId);
        
        const messages = await eel.get_chat_messages_decrypted(user_id, userId)();
        
        console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π:', messages ? messages.length : 0);

        const messagesContainer = document.getElementById('chat-messages');
        if (!messagesContainer) {
            console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            return;
        }

        messagesContainer.innerHTML = '';

        dateHeaders.clear();
        currentStickyDate = null;
        if (dateHeadersObserver) {
            dateHeadersObserver.disconnect();
            dateHeadersObserver = null;
        }

        if (messages && Array.isArray(messages) && messages.length > 0) {
            console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è:', messages.length);
            
            let currentDateKey = null;

            for (const msg of messages) {
                const isMyMessage = msg.sender_id === user_id;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã
                const messageDate = new Date(msg.timestamp);
                const messageDateKey = messageDate.toDateString();

                if (messageDateKey !== currentDateKey) {
                    const dateText = formatMessageDate(msg.timestamp);
                    const dateHeader = createDateHeader(dateText, messageDateKey);
                    messagesContainer.appendChild(dateHeader);
                    dateHeaders.set(messageDateKey, dateHeader);
                    currentDateKey = messageDateKey;
                }

                await addMessageToChat(msg, isMyMessage, false);
            }

            lastMessageId = messages[messages.length - 1].id;
            console.log('Last message ID —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', lastMessageId);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞
            activeChats[userId] = {
                messages: messagesContainer.innerHTML,
                lastMessageId: lastMessageId,
                messagesData: messages,
            };

            setTimeout(() => {
                initDateHeadersSystem();
                updateStickyDateHeaders();

                const messagesWrapper = document.getElementById('chat-messages-wrapper');
                if (messagesWrapper) {
                    messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
                }
            }, 0);
        } else {
            console.log('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ');
            messagesContainer.innerHTML = '<div class="no-messages">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            lastMessageId = null;
            activeChats[userId] = {
                messages: messagesContainer.innerHTML,
                lastMessageId: null,
                messagesData: [],
            };
        }
    } catch (error) {
        console.error('Error loading chat history:', error);
        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) {
            messagesContainer.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
    } finally {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
        window.isLoadingChat = null;
    }
}



				async function handleReply() {
					if (!currentContextMessage) return

					try {
						const messageText =
							currentContextMessage.querySelector('.message-text')
								?.textContent || '[–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]'
						const isMyMessage =
							currentContextMessage.classList.contains('my-message')
						const replyContainer = document.getElementById('reply-container')
						const messageId = currentContextMessage.dataset.id

						// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –ë–î –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
						await eel.save_reply_state(
							localStorage.getItem('user_id'),
							currentChatUserId,
							messageId
						)()

						// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—á–∞–µ–º
						replyContainer.dataset.messageId = messageId

						replyContainer.innerHTML = `
            <div class="reply-header">
                <div class="reply-author">${
									isMyMessage
										? '–í—ã'
										: document.getElementById('chat-username').textContent
								}</div>
                <div class="reply-close">√ó</div>
            </div>
            <div class="reply-text">${
							messageText.length > 50
								? messageText.substring(0, 47) + '...'
								: messageText
						}</div>
        `

						replyContainer.classList.remove('hidden')
						document
							.querySelector('.message-input-container')
							.classList.add('expanded')

						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Ç–≤–µ—Ç–∞
						replyContainer
							.querySelector('.reply-close')
							.addEventListener('click', async () => {
								replyContainer.classList.add('hidden')
								document
									.querySelector('.message-input-container')
									.classList.remove('expanded')
								// –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –ë–î –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
								await eel.clear_reply_state(
									localStorage.getItem('user_id'),
									currentChatUserId
								)()
							})

						const messageInput = document.getElementById('message-input')
						messageInput.focus()
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞:', error)
					}
				}

				function handleEdit() {
					if (!currentContextMessage) {
						messageContextMenu.classList.add('hidden')
						return
					}

					try {
						const messageId = currentContextMessage.dataset.id
						const messageTextElement =
							currentContextMessage.querySelector('.message-text')
						const originalText = messageTextElement.textContent

						// –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const input = document.createElement('input')
						input.type = 'text'
						input.value = originalText
						input.className = 'edit-message-input'

						// –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
						messageTextElement.replaceWith(input)
						input.focus()

						// –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const finishEditing = async newText => {
							if (newText && newText !== originalText) {
								const result = await eel.edit_message(messageId, newText)()
								if (!result.success) {
									throw new Error(
										result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'
									)
								}
								return newText
							}
							return originalText
						}

						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
						const handleKeyDown = async e => {
							if (e.key === 'Enter') {
								const newText = input.value.trim()
								try {
									const finalText = await finishEditing(newText)
									messageTextElement.textContent = finalText
								} catch (error) {
									alert(error.message)
									messageTextElement.textContent = originalText
								}
								cleanup()
							} else if (e.key === 'Escape') {
								messageTextElement.textContent = originalText
								cleanup()
							}
						}

						const handleBlur = async () => {
							const newText = input.value.trim()
							try {
								const finalText = await finishEditing(newText)
								messageTextElement.textContent = finalText
							} catch (error) {
								alert(error.message)
								messageTextElement.textContent = originalText
							}
							cleanup()
						}

						const cleanup = () => {
							input.replaceWith(messageTextElement)
							input.removeEventListener('keydown', handleKeyDown)
							input.removeEventListener('blur', handleBlur)
							messageContextMenu.classList.add('hidden')
						}

						input.addEventListener('keydown', handleKeyDown)
						input.addEventListener('blur', handleBlur)
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:', error)
						alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è')
						messageContextMenu.classList.add('hidden')
					}
				}

				function handlePin() {
					alert('–§—É–Ω–∫—Ü–∏—è "–ó–∞–∫—Ä–µ–ø–∏—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					messageContextMenu.classList.add('hidden')
				}

				eel.expose(get_current_user_id)
				function get_current_user_id() {
					return localStorage.getItem('user_id')
				}

				function handleForward() {
					alert('–§—É–Ω–∫—Ü–∏—è "–ü–µ—Ä–µ—Å–ª–∞—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					messageContextMenu.classList.add('hidden')
				}

				function handleCopy() {
					if (!currentContextMessage) {
						messageContextMenu.classList.add('hidden')
						return
					}

					try {
						const messageText =
							currentContextMessage.querySelector('.message-text').textContent
						navigator.clipboard
							.writeText(messageText)
							.then(() => {
								console.log('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞')
							})
							.catch(err => {
								console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err)
								alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç')
							})
					} catch (error) {
						console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', error)
						alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞')
					} finally {
						messageContextMenu.classList.add('hidden')
					}
				}
			}

			function showMessageContextMenu(e) {
				const messageContextMenu = document.getElementById(
					'message-context-menu'
				)
				if (!messageContextMenu) return

				messageContextMenu.classList.add('hidden')

				const menuWidth = messageContextMenu.offsetWidth
				const menuHeight = messageContextMenu.offsetHeight
				const windowWidth = window.innerWidth
				const windowHeight = window.innerHeight

				let left = e.clientX
				let top = e.clientY

				if (left + menuWidth > windowWidth) {
					left = windowWidth - menuWidth - 5
				}

				if (top + menuHeight > windowHeight) {
					top = windowHeight - menuHeight - 5
				}

				messageContextMenu.style.left = `${left}px`
				messageContextMenu.style.top = `${top}px`
				messageContextMenu.style.display = 'block'
				messageContextMenu.classList.remove('hidden')
				messageContextMenu.style.zIndex = '1000'
			}

			// –°–¥–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π
			window.showMessageContextMenu = showMessageContextMenu

			// –í—ã–∑–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
			document.addEventListener('DOMContentLoaded', function () {
				initMessageContextMenu()
			})

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
			document.getElementById('message-reply').addEventListener('click', () => {
				if (currentContextMessage) {
					const messageText =
						currentContextMessage.querySelector('.message-text').textContent
					const messageInput = document.getElementById('message-input')
					messageInput.value = `–û—Ç–≤–µ—Ç –Ω–∞: "${messageText}" `
					messageInput.focus()
				}
				messageContextMenu.classList.add('hidden')
			})

			document
				.getElementById('message-edit')
				.addEventListener('click', async () => {
					if (currentContextMessage) {
						const messageId = currentContextMessage.dataset.id
						const messageText =
							currentContextMessage.querySelector('.message-text')
						const originalText = messageText.textContent

						// –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const input = document.createElement('input')
						input.type = 'text'
						input.value = originalText
						input.className = 'edit-message-input'

						// –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
						messageText.replaceWith(input)
						input.focus()

						// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
						const handleEdit = async e => {
							if (e.key === 'Enter' || e.type === 'blur') {
								const newText = input.value.trim()
								if (newText && newText !== originalText) {
									try {
										const result = await eel.edit_message(messageId, newText)()
										if (result.success) {
											messageText.textContent = newText
										} else {
											alert(result.message)
											messageText.textContent = originalText
										}
									} catch (error) {
										console.error('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error)
										messageText.textContent = originalText
									}
								} else {
									messageText.textContent = originalText
								}

								input.replaceWith(messageText)
								input.removeEventListener('keydown', handleEdit)
								input.removeEventListener('blur', handleEdit)
							} else if (e.key === 'Escape') {
								messageText.textContent = originalText
								input.replaceWith(messageText)
								input.removeEventListener('keydown', handleEdit)
								input.removeEventListener('blur', handleEdit)
							}
						}

						input.addEventListener('keydown', handleEdit)
						input.addEventListener('blur', handleEdit)
					}
					messageContextMenu.classList.add('hidden')
				})

			document.getElementById('message-pin').addEventListener('click', () => {
				if (currentContextMessage) {
					alert('–§—É–Ω–∫—Ü–∏—è "–ó–∞–∫—Ä–µ–ø–∏—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
				}
				messageContextMenu.classList.add('hidden')
			})

			document
				.getElementById('message-delete')
				.addEventListener('click', async () => {
					if (currentContextMessage) {
						if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
							const messageId = currentContextMessage.dataset.id
							try {
								const result = await eel.delete_message(messageId)()
								if (result.success) {
									currentContextMessage.remove()
								} else {
									alert(result.message)
								}
							} catch (error) {
								console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error)
								alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è')
							}
						}
					}
					messageContextMenu.classList.add('hidden')
				})

			document
				.getElementById('message-forward')
				.addEventListener('click', () => {
					if (currentContextMessage) {
						alert('–§—É–Ω–∫—Ü–∏—è "–ü–µ—Ä–µ—Å–ª–∞—Ç—å" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º')
					}
					messageContextMenu.classList.add('hidden')
				})

			document.getElementById('message-copy').addEventListener('click', () => {
				if (currentContextMessage) {
					const messageText =
						currentContextMessage.querySelector('.message-text').textContent
					navigator.clipboard
						.writeText(messageText)
						.then(() => {
							// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
							console.log('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')
						})
						.catch(err => {
							console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err)
						})
				}
				messageContextMenu.classList.add('hidden')
			})

			// –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
			const style = document.createElement('style')
			style.textContent = `
    .edit-message-input {
        width: 100%;
        padding: 5px;
        border: 1px solid #4CAF50;
        border-radius: 4px;
        font-size: 14px;
    }
`
			document.head.appendChild(style)

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–µ–Ω—é —Ñ–æ—Ç–æ
			const photoBtn = document.getElementById('photo-message-btn')
			const photoOptionsMenu = document.getElementById('photo-options-menu')
			const fileInput = document.getElementById('file-input')
			const mediaSendModal = document.getElementById('media-send-modal')
			const mediaSendOverlay = document.getElementById('media-send-overlay')
			const mediaSendTitle = document.getElementById('media-send-title')
			const imagePreview = document.getElementById('image-preview')
			const videoPreview = document.getElementById('video-preview')
			const mediaCaptionInput = document.getElementById('media-caption-input')
			const mediaAddButton = document.getElementById('media-add-button')
			const mediaCancelButton = document.getElementById('media-cancel-button')
			const mediaSendButton = document.getElementById('media-send-button')

			let currentMediaType = 'photo'
			let photoMenuTimeout

			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
			photoBtn.addEventListener('mouseenter', () => {
				clearTimeout(photoMenuTimeout)
				positionPhotoMenu()
				photoOptionsMenu.classList.remove('hidden')
				photoOptionsMenu.classList.add('show')
			})

			// –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –∫–Ω–æ–ø–∫–∏ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
			photoBtn.addEventListener('mouseleave', () => {
				photoMenuTimeout = setTimeout(() => {
					photoOptionsMenu.classList.remove('show')
				}, 200)
			})

			// –û—Ç–º–µ–Ω—è–µ–º —Å–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –º–µ–Ω—é
			photoOptionsMenu.addEventListener('mouseenter', () => {
				clearTimeout(photoMenuTimeout)
			})

			// –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –Ω–µ–≥–æ
			photoOptionsMenu.addEventListener('mouseleave', () => {
				photoOptionsMenu.classList.remove('show')
			})

			// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
			document.querySelectorAll('.photo-option').forEach(option => {
				option.addEventListener('click', function () {
					const type = this.dataset.type
					if (type === 'photo-video') {
						openFileSelector()
					} else {
						alert(`–í—ã–±—Ä–∞–Ω–∞ –æ–ø—Ü–∏—è: ${this.querySelector('span').textContent}`)
					}
					photoOptionsMenu.classList.remove('show')
				})
			})

			function formatMessageDate(timestamp) {
				const messageDate = new Date(timestamp)
				const today = new Date()
				const yesterday = new Date(today)
				yesterday.setDate(yesterday.getDate() - 1)
				const twoDaysAgo = new Date(today)
				twoDaysAgo.setDate(twoDaysAgo.getDate() - 2)

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–∞—Ç
				const messageDateOnly = new Date(
					messageDate.getFullYear(),
					messageDate.getMonth(),
					messageDate.getDate()
				)
				const todayOnly = new Date(
					today.getFullYear(),
					today.getMonth(),
					today.getDate()
				)
				const yesterdayOnly = new Date(
					yesterday.getFullYear(),
					yesterday.getMonth(),
					yesterday.getDate()
				)
				const twoDaysAgoOnly = new Date(
					twoDaysAgo.getFullYear(),
					twoDaysAgo.getMonth(),
					twoDaysAgo.getDate()
				)

				if (messageDateOnly.getTime() === todayOnly.getTime()) {
					return '–°–µ–≥–æ–¥–Ω—è'
				} else if (messageDateOnly.getTime() === yesterdayOnly.getTime()) {
					return '–í—á–µ—Ä–∞'
				} else if (messageDateOnly.getTime() === twoDaysAgoOnly.getTime()) {
					return '–ü–æ–∑–∞–≤—á–µ—Ä–∞'
				} else {
					// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –¥–∞—Ç–∞ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
					const startOfWeek = new Date(today)
					startOfWeek.setDate(today.getDate() - today.getDay())
					startOfWeek.setHours(0, 0, 0, 0)

					if (messageDate >= startOfWeek) {
						// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
						const days = [
							'–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ',
							'–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',
							'–í—Ç–æ—Ä–Ω–∏–∫',
							'–°—Ä–µ–¥–∞',
							'–ß–µ—Ç–≤–µ—Ä–≥',
							'–ü—è—Ç–Ω–∏—Ü–∞',
							'–°—É–±–±–æ—Ç–∞',
						]
						return days[messageDate.getDay()]
					} else {
						// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –¥–∞—Ç—É
						const months = [
							'—è–Ω–≤–∞—Ä—è',
							'—Ñ–µ–≤—Ä–∞–ª—è',
							'–º–∞—Ä—Ç–∞',
							'–∞–ø—Ä–µ–ª—è',
							'–º–∞—è',
							'–∏—é–Ω—è',
							'–∏—é–ª—è',
							'–∞–≤–≥—É—Å—Ç–∞',
							'—Å–µ–Ω—Ç—è–±—Ä—è',
							'–æ–∫—Ç—è–±—Ä—è',
							'–Ω–æ—è–±—Ä—è',
							'–¥–µ–∫–∞–±—Ä—è',
						]
						return `${messageDate.getDate()} ${
							months[messageDate.getMonth()]
						} ${messageDate.getFullYear()}`
					}
				}
			}

			function createDateHeader(dateText, dateKey) {
				const dateHeader = document.createElement('div')
				dateHeader.className = 'date-header'
				dateHeader.dataset.dateKey = dateKey

				const dateContent = document.createElement('div')
				dateContent.className = 'date-header-content'
				dateContent.textContent = dateText

				dateHeader.appendChild(dateContent)
				return dateHeader
			}

			function addDateHeaderToMessage(messageElement, timestamp) {
				const dateKey = new Date(timestamp).toDateString() // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã
				const dateText = formatMessageDate(timestamp)

				// –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
				if (dateHeaders.has(dateKey)) {
					return
				}

				const dateHeader = createDateHeader(dateText, dateKey)
				dateHeaders.set(dateKey, dateHeader)

				// –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–µ—Ä–µ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º
				const messagesContainer = document.getElementById('chat-messages')
				messagesContainer.insertBefore(dateHeader, messageElement)
			}

			function updateStickyDateHeaders() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				if (!messagesWrapper) return

				const scrollTop = messagesWrapper.scrollTop
				const dateHeaderElements = Array.from(
					document.querySelectorAll('.date-header')
				)

				let newStickyDate = null

				// –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–¥–∏–º—ã–π –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏)
				for (let i = dateHeaderElements.length - 1; i >= 0; i--) {
					const header = dateHeaderElements[i]
					const rect = header.getBoundingClientRect()
					const messagesWrapperRect = messagesWrapper.getBoundingClientRect()

					// –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
					if (
						rect.top <= messagesWrapperRect.top + 60 &&
						rect.bottom > messagesWrapperRect.top
					) {
						newStickyDate = header
						break
					}
				}

				// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
				if (!newStickyDate && dateHeaderElements.length > 0) {
					newStickyDate = dateHeaderElements[0]
				}

				// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ sticky –∫–ª–∞—Å—Å—ã
				dateHeaderElements.forEach(header => {
					header.classList.remove('sticky')
				})

				// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π sticky –∑–∞–≥–æ–ª–æ–≤–æ–∫
				if (newStickyDate && newStickyDate !== currentStickyDate) {
					newStickyDate.classList.add('sticky')
					currentStickyDate = newStickyDate
				} else if (!newStickyDate) {
					currentStickyDate = null
				}
			}

			function initDateHeadersSystem() {
				const messagesWrapper = document.getElementById('chat-messages-wrapper')
				if (!messagesWrapper) return

				// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
				messagesWrapper.addEventListener('scroll', updateStickyDateHeaders)

				// Intersection Observer –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
				dateHeadersObserver = new IntersectionObserver(
					entries => {
						entries.forEach(entry => {
							if (entry.isIntersecting) {
								// –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–∏–º—ã–º, —Å–Ω–∏–º–∞–µ–º sticky
								if (entry.target.classList.contains('sticky')) {
									entry.target.classList.remove('sticky')
								}
							}
						})
					},
					{
						root: messagesWrapper,
						threshold: 1.0,
					}
				)

				// –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –≤—Å–µ–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
				document.querySelectorAll('.date-header').forEach(header => {
					dateHeadersObserver.observe(header)
				})
			}

			// –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–Ω–æ–ø–∫–∏
			function positionPhotoMenu() {
				const rect = photoBtn.getBoundingClientRect()
				photoOptionsMenu.style.left = `${rect.left}px`
				photoOptionsMenu.style.bottom = `${
					window.innerHeight - rect.top + 10
				}px`
			}

			// –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
			window.addEventListener('resize', positionPhotoMenu)

			

			async function initializeUserKey(password) {
				try {
					const user_id = localStorage.getItem('user_id')
					if (!user_id) {
						throw new Error('User ID not found')
					}

					// –ü–æ–ª—É—á–∞–µ–º —Å–æ–ª—å —Å —Å–µ—Ä–≤–µ—Ä–∞
					const saltResponse = await eel.get_user_salt(user_id)()
					if (!saltResponse.success) {
						throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')
					}

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–ª—å –≤ localStorage
					localStorage.setItem('user_salt', saltResponse.salt)

					// –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–æ–ª—å –≤ sessionStorage
					sessionStorage.setItem('user_password', password)

					// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–ª—å
					const saltBytes = Uint8Array.from(atob(saltResponse.salt), c =>
						c.charCodeAt(0)
					)

					// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á
					userEncryptionKey = await zkCrypto.deriveKey(password, saltBytes)

					// –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª—é—á

					if (!testResult) {
						throw new Error('–ö–ª—é—á –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç')
					}

					localStorage.setItem('zk_initialized', 'true')
					console.log('ZK —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ')
					return true
				} catch (error) {
					console.error('Error initializing user key:', error)
					// –û—á–∏—â–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
					localStorage.removeItem('zk_initialized')
					localStorage.removeItem('user_salt')
					sessionStorage.removeItem('user_password')
					userEncryptionKey = null
					return false
				}
			}
		</script>
		<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
		<div class="modal-overlay hidden" id="delete-message-overlay"></div>
		<div class="delete-message-modal hidden" id="delete-message-modal">
			<button class="modal-close-btn" id="delete-message-close-btn">√ó</button>
			<div class="delete-message-text">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
			<div class="delete-message-buttons">
				<button
					class="delete-message-button delete-for-all"
					id="delete-for-all-btn"
				>
					–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö
				</button>
				<button
					class="delete-message-button delete-for-me"
					id="delete-for-me-btn"
				>
					–¢–æ–ª—å–∫–æ —É –º–µ–Ω—è
				</button>
			</div>
			<button class="delete-message-cancel" id="delete-message-cancel-btn">
				–û—Ç–º–µ–Ω–∞
			</button>
		</div>
	</body>
</html>